---
id: E04-T001
title: Sessions and messages schemas
status: done
priority: critical
labels:
  - backend
  - database
assignee: ""
workflow_state: DONE
epic: E04
depends_on: []
blocks:
  - E04-T004
  - E04-T005
breakpoint: false
assigned_agent: writer
created_at: 2026-01-12T00:00:00Z
updated_at: 2026-01-11T22:51:54.251Z
spec_file: backlog/docs/specs/E04/E04-T001-spec.md
test_files:
  - packages/db/src/__tests__/schema/chat-sessions.test.ts
  - packages/db/src/__tests__/schema/messages.test.ts
code_files:
  - packages/db/src/schema/chat-sessions.ts
  - packages/db/src/schema/messages.ts
  - packages/db/src/migrations/0008_create_chat_sessions_messages.sql
  - packages/db/src/schema/index.ts
pr_url: ""
started_at: 2026-01-11T22:30:56.724Z
---

# E04-T001: Sessions and messages schemas

## Description

Define Drizzle schemas for chat sessions (user + tool + state) and messages (conversation history with roles).

## Acceptance Criteria

- [ ] AC1: sessions table with id, tool_id, user_id, state, timestamps
- [ ] AC2: session_state enum: 'active', 'paused', 'completed'
- [ ] AC3: messages table with id, session_id, role, content, seq, created_at
- [ ] AC4: message_role enum: 'user', 'assistant', 'system'
- [ ] AC5: Foreign keys with CASCADE delete
- [ ] AC6: Index on (session_id, seq) for message ordering
- [ ] AC7: Migration file 0008_create_sessions_messages.sql
- [ ] AC8: TypeScript types exported
- [ ] AC9: Relations defined
- [ ] AC10: Tests verify constraints and ordering

## Technical Notes

```typescript
export const sessionStateEnum = pgEnum('session_state', ['active', 'paused', 'completed']);
export const messageRoleEnum = pgEnum('message_role', ['user', 'assistant', 'system']);

export const sessions = pgTable('sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  toolId: uuid('tool_id').notNull().references(() => tools.id, { onDelete: 'restrict' }),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  state: sessionStateEnum('state').notNull().default('active'),
  startedAt: timestamp('started_at', { withTimezone: true }).defaultNow().notNull(),
  endedAt: timestamp('ended_at', { withTimezone: true }),
});

export const messages = pgTable('messages', {
  id: uuid('id').primaryKey().defaultRandom(),
  sessionId: uuid('session_id').notNull().references(() => sessions.id, { onDelete: 'cascade' }),
  role: messageRoleEnum('role').notNull(),
  content: text('content').notNull(),
  seq: integer('seq').notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  meta: jsonb('meta').default('{}'),
}, (table) => ({
  sessionSeqIdx: index('messages_session_seq_idx').on(table.sessionId, table.seq),
}));
```

## Documentation Updates

**Date:** 2026-01-12
**Updated By:** writer agent

### Files Updated

1. **docs/ARCHITECTURE.md** (lines 385-458, 172-181)
   - Replaced "Sessions (Chat)" planned section with comprehensive "Chat Sessions" implemented documentation
   - Added complete "Messages" entity documentation with schema details
   - Updated System Architecture diagram to show "Chat Sessions" and "Messages" in PostgreSQL section
   - Included all key fields, indexes, constraints, relations, and metadata examples
   - Marked both entities as ✅ Implemented (E04-T001)

### Summary

The ARCHITECTURE.md canonical documentation now accurately reflects:
- Chat sessions schema with state lifecycle (`active` → `paused` → `completed`)
- Messages schema with role-based messaging and ordered sequencing
- Unique constraint on (session_id, seq) preventing message ordering bugs
- Foreign key cascade behaviors (RESTRICT for tools, CASCADE for users/sessions)
- Complete indexing strategy for query optimization
- Relations between chat_sessions, messages, tools, and users

No changes needed to CONVENTIONS.md as the implementation follows existing database conventions documented there.

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-12 | DRAFT | pm | Task created |
| 2026-01-12 | ANALYZED | analyst | Spec created: E04-T001-spec.md |
| 2026-01-12 | PLAN_REVIEW | designer | UX review completed, approved with recommendations |
| 2026-01-11 22:37 | PLAN_REVIEW → APPROVED | architect | Architecture review completed |
| 2026-01-12 07:40 | APPROVED → TESTS_READY | developer | Tests written (TDD red phase) - 2 test files created |
| 2026-01-11 22:44 | TESTS_READY → IMPLEMENTING | developer |
| 2026-01-11 22:45 | IMPLEMENTED → CODE_REVIEW | developer |
| 2026-01-12 07:45 | CODE_REVIEW → QA_REVIEW | reviewer | Code review completed: APPROVED. All critical requirements met, 44/44 tests passing |
| 2026-01-12 07:50 | QA_REVIEW → DOCS_UPDATE | qa | QA validation completed: PASSED - All acceptance criteria met, 44/44 tests passing |
| 2026-01-12 08:15 | DOCS_UPDATE → DONE | writer | Documentation updated: ARCHITECTURE.md updated with chat sessions and messages entities |


##ws

### UX Review
- **Reviewer:** designer
- **Date:** 2026-01-12
- **Verdict:** APPROVED with Recommendations
- **Notes:** Data model is solid (8.5/10). Must address: naming inconsistency with auth sessions, add seq unique constraint. Should address: remove "paused" state (YAGNI), add meta Zod schemas. See full review in spec file.

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED (Ready for QA)
- **Notes:** Excellent implementation. All critical architecture requirements met, including unique constraint on (session_id, seq). 44/44 tests passing, no TypeScript errors. Quality score: 9.5/10. See full review in backlog/docs/reviews/E04/E04-T001-code-review.md

### QA Review
- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** PASSED (Ready for Production)
- **Notes:** All 10 acceptance criteria met. 44/44 tests passing. Excellent implementation with unique constraint on message sequencing. Quality score: 9.5/10. See full report in backlog/docs/reviews/E04/E04-T001-qa-report.md
| 2026-01-12 07:50 | QA_REVIEW → DOCS_UPDATE | qa | QA validation completed: PASSED - All acceptance criteria met, 44/44 tests passing |
