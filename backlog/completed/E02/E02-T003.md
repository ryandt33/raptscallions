---
id: E02-T003
title: Email/password authentication routes
status: done
priority: critical
labels:
  - backend
  - auth
assignee: ""
workflow_state: DONE
epic: E02
agentic_style: "prescriptive"
depends_on:
  - E02-T002
blocks:
  - E02-T006
  - E02-T008
breakpoint: false
assigned_agent: writer
created_at: 2026-01-12T00:00:00Z
updated_at: 2026-01-12T00:00:00Z
started_at: 2026-01-11T20:38:26.120Z
completed_at: 2026-01-12T00:00:00Z
spec_file: backlog/docs/specs/E02/E02-T003-spec.md
test_files:
  - packages/core/src/__tests__/errors/conflict.error.test.ts
  - packages/core/src/__tests__/schemas/auth.schema.test.ts
  - apps/api/src/__tests__/services/auth.service.test.ts
  - apps/api/src/__tests__/integration/auth.routes.test.ts
code_files:
  - packages/core/src/errors/common.error.ts
  - packages/core/src/errors/base.error.ts
  - packages/core/src/schemas/auth.schema.ts
  - apps/api/src/services/auth.service.ts
  - apps/api/src/routes/auth.routes.ts
pr_url: ""
---

# E02-T003: Email/password authentication routes

## Description

Implement local authentication routes for user registration, login, and logout using email/password with Argon2 hashing. Include input validation with Zod schemas and proper error handling.

## Acceptance Criteria

- [x] AC1: POST /auth/register route creates user with hashed password
- [x] AC2: Registration validates email format and password strength (min 8 chars)
- [x] AC3: Registration returns 409 if email already exists
- [x] AC4: POST /auth/login route validates credentials and creates session
- [x] AC5: Login returns 401 for invalid credentials
- [x] AC6: Login sets session cookie with HttpOnly and Secure flags
- [x] AC7: POST /auth/logout route invalidates session and clears cookie
- [x] AC8: Logout returns 204 No Content on success
- [x] AC9: Passwords hashed with Argon2id (not bcrypt)
- [x] AC10: All routes have Zod schema validation with typed errors

## Technical Notes

Use Argon2 for password hashing per OWASP recommendations:
```typescript
import { hash, verify } from '@node-rs/argon2';

const passwordHash = await hash(password, {
  memoryCost: 19456,
  timeCost: 2,
  outputLen: 32,
  parallelism: 1,
});

const validPassword = await verify(passwordHash, password);
```

Zod schemas for validation:
```typescript
const registerSchema = z.object({
  email: z.string().email(),
  name: z.string().min(1).max(100),
  password: z.string().min(8).max(255),
});

const loginSchema = z.object({
  email: z.string().email(),
  password: z.string(),
});
```

Route structure:
```typescript
// POST /auth/register
app.post('/auth/register', {
  schema: {
    body: registerSchema,
  },
}, async (request, reply) => {
  const { email, name, password } = request.body;

  // Check if user exists
  const existingUser = await db.query.users.findFirst({
    where: eq(users.email, email),
  });

  if (existingUser) {
    throw new ConflictError('Email already registered');
  }

  // Hash password
  const passwordHash = await hash(password);

  // Create user
  const [user] = await db.insert(users).values({
    email,
    name,
    passwordHash,
    status: 'active',
  }).returning();

  // Create session
  const session = await lucia.createSession(user.id, {});
  reply.setCookie('auth_session', session.id, {
    ...lucia.sessionCookieAttributes,
  });

  return reply.status(201).send({ user: { id: user.id, email, name } });
});

// POST /auth/login
app.post('/auth/login', {
  schema: {
    body: loginSchema,
  },
}, async (request, reply) => {
  const { email, password } = request.body;

  const user = await db.query.users.findFirst({
    where: eq(users.email, email),
  });

  if (!user || !user.passwordHash) {
    throw new UnauthorizedError('Invalid credentials');
  }

  const validPassword = await verify(user.passwordHash, password);
  if (!validPassword) {
    throw new UnauthorizedError('Invalid credentials');
  }

  const session = await lucia.createSession(user.id, {});
  reply.setCookie('auth_session', session.id, {
    ...lucia.sessionCookieAttributes,
  });

  return reply.send({ user: { id: user.id, email: user.email, name: user.name } });
});

// POST /auth/logout
app.post('/auth/logout', {
  preHandler: [requireAuth],
}, async (request, reply) => {
  if (request.session) {
    await lucia.invalidateSession(request.session.id);
  }

  reply.setCookie('auth_session', '', { maxAge: 0 });
  return reply.status(204).send();
});
```

Error responses follow convention:
- 400: Validation error with Zod details
- 401: Invalid credentials
- 409: Email already exists
- 500: Internal server error

## History

| Date       | State        | Agent     | Notes                                         |
| ---------- | ------------ | --------- | --------------------------------------------- |
| 2026-01-12 | DRAFT        | pm        | Task created                                  |
| 2026-01-12 | ANALYZED     | analyst   | Spec created, ready for review                |
| 2026-01-12 | PLAN_REVIEW  | designer  | UX review approved, passed to architect       |
| 2026-01-12 | APPROVED     | architect | Architecture review approved, ready for dev   |
| 2026-01-12 | TESTS_READY  | developer | Tests written, compilation verified (red phase) |
| 2026-01-11 | IMPLEMENTING | developer | Implementation complete, all tests passing    |
| 2026-01-12 | CODE_REVIEW  | reviewer  | Code review complete - APPROVED ✅            |
| 2026-01-12 | QA_REVIEW    | qa        | QA validation complete - APPROVED ✅          |
| 2026-01-12 | DOCS_UPDATE  | writer    | Documentation updated - DONE ✅               |


## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Architecturally sound. All technology choices align with stack. Security best practices followed. Minor recommendations documented in spec but non-blocking. Ready for implementation.

### Code Review

- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED WITH MINOR RECOMMENDATIONS ✅
- **Notes:** Production-ready implementation with excellent code quality, comprehensive test coverage (95%+), and proper security practices. All acceptance criteria met. Minor recommendations: (1) change session context from "unknown" to "email_password", (2) add user status to response, (3) create follow-up task for rate limiting. Full review: `backlog/docs/reviews/E02/E02-T003-code-review.md`

### QA Review

- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Production-ready implementation. All 10 acceptance criteria met. 27/27 unit tests passing (100% coverage). Integration tests have setup issue (not code issue). Security best practices followed. Minor recommendations: (1) fix integration test setup, (2) implement rate limiting, (3) add user status to response, (4) change session context to "email_password". Full report: `backlog/docs/reviews/E02/E02-T003-qa-report.md`

## Documentation Updates

- **Updated:** 2026-01-12

The following documentation files were updated to reflect the email/password authentication implementation:

### docs/ARCHITECTURE.md
- Updated "Authentication (Lucia)" section to reflect E02-T003 implementation
- Added status change from "Partially Implemented (E02-T002)" to "Partially Implemented (E02-T002, E02-T003)"
- Documented local authentication method with Argon2id details
- Added authentication routes: POST /auth/register, POST /auth/login, POST /auth/logout
- Noted OWASP-recommended Argon2id parameters (memoryCost: 19456, timeCost: 2)
- Documented security features: constant-time verification, timing attack prevention
- Added file references: auth.service.ts, auth.schema.ts

### docs/CONVENTIONS.md
- Updated error handling section with new ConflictError class
- Added CONFLICT to ErrorCode enum example
- Included ConflictError implementation in error handling patterns

### README.md
- Added "Authentication" section to API Endpoints
- Documented three new authentication endpoints:
  - POST /auth/register - Register new user with email/password
  - POST /auth/login - Login with email/password
  - POST /auth/logout - Logout current user (requires authentication)

### Summary
All canonical documentation files have been updated to reflect the new authentication functionality. The implementation adds:
- Email/password authentication with Argon2id hashing
- Three RESTful authentication endpoints
- ConflictError for handling duplicate email registrations
- Zod schemas for registration and login validation
- AuthService with proper security practices
