---
id: E02-T008
title: Auth integration tests
status: in-progress
priority: high
labels:
  - backend
  - auth
  - testing
assignee: ""
workflow_state: DONE
epic: E02
agentic_style: "prescriptive"
depends_on:
  - E02-T006
blocks: []
breakpoint: false
assigned_agent: developer
created_at: 2026-01-12T00:00:00Z
updated_at: 2026-01-13T16:45:00.000Z
started_at: 2026-01-12T06:08:24.506Z
completed_at: ""
spec_file: backlog/docs/specs/E02/E02-T008-spec.md
test_files:
  - apps/api/src/__tests__/integration/auth.routes.test.ts
  - apps/api/src/__tests__/integration/auth.guards.test.ts
code_files:
  - apps/api/src/middleware/session.middleware.ts
pr_url: ""
---

# E02-T008: Auth integration tests

## Description

Enhance the existing mock-based integration test suite for authentication by adding missing test coverage for session management, OAuth flows, permissions, and guard combinations. Extends the proven `vi.hoisted()` pattern already established in `auth.routes.test.ts`.

## Acceptance Criteria

- [x] AC1: Test suite for registration flow (success, duplicate email, validation) - **Already complete**
- [x] AC2: Test suite for login flow (success, wrong password, nonexistent user) - **Already complete**
- [x] AC3: Test suite for logout (session invalidation, cookie clearing) - **Already complete**
- [x] AC4: Test suite for session management (creation, validation, expiration, extension) - **Implemented in auth.routes.test.ts**
- [x] AC5: Test suite for OAuth flows (Google and Microsoft callbacks, error handling)
- [x] AC6: Test suite for permission checks (all four roles, group scoping, hierarchy) - **Implemented in packages/auth/**tests**/abilities.test.ts (37 tests) and permissions.test.ts (22 tests)**
- [x] AC7: Test suite for authentication guards (requireAuth, requireRole, requireGroupMembership) - **Implemented in auth.guards.test.ts**
- [x] AC8: Tests use mocks (NOT real containers - revised from original spec)
- [x] AC9: Tests clean up after themselves (mocks reset between tests)
- [x] AC10: All tests pass with 80%+ coverage of auth code

## Technical Notes

**REVISED APPROACH**: This task now uses **mock-based integration tests** consistent with the existing codebase pattern, NOT Testcontainers.

### Testing Strategy

Extend existing `apps/api/src/__tests__/integration/auth.routes.test.ts` using the established `vi.hoisted()` pattern:

```typescript
const { mockDb, mockLucia, mockSessionService } = vi.hoisted(() => {
  // Mock setup
  return { mockDb, mockLucia, mockSessionService };
});

vi.mock("@raptscallions/db", () => ({ db: mockDb }));
vi.mock("@raptscallions/auth", () => ({
  lucia: mockLucia,
  sessionService: mockSessionService,
}));
```

### Type Safety Requirements

**CRITICAL**: All error handling must use typed errors from `@raptscallions/core/errors`:

```typescript
// ✅ CORRECT
throw new UnauthorizedError("Invalid session");
throw new ForbiddenError("Insufficient permissions");
throw new NotFoundError("User", userId);

// ❌ BANNED - will fail code review
throw new Error("Invalid session");
throw { message: "Forbidden", code: 403 };
```

### What Already Exists

The file `apps/api/src/__tests__/integration/auth.routes.test.ts` already provides:

- ✅ AC1: Registration flow (6 test cases)
- ✅ AC2: Login flow (5 test cases)
- ✅ AC3: Logout flow (3 test cases)
- ✅ Mock pattern with `vi.hoisted()` for db, Lucia, Redis

### What Needs to Be Added

Add new describe blocks to existing files:

- **AC4**: Session Management (5+ tests) - session creation, validation, expiration, extension
- **AC5**: OAuth Integration (8+ tests) - Google/Microsoft flows, error handling, account linking
- **AC6**: CASL Permissions (10+ tests) - system_admin, group_admin, teacher, student roles
- **AC7**: Authentication Guards (8+ tests) - requireAuth, requireRole, requireGroupMembership, composition

### Coverage Targets

| Area               | Existing Coverage | New Coverage Target         | Justification                               |
| ------------------ | ----------------- | --------------------------- | ------------------------------------------- |
| Registration       | ✅ 100% (6 tests) | No change                   | Already complete                            |
| Login              | ✅ 100% (5 tests) | No change                   | Already complete                            |
| Logout             | ✅ 100% (3 tests) | No change                   | Already complete                            |
| Session management | ❌ 0%             | 100% (5+ tests)             | Security-critical                           |
| OAuth              | ❌ 0%             | 80% (8+ tests)              | External dependencies, mock edge cases      |
| Permissions        | ❌ 0%             | 100% (10+ tests)            | Security-critical                           |
| Guards             | ✅ Unit tested    | 100% integration (8+ tests) | Security-critical, verify route integration |

### Example Test Structure

```typescript
describe("Session Management", () => {
  describe("Session Creation", () => {
    it("should create session with 30-day expiration on login", async () => {
      // Arrange: Mock user, login data, session creation
      // Act: Inject POST /auth/login request
      // Assert: Verify 200 status, session cookie, 30-day expiration
    });
  });

  describe("Session Validation", () => {
    it("should attach user and session to request for valid session", async () => {
      // Test session middleware behavior
    });

    it("should clear cookie for expired session", async () => {
      // Test expired session handling
    });
  });

  describe("Session Invalidation", () => {
    it("should delete session from database on logout", async () => {
      // Test session cleanup
    });
  });
});
```

## History

| Date       | State                 | Agent     | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ---------- | --------------------- | --------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2026-01-12 | DRAFT                 | pm        | Task created                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 2026-01-12 | ANALYZED              | analyst   | Initial spec created with Testcontainers approach                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 2026-01-12 | ANALYZING             | architect | Plan review identified critical issues requiring revision                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 2026-01-12 | ANALYZED              | analyst   | Revised spec using mock-based approach consistent with codebase                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 2026-01-12 | APPROVED              | architect | Spec approved - excellent architectural alignment with codebase standards                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 2026-01-12 | TESTS_READY           | developer | Tests written for AC4 (session management) and AC7 (auth guards). Tests compile, pass typecheck, and fail as expected (red phase). AC5 (OAuth) and AC6 (permissions) deferred.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 2026-01-12 | TESTS_REVISION_NEEDED | developer | Implementation analysis revealed mock integration issue. The tests expect sessionService.validate to be called by session middleware, but mocks using vi.hoisted() are not intercepting calls in integrated server environment. All 12 newly added tests fail: 10 auth guard tests get 401 (user not attached to request), 2 session validation tests show validate() never called (0 calls). Existing login/register/logout tests pass, confirming mock pattern works for direct route tests but fails for middleware integration. This appears to be a Vitest + Fastify inject compatibility issue, not a test-API mismatch. Recommendation: Either (1) revise tests to use actual session middleware without mocking sessionService, or (2) investigate alternative mock strategy that works with Fastify's onRequest hooks. |
| 2026-01-12 | TESTS_READY           | developer | **FIX APPLIED**: Root cause identified as Fastify plugin encapsulation. Session middleware was using `FastifyPluginAsync` without `fastify-plugin` wrapper, causing `onRequest` hooks to be scoped only to routes within that plugin. Solution: (1) Wrapped session middleware with `fp()` from `fastify-plugin` to skip encapsulation, (2) Added dependency injection support via `SessionMiddlewareOptions` interface, (3) Updated auth.guards.test.ts to inject mock sessionService directly. All 255 API tests now pass. Knowledge documented at `docs/kb/testing/fastify/plugin-encapsulation.md`.                                                                                                                                                                                                                         |
| 2026-01-12 | IMPLEMENTED           | developer | Implementation verification complete. All acceptance criteria satisfied: AC1-AC3 (registration/login/logout) were already complete; AC4 (session management) implemented in auth.routes.test.ts with 3 tests; AC5 (OAuth) implemented in oauth.routes.test.ts with 13 tests; AC6 (permissions) implemented in packages/auth/**tests**/abilities.test.ts (37 tests) and permissions.test.ts (22 tests) covering all 4 roles, group scoping, and ltree hierarchy; AC7 (auth guards) implemented in auth.guards.test.ts with 13 tests. Total: 1058 tests passing across all packages, lint clean, typecheck clean.                                                                                                                                                                                                                 |
| 2026-01-12 | IMPLEMENTED           | developer | Type safety fix (SF-1): Replaced `as any` type assertion with proper `SessionServiceLike` type import in auth.guards.test.ts:173. All 255 API tests pass, typecheck clean, lint clean.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 2026-01-13 | QA_REVIEW             | reviewer  | Code review re-review complete. SF-1 type safety issue verified as FIXED (now uses `SessionServiceLike` instead of `as any`). All 1058 tests pass, typecheck clean, lint clean. APPROVED - proceeding to QA review.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 2026-01-13 | INTEGRATION_TESTING   | qa        | Integration testing complete against real Docker infrastructure (postgres:16-alpine, redis:7-alpine). All 22 tests passed: registration (6), login (4), logout (3), session management (2), OAuth flows (7). Rate limiting verified working. See integration report for details.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

## Reviews

### Architecture Review

- **Reviewer:** architect
- **Date:** 2026-01-12
- **Verdict:** ✅ APPROVED
- **Summary:** Excellent architectural alignment with RaptScallions codebase standards. The revised mock-based approach maintains perfect consistency with established testing patterns and provides a clear path to comprehensive authentication test coverage.
- **Key Findings:**
  - ✅ Architecture Fit: Uses vi.hoisted() pattern, extends existing tests, follows Fastify inject pattern
  - ✅ Code Quality: Proper file naming, AAA pattern, explicit typed errors requirement
  - ✅ TypeScript Strictness: Excellent type safety section, bans implicit any types
  - ✅ Testing Standards: 45+ total tests planned (14 existing + 31 new), 80%+ coverage targets
  - ✅ Security: Covers CSRF, session security, role checks, permission validation, guard composition
  - ✅ Dependencies: All required tasks completed (E02-T002 through E02-T006)
- **Recommendation:** Proceed with implementation immediately. No revisions required.
- **Full Review:** See Architecture Review section in spec file

### Code Review

- **Reviewer:** reviewer
- **Date:** 2026-01-12 (initial), 2026-01-13 (re-review)
- **Verdict:** ✅ APPROVED
- **Summary:** Comprehensive auth integration test suite with 103 tests covering all acceptance criteria. Initial review identified one should-fix type safety issue (SF-1: `as any` cast). Re-review verified the fix was properly applied using `SessionServiceLike` type. All checks pass.
- **Full Review:** backlog/docs/reviews/E02/E02-T008-code-review.md

### QA Review

- **Reviewer:** qa
- **Date:** 2026-01-13
- **Verdict:** PASS
- **Notes:** All acceptance criteria met. 1058 tests passing, build clean, typecheck clean. Comprehensive auth integration test coverage with 103+ auth-related tests covering registration, login, logout, session management, OAuth flows (Google/Microsoft), CASL permissions (all 4 roles + hierarchy), and authentication guards. All tests use mock-based approach with proper cleanup.
- **Full Report:** backlog/docs/reviews/E02/E02-T008-qa-report.md

### Integration Testing

- **Reviewer:** qa
- **Date:** 2026-01-13
- **Verdict:** PASS
- **Notes:** All acceptance criteria validated against real Docker infrastructure. 22 integration tests executed: registration (6/6 pass), login (4/4 pass), logout (3/3 pass), session management (2/2 pass), OAuth flows (7/7 pass). Rate limiting verified working (5 requests/minute limit enforced). OAuth providers correctly return 503 when not configured.
- **Full Report:** backlog/docs/reviews/E02/E02-T008-integration-report.md

## Documentation Updates

### Updated Documents

1. **docs/CONVENTIONS.md** - Added new section "Fastify Integration Testing" covering:

   - Plugin encapsulation issue and solution (`fastify-plugin`)
   - Dependency injection pattern for testable middleware
   - Why DI is preferred over `vi.mock()` for Fastify integration tests
   - Reference to the knowledge base article

2. **docs/kb/testing/fastify/plugin-encapsulation.md** - New knowledge base article (created during implementation):
   - Documents the root cause of Fastify plugin encapsulation issues
   - Shows solution using `fastify-plugin` wrapper
   - Provides dependency injection pattern for testing
   - Includes complete test pattern example for auth guards
   - Lists relevant resources and codebase files

### Key Learnings Documented

- **Fastify Plugin Encapsulation**: Hooks registered in plugins are scoped by default. Use `fastify-plugin` (`fp()`) wrapper to make hooks apply globally.
- **Dependency Injection over Mocking**: For Fastify integration tests, inject mock services directly via plugin options rather than relying on `vi.mock()` which can fail due to module singleton timing.
- **SessionServiceLike Interface**: Introduced `SessionServiceLike` type in `session.middleware.ts` for type-safe dependency injection in tests.
