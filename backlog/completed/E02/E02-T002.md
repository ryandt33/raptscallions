---
id: E02-T002
title: Sessions table and Lucia setup
status: done
priority: critical
labels:
  - backend
  - auth
  - database
assignee: ""
workflow_state: DONE
epic: E02
agentic_style: "prescriptive"
depends_on:
  - E02-T001
blocks:
  - E02-T003
  - E02-T004
  - E02-T005
breakpoint: false
assigned_agent: writer
created_at: 2026-01-12T00:00:00Z
updated_at: 2026-01-12T00:00:00Z
started_at: 2026-01-11T20:04:00.937Z
completed_at: 2026-01-12T00:00:00Z
spec_file: backlog/docs/specs/E02/E02-T002-spec.md
test_files:
  - packages/auth/__tests__/lucia.test.ts
  - packages/auth/__tests__/session.service.test.ts
code_files:
  - packages/db/src/schema/sessions.ts
  - packages/auth/src/lucia.ts
  - packages/auth/src/types.ts
  - packages/auth/src/session.service.ts
  - packages/auth/src/index.ts
  - apps/api/src/middleware/session.middleware.ts
  - apps/api/src/middleware/auth.middleware.ts
pr_url: ""
---

# E02-T002: Sessions table and Lucia setup

## Description

Create the sessions table schema for Lucia v3, configure Lucia with Drizzle adapter, and implement session middleware for Fastify to attach user context to requests.

## Acceptance Criteria

- [ ] AC1: sessions table schema defined in packages/db/src/schema/sessions.ts
- [ ] AC2: Fields: id (string), user_id (uuid FK), expires_at (timestamp)
- [ ] AC3: Foreign key to users(id) with ON DELETE CASCADE
- [ ] AC4: Migration file 0004_create_sessions.sql generated and tested
- [ ] AC5: Lucia configured with DrizzlePostgreSQLAdapter
- [ ] AC6: Session middleware validates session cookie and attaches user to request
- [ ] AC7: Session creation helper creates session and sets cookie
- [ ] AC8: Session deletion helper invalidates session and clears cookie
- [ ] AC9: SessionUser type exported with user fields (id, email, name, role)
- [ ] AC10: Tests verify session creation, validation, and deletion

## Technical Notes

Lucia v3 sessions table per documentation:
```typescript
export const sessions = pgTable('sessions', {
  id: varchar('id', { length: 255 }).primaryKey(),
  userId: uuid('user_id')
    .notNull()
    .references(() => users.id, { onDelete: 'cascade' }),
  expiresAt: timestamp('expires_at', { withTimezone: true }).notNull(),
});
```

Lucia configuration:
```typescript
import { Lucia } from 'lucia';
import { DrizzlePostgreSQLAdapter } from '@lucia-auth/adapter-drizzle';

const adapter = new DrizzlePostgreSQLAdapter(db, sessions, users);

export const lucia = new Lucia(adapter, {
  sessionCookie: {
    attributes: {
      secure: process.env.NODE_ENV === 'production',
    },
  },
  getUserAttributes: (attributes) => {
    return {
      email: attributes.email,
      name: attributes.name,
    };
  },
});

declare module 'lucia' {
  interface Register {
    Lucia: typeof lucia;
    DatabaseUserAttributes: DatabaseUserAttributes;
  }
}

interface DatabaseUserAttributes {
  email: string;
  name: string;
}
```

Fastify session middleware:
```typescript
app.addHook('onRequest', async (request, reply) => {
  const sessionId = request.cookies.auth_session;
  if (!sessionId) {
    request.user = null;
    request.session = null;
    return;
  }

  const { session, user } = await lucia.validateSession(sessionId);
  if (session && session.fresh) {
    reply.setCookie('auth_session', session.id, {
      ...lucia.sessionCookieAttributes,
    });
  }
  if (!session) {
    reply.setCookie('auth_session', '', {
      maxAge: 0,
    });
  }

  request.user = user;
  request.session = session;
});
```

## History

| Date       | State      | Agent    | Notes                                              |
| ---------- | ---------- | -------- | -------------------------------------------------- |
| 2026-01-12 | DRAFT      | pm       | Task created                                       |
| 2026-01-12 | ANALYZED   | analyst  | Specification created at E02-T002-spec.md          |
| 2026-01-12 | UX_REVIEW  | designer | UX review completed - NEEDS_UX_CHANGES             |
| 2026-01-12 | ANALYZING  | analyst  | Returned to analyst to address UX critical issues  || 2026-01-11 20:10 | ANALYZED → UX_REVIEW | designer |
| 2026-01-11 20:12 | PLAN_REVIEW → APPROVED | architect |
| 2026-01-11 20:23 | APPROVED → WRITING_TESTS | developer |
| 2026-01-11 20:28 | TESTS_READY → IMPLEMENTING | developer |
| 2026-01-11 20:28 | IMPLEMENTED → UI_REVIEW | designer |
| 2026-01-11 20:31 | CODE_REVIEW → QA_REVIEW | reviewer |
| 2026-01-11 20:35 | QA_REVIEW → DOCS_UPDATE | qa |


## Documentation Updates

The following documentation was updated to reflect the session management implementation:

### ARCHITECTURE.md

**Location:** `docs/ARCHITECTURE.md`

**Changes:**
1. Added `packages/auth/` to monorepo structure (lines 93-99)
   - Documents the new authentication package with Lucia configuration, session service, and types

2. Added "Sessions (Authentication)" entity section (lines 259-285)
   - Comprehensive documentation of the sessions table schema
   - Key fields: `id`, `user_id`, `expires_at`, `context`, `last_activity_at`
   - Indexes for performance optimization
   - Context-aware session support for shared devices in education environments

3. Updated "Authentication (Lucia)" section (lines 354-375)
   - Documented Lucia v3 cookie-based session management implementation
   - Cookie security attributes (httpOnly, secure, SameSite)
   - Session middleware behavior and automatic extension
   - Marked status as "Partially Implemented" with E02-T002 reference

**Key Documentation Highlights:**
- Sessions support `personal`, `shared`, and `unknown` device contexts for K-12 education environments
- 30-day session expiration with automatic extension for active sessions (< 50% lifetime)
- `rapt_session` cookie name for clear identification in multi-platform environments
- Activity tracking via `last_activity_at` for idle timeout detection
- Session middleware automatically handles validation, extension, and cleanup

### Implementation Files Documented

The following implementation files are now referenced in the architecture:
- `packages/auth/src/lucia.ts` - Lucia configuration with custom user/session attributes
- `packages/auth/src/session.service.ts` - Session CRUD operations wrapper
- `packages/auth/src/types.ts` - TypeScript type definitions for sessions
- `packages/db/src/schema/sessions.ts` - Drizzle schema with context and activity tracking
- `apps/api/src/middleware/session.middleware.ts` - Fastify session validation middleware
- `apps/api/src/middleware/auth.middleware.ts` - Authentication requirement helpers

## Review

- **Reviewer:** designer
- **Date:** 2026-01-12
- **Verdict:** NEEDS_UX_CHANGES
- **Notes:** Specification is technically solid but requires UX adaptations for K-12 education context. Critical issues identified:
  1. Shared device context (computer labs, classroom carts) - needs session context field and role-based expiration
  2. Student vs teacher session differentiation - different security needs and usage patterns
  3. Session expiration UX flow - needs to be defined to prevent data loss and user confusion

  Full review appended to spec file. Analyst must address critical issues before proceeding to architecture review.

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
