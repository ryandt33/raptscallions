---
id: E02-T006
title: Authentication guards and decorators
status: DONE
priority: high
labels:
  - backend
  - auth
assignee: ""
workflow_state: DONE
epic: E02
agentic_style: "prescriptive"
depends_on:
  - E02-T003
  - E02-T005
blocks:
  - E02-T008
breakpoint: false
assigned_agent: git-agent
created_at: 2026-01-12T00:00:00Z
updated_at: 2026-01-12T06:00:00.000Z
started_at: 2026-01-12T04:45:14.693Z
completed_at: "2026-01-12T06:00:00.000Z"
spec_file: backlog/docs/specs/E02/E02-T006-spec.md
test_files:
  - apps/api/src/__tests__/middleware/auth.middleware.test.ts
code_files:
  - apps/api/src/middleware/auth.middleware.ts
pr_url: "https://github.com/ryandt33/raptscallions/pull/2"
pr_branch: feature/E02-T006-auth-guards
ux_review_notes: "UX review approved with recommendations. Analyst must address: 1) Add requireGroupFromParams decorator, 2) Add requireGroupRole decorator, 3) Add debug logging, 4) Add performance optimization guidance. See spec file UX Review section for details."
---

# E02-T006: Authentication guards and decorators

## Description

Create reusable authentication guards and Fastify decorators for common auth patterns: requireAuth (must be logged in), requireRole (must have specific role), and requireGroupMembership (must belong to group).

## Acceptance Criteria

- [x] AC1: requireAuth preHandler blocks unauthenticated requests with 401
- [x] AC2: requireRole guard accepts role parameter and blocks non-matching users
- [x] AC3: requireGroupMembership guard validates user is member of specified group
- [x] AC4: Guards short-circuit and return error before route handler executes
- [x] AC5: Fastify decorator adds `requireAuth` to app instance
- [x] AC6: Fastify decorator adds `requireRole` to app instance
- [x] AC7: Fastify decorator adds `requireGroupMembership` to app instance
- [x] AC8: Error messages include helpful context (which permission failed)
- [x] AC9: Guards compose correctly (can use multiple in preHandler array)
- [x] AC10: Tests verify all guards with various user states

## Technical Notes

RequireAuth guard:

```typescript
export async function requireAuth(
  request: FastifyRequest,
  reply: FastifyReply
): Promise<void> {
  if (!request.user || !request.session) {
    throw new UnauthorizedError("Authentication required");
  }
}
```

RequireRole guard factory:

```typescript
export function requireRole(...roles: MemberRole[]) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new UnauthorizedError("Authentication required");
    }

    // Fetch user's roles
    const memberships = await db.query.groupMembers.findMany({
      where: eq(groupMembers.userId, request.user.id),
    });

    const userRoles = memberships.map((m) => m.role);
    const hasRole = roles.some((role) => userRoles.includes(role));

    if (!hasRole) {
      throw new ForbiddenError(
        `This action requires one of the following roles: ${roles.join(", ")}`
      );
    }
  };
}
```

RequireGroupMembership guard:

```typescript
export function requireGroupMembership(groupId: string) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new UnauthorizedError("Authentication required");
    }

    const membership = await db.query.groupMembers.findFirst({
      where: and(
        eq(groupMembers.userId, request.user.id),
        eq(groupMembers.groupId, groupId)
      ),
    });

    if (!membership) {
      throw new ForbiddenError("You are not a member of this group");
    }

    // Optionally attach membership to request for downstream use
    request.groupMembership = membership;
  };
}
```

Fastify plugin to register guards:

```typescript
import fp from "fastify-plugin";

export default fp(async (app) => {
  app.decorate("requireAuth", requireAuth);
  app.decorate("requireRole", requireRole);
  app.decorate("requireGroupMembership", requireGroupMembership);
});

declare module "fastify" {
  interface FastifyInstance {
    requireAuth: typeof requireAuth;
    requireRole: typeof requireRole;
    requireGroupMembership: typeof requireGroupMembership;
  }
}
```

Usage in routes:

```typescript
// Simple auth check
app.get(
  "/me",
  {
    preHandler: [app.requireAuth],
  },
  async (request, reply) => {
    return { user: request.user };
  }
);

// Role check
app.post(
  "/admin/users",
  {
    preHandler: [
      app.requireAuth,
      app.requireRole("system_admin", "group_admin"),
    ],
  },
  async (request, reply) => {
    // Only system_admin or group_admin can create users
  }
);

// Group membership check (dynamic group from params)
app.get(
  "/groups/:id/members",
  {
    preHandler: [app.requireAuth],
  },
  async (request, reply) => {
    await app.requireGroupMembership(request.params.id)(request, reply);
    // User is a member of this group
  }
);
```

## History

| Date             | State                             | Agent     | Notes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ---------------- | --------------------------------- | --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2026-01-12       | DRAFT                             | pm        | Task created                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 2026-01-12       | ANALYZED                          | analyst   | Specification created at E02-T006-spec.md                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 2026-01-12       | UX_REVIEW                         | designer  | UX review complete - APPROVED_WITH_RECOMMENDATIONS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 2026-01-12       | PLAN_REVIEW                       | architect | Architecture review in progress                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 2026-01-12       | APPROVED                          | architect | Architecture review complete - APPROVED (pending spec updates)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 2026-01-12       | TESTS_READY                       | developer | Tests written: unit tests for all four guards (requireRole, requireGroupMembership, requireGroupFromParams, requireGroupRole) with 42 test cases covering authentication checks, role validation, error messages, parameter extraction, and guard composition. Tests pass typecheck and are ready for implementation.                                                                                                                                                                                                                                                                     |
| 2026-01-12       | IMPLEMENTED                       | developer | Implementation complete. Added four authentication guards to auth.middleware.ts: requireRole (role-based authorization), requireGroupMembership (group membership validation), requireGroupFromParams (dynamic group ID from route params), and requireGroupRole (group-scoped role checks). All 42 unit tests pass, typecheck passes with zero errors, and full test suite (871 tests) passes successfully.                                                                                                                                                                              |
| 2026-01-12       | CODE_REVIEW                       | designer  | UI review complete - NOT APPLICABLE. This is a backend authentication middleware implementation with no user-facing UI components. A Developer Experience (DX) review was conducted instead, finding the API design excellent with clear naming, strong type safety, comprehensive documentation, and proper security posture. All DX improvements from the spec review (requireGroupFromParams and requireGroupRole) were successfully implemented. See backlog/docs/reviews/E02/E02-T006-ui-review.md for full details. Ready for code review by reviewer agent.                        |
| 2026-01-12       | IMPLEMENTING                      | reviewer  | Code review complete - APPROVED_WITH_MINOR_ISSUES. Implementation is solid with excellent type safety, comprehensive tests (42 tests, 100% coverage), and proper architecture. Three minor improvements needed: 1) Add debug logging (recommended by reviews), 2) Validate empty roles array, 3) Document error type decision in requireGroupFromParams. Total effort ~15-20 minutes. See backlog/docs/reviews/E02/E02-T006-code-review.md for full details.                                                                                                                              |
| 2026-01-12       | IMPLEMENTED                       | developer | Addressed all 3 minor issues from code review: 1) Added debug logging to all four guards using @raptscallions/telemetry, 2) Added runtime validation for empty roles arrays in requireRole and requireGroupRole, 3) Added architectural comment explaining why ForbiddenError is used in requireGroupFromParams. All 42 unit tests pass, all 871 project tests pass, typecheck and lint pass.                                                                                                                                                                                             |
| 2026-01-12 05:33 | IMPLEMENTED → UI_REVIEW           | designer  |
| 2026-01-12       | CODE_REVIEW                       | reviewer  | Follow-up code review complete - APPROVED. All 3 minor issues from initial review successfully addressed: 1) Debug logging added to all 4 guards (6 locations), 2) Runtime validation for empty roles arrays implemented in requireRole and requireGroupRole, 3) Architectural comment added explaining ForbiddenError usage in requireGroupFromParams. Implementation is production-ready with 42/42 tests passing, zero TypeScript errors, and excellent code quality. Ready for QA validation. See backlog/docs/reviews/E02/E02-T006-code-review-followup.md for verification details. |
| 2026-01-12       | QA_REVIEW                         | qa        | QA validation complete - PASS. All 10 acceptance criteria met. All 871 tests passing (including 42 auth guard tests), zero TypeScript errors, build succeeds. Implementation quality excellent with comprehensive test coverage, proper error handling, debug logging, and strong security posture. Runtime validation confirms proper environment handling. Ready for integration testing with Docker infrastructure. See backlog/docs/reviews/E02/E02-T006-qa-report.md for full details.                                                                                               |
| 2026-01-12 05:46 | INTEGRATION_TESTING → DOCS_UPDATE | qa        |
| 2026-01-12       | DOCS_UPDATE                       | writer    | Documentation updated. Added comprehensive Authentication Guards section to ARCHITECTURE.md with guard table, characteristics, usage patterns, and guard vs CASL decision guidance. Ready for PR creation.                                                                                                                                                                                                                                                                                                                                                                                |
| 2026-01-12 04:25 | PR_READY → DONE                   | human     | PR merged                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |

## Documentation Updates

**Writer:** writer
**Date:** 2026-01-12

### Files Updated

| File                   | Changes                                                                 |
| ---------------------- | ----------------------------------------------------------------------- |
| `docs/ARCHITECTURE.md` | Added Authentication Guards subsection with comprehensive documentation |

### Summary

Added complete documentation for the authentication guards system (E02-T006) to the ARCHITECTURE.md file. The new section includes:

1. **Guards Table** - All 6 guards with purposes and examples
2. **Guard Characteristics** - Composability, short-circuit behavior, type safety, debugging, and security model
3. **Error Responses** - 401 vs 403 distinction
4. **Guard Patterns** - 4 common usage examples showing guard composition
5. **Guard vs CASL Permissions** - Clear guidance on when to use guards vs CASL
6. **File References** - Implementation and test file locations

The documentation explains the three-tier authorization model:

- Basic authentication (`requireAuth`, `requireActiveUser`)
- Role-based authorization (`requireRole` - global, `requireGroupRole` - scoped)
- Group membership (`requireGroupMembership` - static, `requireGroupFromParams` - dynamic)

And clarifies the relationship to CASL permissions, making it clear that guards are for simple binary checks while CASL handles complex resource-level permissions.

### Verification

- [x] All code references are accurate (auth.middleware.ts, test file)
- [x] Examples are runnable (all TypeScript examples use correct API)
- [x] Formatting is consistent with existing ARCHITECTURE.md style
- [x] Guard table matches implementation (all 6 guards documented)
- [x] Security notes explain immediate consistency (no caching)

### Additional Cleanup Identified

Found 1 completed task still in `backlog/tasks/` that should be archived:

- `backlog/tasks/E02/E02-T005.md` (workflow_state: DONE)

**Action Required:** Manual archiving needed - move to `backlog/completed/E02/E02-T005.md`

##

### Plan Review

- **Reviewer:** architect
- **Date:** 2026-01-12
- **Verdict:** APPROVED
- **Notes:** Architecturally sound design. MUST implement: 1) requireGroupRole guard (fixes authorization gap), 2) requireGroupFromParams helper (improves ergonomics). SHOULD add: debug logging, performance guidance. See backlog/docs/specs/E02/E02-T006-architect-review.md for full review.

### UI Review

- **Reviewer:** designer
- **Date:** 2026-01-12
- **Verdict:** NOT APPLICABLE
- **Notes:** Backend authentication middleware with no user-facing UI components. DX review conducted instead - API design is excellent with strong type safety, comprehensive documentation, and proper security posture. See backlog/docs/reviews/E02/E02-T006-ui-review.md for full details.

### Code Review

- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED
- **Notes:**
  - **Initial Review:** APPROVED_WITH_MINOR_ISSUES - Three minor improvements recommended (debug logging, runtime validation, architectural comment). See backlog/docs/reviews/E02/E02-T006-code-review.md
  - **Follow-up Review:** APPROVED - All 3 issues successfully addressed. Implementation is production-ready with comprehensive debug logging (6 locations), runtime validation for edge cases, and architectural documentation. 42/42 tests passing, zero TypeScript errors, excellent code quality. See backlog/docs/reviews/E02/E02-T006-code-review-followup.md

### QA Review

- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** PASS
- **Notes:** All 10 acceptance criteria met. All 871 tests passing (including 42 auth guard tests), zero TypeScript errors, build succeeds. Implementation quality excellent with comprehensive test coverage, proper error handling, debug logging, and strong security posture. Runtime validation confirms proper environment handling. Ready for integration testing. See backlog/docs/reviews/E02/E02-T006-qa-report.md

## Pull Request

**Branch:** `feature/E02-T006-auth-guards`
**Status:** Ready for review (awaiting manual PR creation)
**Create PR:** https://github.com/ryandt33/raptscallions/pull/new/feature/E02-T006-auth-guards

### PR Details

**Title:** `feat(auth): implement authentication guards and decorators [E02-T006]`

**Summary:** Implements reusable authentication guards and Fastify decorators for common authorization patterns. Adds four guards: `requireRole`, `requireGroupMembership`, `requireGroupFromParams`, and `requireGroupRole`.

**Changes:**

- Added `requireRole` guard for checking user roles across all groups
- Added `requireGroupMembership` guard for static group membership validation
- Added `requireGroupFromParams` guard for dynamic group IDs from route parameters
- Added `requireGroupRole` guard for validating roles within specific group context
- Implemented comprehensive unit tests (42 test cases with 100% coverage)
- Added debug logging to all guards for troubleshooting auth failures
- Added runtime validation for edge cases (empty roles arrays)
- Updated `ARCHITECTURE.md` with authentication guards documentation

**CI Status:**

- ✅ Type checking passed (zero errors)
- ✅ Linting passed (zero warnings)
- ✅ Tests passed (871/871 tests passing)
- ✅ Pre-commit hooks passed

**Reviews:**

- ✅ UX Review: APPROVED_WITH_RECOMMENDATIONS (all implemented)
- ✅ Architecture Review: APPROVED
- ✅ Code Review: APPROVED
- ✅ QA Review: PASS
