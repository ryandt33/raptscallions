---
id: "E01-T012"
title: "Add CI Workflow for Migration Testing"
status: "in progress"
priority: "high"
labels: [infrastructure, database, ci-cd, critical]
assignee: ""
epic: "E01"
agentic_style: "prescriptive"
depends_on: ["E01-T009"]
blocks: []
created_at: "2026-01-14T20:00:00Z"
updated_at: "2026-01-15T14:30:00Z"
workflow_state: "PR_READY"
code_files:
  - .github/workflows/ci.yml
---

# E01-T012: Add CI Workflow for Migration Testing

## Description

Integrate database migration application and validation into the CI pipeline to ensure migrations are tested against a real PostgreSQL database before code reaches production. Currently, tests run without applying migrations first, which can miss migration-related failures.

## Why This Matters

**Production Safety:** CI must verify that migrations actually work before allowing merge to main. This prevents catastrophic production failures where migrations fail during deployment, causing downtime or data corruption.

**Early Detection:** Catching migration issues in CI is exponentially cheaper than discovering them in staging or production. A 5-minute CI failure saves hours of debugging and incident response.

**Team Confidence:** Developers can trust that if CI passes, their migrations will work in production. This reduces anxiety around database changes and enables faster iteration.

## Acceptance Criteria

- [ ] AC1: GitHub Actions workflow applies migrations to PostgreSQL before running tests
- [ ] AC2: PostgreSQL service configured with ltree extension enabled
- [ ] AC3: Migrations run against clean database (fresh PostgreSQL instance per workflow run)
- [ ] AC4: Test suite runs against migrated database (not push-based schema)
- [ ] AC5: Workflow fails if migration application fails
- [ ] AC6: Workflow verifies migration tracking table exists (`__drizzle_migrations`)
- [ ] AC7: Workflow runs on pull requests and main branch pushes
- [ ] AC8: Migration failures show actionable error messages in CI logs
- [ ] AC9: Workflow completes in reasonable time (<5 minutes for DB setup + migrations)
- [ ] AC10: Use `env` block for PGPASSWORD (not inline variable) per architecture review

## Constraints

- **GitHub Actions environment:** Must use GitHub Actions (not other CI systems)
- **PostgreSQL version:** Must match production version (PostgreSQL 16)
- **Extension requirements:** Must enable ltree extension before migrations
- **Test database isolation:** Each workflow run must have isolated database (no shared state)
- **Cost efficiency:** Should cache dependencies (pnpm, Docker layers) to minimize CI time
- **Failure clarity:** Migration errors must be visible and debuggable from CI logs

## Out of Scope

- Integration with external CI systems (CircleCI, Jenkins, etc.) - GitHub Actions only
- Migration rollback testing (future enhancement)
- Performance testing of migrations (separate concern)
- Seed data or fixtures (tests should create their own data)
- Deployment automation (this is test-only, not deployment)
- Notification systems (Slack, email) - use GitHub's built-in notifications

## Context

**Related Work:**
- E01-T009 created migration scripts (`migrate.ts`) that CI will invoke
- E01-T008 configured Vitest which CI will run after migrations
- Code review for E01-T009 identified CI integration as AC4 (implementation pending)

**Technical Context:**
- Workflow file location: `.github/workflows/ci.yml` (create if doesn't exist)
- PostgreSQL service: Use `postgres:16-alpine` Docker image
- Extension setup: Run `CREATE EXTENSION IF NOT EXISTS ltree;` before migrations
- Migration command: `pnpm --filter @raptscallions/db db:migrate`
- Test command: `pnpm test` (runs all packages)

**GitHub Actions Pattern:**
```yaml
services:
  postgres:
    image: postgres:16-alpine
    env:
      POSTGRES_USER: raptscallions
      POSTGRES_PASSWORD: raptscallions
      POSTGRES_DB: raptscallions_test
    options: >-
      --health-cmd pg_isready
      --health-interval 10s
      --health-timeout 5s
      --health-retries 5
```

**Success Indicators:**
- Pull requests blocked when migrations fail
- Clear error messages pointing to failing migration file
- Fast feedback loop (developers notified within 5-10 minutes)
- Zero false positives (reliable CI, doesn't fail randomly)

**Pattern Reference:**
See E01-T009 spec (lines 407-451) for CI workflow design guidance.

## Architecture Review Recommendation

**Status:** ✅ APPROVED (2026-01-15)

The implementation spec is ready for development. Key points for the implementer:

1. **Implementation approach:** Add 3 new steps to both `test` and `test-coverage` jobs in `.github/workflows/ci.yml` - no new jobs needed
2. **Step order:** Enable ltree extension → Run migrations → Verify tracking table → Run tests
3. **Minor optimization:** Use only the `env` block for PGPASSWORD (not both inline and env variable)
4. **Verification:** The existing 15-min job timeout is sufficient; migrations should complete in <30 seconds

See full spec at: `backlog/docs/specs/E01/E01-T012-spec.md`

## Documentation Updates

**KB Documentation:**

- Updated: `apps/docs/src/database/patterns/migration-validation.md`
  - Added new "CI Migration Testing" section with workflow examples
  - Added comparison table of static vs CI migration validation
  - Added PostgreSQL service configuration details
  - Added `packages/db/scripts/migrate.ts` and `.github/workflows/ci.yml` to `related_code`
  - Added backlog references in Related Pages section:
    - E01-T009: Migration scripts and validation
    - E01-T012: CI workflow for migration testing
  - `last_verified` already current (2026-01-15)
- Updated: `apps/docs/src/contributing/ci-validation.md`
  - Updated `last_verified` to 2026-01-15 (CI workflow file changed)

**Legacy Documentation:**

- No updates needed (KB provides detailed documentation; legacy docs maintain high-level overview)

**Verification:**

- ✅ Build check passed (no broken links)
- ✅ Staleness check passed (0 stale docs)
- ✅ All KB pages include backlog references
