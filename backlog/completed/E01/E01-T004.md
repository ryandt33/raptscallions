---
id: E01-T004
title: Create users schema
status: done
priority: high
labels:
  - backend
  - database
  - auth
assignee: ""
workflow_state: DONE
epic: E01
agentic_style: "prescriptive"
depends_on:
  - E01-T003
blocks:
  - E01-T005
  - E01-T006
breakpoint: false
assigned_agent: writer
created_at: 2025-01-11T00:00:00Z
updated_at: 2026-01-12T00:00:00Z
started_at: 2026-01-11T16:25:22.125Z
completed_at: 2026-01-12T00:00:00Z
spec_file: backlog/docs/specs/E01/E01-T004-spec.md
test_files:
  - packages/db/src/__tests__/schema/users.test.ts
code_files:
  - packages/db/src/schema/users.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/0001_create_users.sql
  - packages/db/drizzle.config.ts
pr_url: ""
---

# E01-T004: Create users schema

## Description

Define the Drizzle ORM schema for the users table. This is the foundational table for authentication and will be referenced by groups, sessions, and other entities.

## Acceptance Criteria

- [ ] AC1: users table defined in src/schema/users.ts
- [ ] AC2: Fields: id (UUID), email, name, password_hash, status, created_at, updated_at, deleted_at
- [ ] AC3: id uses uuid().primaryKey().defaultRandom()
- [ ] AC4: email is varchar(255), unique, not null
- [ ] AC5: name is varchar(100), not null
- [ ] AC6: password_hash is varchar(255), nullable (for OAuth-only users)
- [ ] AC7: status enum: active, suspended, pending_verification
- [ ] AC8: Timestamps use timestamp with timezone, with defaults
- [ ] AC9: deleted_at for soft delete support (nullable)
- [ ] AC10: Index on email for fast lookups
- [ ] AC11: Exports User and NewUser types
- [ ] AC12: Migration file 0001_create_users.sql generated

## Technical Notes

Per CONVENTIONS.md and database.md rules:
- Use snake_case for table and column names
- Index naming: users_email_idx
- Export inferred types:
```typescript
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
```

Status enum should be defined as pgEnum:
```typescript
export const userStatusEnum = pgEnum('user_status', ['active', 'suspended', 'pending_verification']);
```

## History

| Date       | State        | Agent     | Notes                    |
| ---------- | ------------ | --------- | ------------------------ |
| 2025-01-11 | DRAFT        | pm        | Task created             |
| 2026-01-12 | ANALYZED     | analyst   | Implementation spec created at backlog/docs/specs/E01/E01-T004-spec.md |
| 2026-01-12 | TESTS_READY  | developer | Comprehensive test suite created (TDD red phase - tests fail as expected) |
| 2026-01-12 | IMPLEMENTED  | developer | Implementation complete - users schema, types, and migration created. All 55 tests passing. Updated drizzle-orm to 0.45.1 and drizzle-kit to 0.31.8 for compatibility. |
| 2026-01-12 | CODE_REVIEW  | designer  | UI review N/A - no UI components in this backend task. Moving directly to code review. |
| 2026-01-12 | QA_REVIEW    | reviewer  | Code review APPROVED - Excellent implementation with all 55 tests passing. See backlog/docs/reviews/E01/E01-T004-code-review.md for details. Medium-priority recommendations: add down migration, consider email normalization strategy. |
| 2026-01-12 | DOCS_UPDATE  | qa        | QA review APPROVED - All 12 acceptance criteria met, 55/55 tests passing, production-ready. See backlog/docs/reviews/E01/E01-T004-qa-report.md for full validation report. Non-blocking recommendations for future tasks documented. |
| 2026-01-12 | DONE         | writer    | Documentation updated - Added users schema to db README.md with comprehensive usage examples (auth patterns, status enum, soft delete), updated ARCHITECTURE.md Core Entities section with implementation status. Task complete. |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED WITH MINOR RECOMMENDATIONS
- **Notes:** Excellent implementation with all 55 tests passing and zero TypeScript errors. All 12 acceptance criteria met. Schema design follows best practices with proper type safety, indexing, and soft delete pattern. Medium-priority recommendations: (1) add down migration file, (2) consider email case normalization strategy for E01-T005. See full review at backlog/docs/reviews/E01/E01-T004-code-review.md. Ready for QA review.

### QA Review

- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** APPROVED - READY FOR DOCS_UPDATE
- **Notes:** All 12 acceptance criteria met with 100% compliance. 55/55 tests passing, zero TypeScript errors. Production-ready implementation with comprehensive test coverage. Non-blocking recommendations: (1) add down migration file before E01-T006, (2) document email case normalization strategy in E01-T005, (3) consider updated_at trigger for automatic timestamp updates. See full QA report at backlog/docs/reviews/E01/E01-T004-qa-report.md. Moving to DOCS_UPDATE workflow state.

## Documentation Updates

**Date:** 2026-01-12
**Updated by:** writer

### Files Updated

1. **`packages/db/README.md`**
   - Added users table schema structure to file tree
   - Added comprehensive "Users Table" section with usage examples
   - Updated type inference examples to include users schema with enum, status, and soft delete
   - Documented authentication patterns (email/password vs OAuth)
   - Documented user status enum values and meanings
   - Documented soft delete pattern with query examples
   - Added migration file reference (0001_create_users.sql)

2. **`docs/ARCHITECTURE.md`**
   - Updated "Core Entities" section with Users entity details
   - Marked Users as "âœ… Implemented (E01-T004)"
   - Added schema location, migration reference, and key fields documentation
   - Added status indicators (âœ… Implemented, ðŸš§ Planned) to all core entities for clarity
   - Documented authentication methods (Argon2 password hashing, OAuth support)
   - Documented soft delete support with deleted_at timestamp

### Documentation Coverage

- âœ… Users table structure and schema definition
- âœ… User status enum values and their meanings
- âœ… Authentication patterns (email/password vs OAuth)
- âœ… Soft delete behavior and query patterns
- âœ… Nullable password_hash rationale
- âœ… Type inference with User and NewUser types
- âœ… Migration tracking (0001_create_users.sql)
- âœ… Usage examples for common operations

### Notes

All documentation follows the project conventions:
- Clear examples showing both authentication patterns
- Emphasis on soft delete pattern (critical for proper querying)
- Type-safe usage examples with imported types
- References to actual implementation files for developers
