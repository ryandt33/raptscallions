---
id: E01-T005
title: Create groups schema with ltree
status: done
priority: high
labels:
  - backend
  - database
assignee: ""
workflow_state: DONE
epic: E01
agentic_style: "prescriptive"
depends_on:
  - E01-T003
  - E01-T004
blocks:
  - E01-T006
breakpoint: false
assigned_agent: qa
created_at: 2025-01-11T00:00:00Z
updated_at: 2026-01-12T02:13:00.000Z
started_at: 2026-01-11T16:53:40.194Z
completed_at: 2026-01-12T02:13:00.000Z
spec_file: backlog/docs/specs/E01/E01-T005-spec.md
test_files:
  - packages/db/src/__tests__/schema/groups.test.ts
code_files:
  - packages/db/src/schema/groups.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/0002_create_groups.sql
  - packages/db/drizzle.config.ts
pr_url: ""
---

# E01-T005: Create groups schema with ltree

## Description

Define the Drizzle ORM schema for the groups table using PostgreSQL's ltree extension for hierarchical data. Groups represent Districts, Schools, and Departments in a tree structure.

## Acceptance Criteria

- [x] AC1: groups table defined in src/schema/groups.ts
- [x] AC2: Fields: id (UUID), name, slug, type, path (ltree), settings (JSONB), created_at, updated_at, deleted_at
- [x] AC3: type enum: district, school, department
- [x] AC4: path uses custom ltree type for hierarchy (e.g., "district1.school2.dept3")
- [x] AC5: slug is unique, url-friendly identifier
- [x] AC6: settings is JSONB for group-specific configuration
- [x] AC7: GiST index on path for ltree operations
- [x] AC8: Unique index on slug
- [x] AC9: Exports Group and NewGroup types
- [x] AC10: Migration file 0002_create_groups.sql generated
- [x] AC11: Migration enables ltree extension: CREATE EXTENSION IF NOT EXISTS ltree

## Technical Notes

ltree enables hierarchical queries like:
- Find all children: `path <@ 'district1.school2'`
- Find all ancestors: `path @> 'district1.school2.dept3'`
- Find depth: `nlevel(path)`

Custom ltree type definition (from E01-T003):
```typescript
export const ltree = customType<{ data: string }>({
  dataType() {
    return 'ltree';
  },
});
```

Group type enum:
```typescript
export const groupTypeEnum = pgEnum('group_type', ['district', 'school', 'department']);
```

Settings JSONB can store:
- Theme configuration
- Enabled AI models
- Feature flags
- Default quotas

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2025-01-11 | DRAFT | pm | Task created |
| 2026-01-12 | ANALYZED | analyst | Implementation spec created at backlog/docs/specs/E01/E01-T005-spec.md |
| 2026-01-12 | PLAN_REVIEW | designer | UX review completed - APPROVED with recommendations for E01-T009 (settings validation) |
| 2026-01-12 | APPROVED | architect | Plan approved for implementation |
| 2026-01-12 | TESTS_READY | developer | Tests written in packages/db/src/__tests__/schema/groups.test.ts - ready for implementation (red phase) |
| 2026-01-12 | IMPLEMENTED | developer | Implementation completed - all tests pass (44/44), TypeScript build successful, migration file created |
| 2026-01-11 17:08 | IMPLEMENTED → UI_REVIEW | designer | UX review completed |
| 2026-01-12 | CODE_REVIEW | reviewer | Code review completed - APPROVED with minor recommendations, workflow state → QA_REVIEW |
| 2026-01-12 | QA_REVIEW | qa | QA validation completed - APPROVED. All 11 acceptance criteria met with 100% test coverage (44/44 tests passing). Production-ready. workflow state → DONE |


##eviews

### UX Review

- **Reviewer:** designer
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Excellent DX foundation with strong type safety, URL-friendly slugs, and settings inheritance. Medium priority concern: need Zod schema for settings validation (address in E01-T009). Low priority: document slug collision strategy before API implementation. See full review in spec file.

### Plan Review

- **Reviewer:** architect
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Plan reviewed and approved for implementation

### Code Review

- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Production-ready implementation with excellent type safety, comprehensive test coverage (44/44 tests pass), and proper adherence to conventions. All 11 acceptance criteria met. Minor recommendations for future consideration (none blocking). See full review in backlog/docs/reviews/E01/E01-T005-code-review.md

### QA Review

- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Production-ready implementation. All 11 acceptance criteria met with 100% test coverage (44/44 tests passing). Excellent type safety (zero `any` types), proper TypeScript build, correct migration file with ltree extension. No blocking issues. Minor observations are intentional design choices deferred to application layer (settings validation in E01-T009, slug collision handling in API layer). See full QA report in backlog/docs/reviews/E01/E01-T005-qa-report.md
