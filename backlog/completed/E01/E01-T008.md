---
id: E01-T008
title: Configure Vitest for monorepo
status: done
priority: high
labels:
  - infrastructure
  - testing
assignee: ""
workflow_state: DONE
epic: E01
agentic_style: "prescriptive"
depends_on:
  - E01-T001
blocks: []
breakpoint: false
assigned_agent: writer
created_at: 2025-01-11T00:00:00Z
updated_at: 2026-01-12T00:00:00Z
started_at: 2026-01-11T17:48:27.813Z
completed_at: 2026-01-12T00:00:00Z
spec_file: backlog/docs/specs/E01/E01-T008-spec.md
test_files:
  - __tests__/vitest-config.test.ts
  - __tests__/path-resolution.test.ts
  - __tests__/existing-tests.test.ts
code_files:
  - vitest.config.ts
  - vitest.workspace.ts
  - package.json
  - packages/core/vitest.config.ts
  - packages/db/vitest.config.ts
  - packages/modules/vitest.config.ts
  - packages/telemetry/vitest.config.ts
pr_url: ""
---

# E01-T008: Configure Vitest for monorepo

## Description

Set up Vitest as the test runner across the monorepo with shared configuration, coverage reporting, and workspace support.

## Acceptance Criteria

- [x] AC1: vitest and @vitest/coverage-v8 installed in root
- [x] AC2: vitest.config.ts at root with workspace configuration
- [x] AC3: Each package can have its own vitest.config.ts extending root
- [x] AC4: Test files pattern: **/*.test.ts, **/__tests__/**/*.ts
- [x] AC5: Coverage configured with v8 provider
- [x] AC6: Coverage thresholds: 80% lines minimum
- [x] AC7: Root scripts: test, test:coverage, test:watch
- [x] AC8: Tests can import from workspace packages
- [x] AC9: TypeScript paths resolved correctly in tests
- [x] AC10: Sample test in packages/core passes

## Technical Notes

Root vitest.config.ts example:
```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    include: ['packages/**/*.test.ts', 'apps/**/*.test.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: ['**/node_modules/**', '**/dist/**'],
      thresholds: {
        lines: 80,
        functions: 80,
        branches: 80,
        statements: 80,
      },
    },
  },
  resolve: {
    alias: {
      '@raptscallions/core': '/packages/core/src',
      '@raptscallions/db': '/packages/db/src',
    },
  },
});
```

Per testing.md rules:
- Use AAA pattern (Arrange/Act/Assert)
- Test files go in `__tests__/` directories or alongside source
- Use vi.mock() for mocking
- Use test factories for mock data

## Implementation Notes

### Test Files Created (TDD Red Phase)

Created three comprehensive test files that verify the Vitest configuration:

#### 1. `__tests__/vitest-config.test.ts` - Configuration Structure Tests
Tests that verify:
- Root configuration files exist (vitest.config.ts, vitest.workspace.ts)
- Root dependencies installed (vitest, @vitest/coverage-v8, @vitest/ui)
- Root scripts configured (test, test:coverage, test:watch, test:ui)
- Package configurations exist and extend root
- Workspace configuration includes all packages
- Coverage provider, thresholds, and reporters configured correctly
- Path aliases configured for all packages

#### 2. `__tests__/path-resolution.test.ts` - Import Resolution Tests
Tests that verify:
- Cross-package imports work with @raptscallions/* aliases
- Type information maintained across package boundaries
- Module resolution consistency (singleton behavior)
- Test environment path variables work correctly

#### 3. `__tests__/existing-tests.test.ts` - Existing Tests Compatibility
Tests that verify:
- Existing test files in packages/core and packages/db are discoverable
- AAA pattern demonstrations work correctly
- Global test functions available (describe, it, expect, test)
- Existing error classes can be imported and used

### Test Status: RED Phase ✓

All tests are currently FAILING because:
- Root vitest.config.ts doesn't exist yet
- Root vitest.workspace.ts doesn't exist yet
- Vitest not installed at root level (command not found)
- Package configs don't extend root config yet
- Root scripts not configured yet

This is the expected "RED" phase of TDD - tests fail due to missing implementation, NOT due to incorrect test logic or type errors.

### Coverage of Acceptance Criteria

The tests verify ALL acceptance criteria:
- **AC1**: Root dependencies (tests check package.json devDependencies)
- **AC2**: Root vitest.config.ts (tests check file exists and content)
- **AC3**: Package configs extend root (tests check mergeConfig usage)
- **AC4**: Test patterns (tests check include patterns in config)
- **AC5**: v8 coverage provider (tests check provider setting)
- **AC6**: 80% thresholds (tests check all four threshold values)
- **AC7**: Root scripts (tests check all four scripts exist)
- **AC8**: Workspace package imports (tests use dynamic imports)
- **AC9**: TypeScript paths (tests verify type safety across packages)
- **AC10**: Sample tests pass (tests verify existing test files work)

### Ready for Implementation

Status: **TESTS_READY**

The tests are comprehensive, follow AAA pattern, and use real Vitest/Node.js APIs. Ready for `/implement` command to create the configuration files and make tests pass (GREEN phase).

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2025-01-11 | DRAFT | pm | Task created |
| 2026-01-12 | ANALYZED | analyst | Implementation spec created at backlog/docs/specs/E01/E01-T008-spec.md |
| 2026-01-12 | PLAN_REVIEW | designer | UX review completed - APPROVED, ready for architect review |
| 2026-01-12 | APPROVED | architect | Architecture review completed - APPROVED |
| 2026-01-12 | TESTS_READY | developer | Tests written - RED phase complete, ready for implementation |
| 2026-01-11 18:04 | TESTS_READY → IMPLEMENTING | developer |
| 2026-01-11 18:04 | IMPLEMENTED → UI_REVIEW | designer |
| 2026-01-12 | CODE_REVIEW → QA_REVIEW | reviewer | Code review completed - APPROVED |
| 2026-01-12 | QA_REVIEW → DOCS_UPDATE | qa | QA validation completed - APPROVED, all acceptance criteria met |
| 2026-01-12 | DOCS_UPDATE → DONE | writer | Documentation updated: ARCHITECTURE.md, README.md, CONVENTIONS.md |


##ws

### Plan Review

- **Reviewer:** architect
- **Date:** 2026-01-12
- **Verdict:** APPROVED
- **Notes:** See spec file for full architecture review

### Code Review

- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** Comprehensive review completed. All acceptance criteria met. 234 tests passing. Zero blocking issues. Review available at backlog/docs/reviews/E01/E01-T008-code-review.md

### QA Review

- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** APPROVED ✅
- **Notes:** All 10 acceptance criteria validated and passing. 234 tests pass with 99.71% line coverage (exceeds 80% threshold). Configuration follows conventions. Zero critical/major issues. Full report at backlog/docs/reviews/E01/E01-T008-qa-report.md

## Documentation Updates

The following documentation was updated to reflect the Vitest monorepo configuration:

### 1. ARCHITECTURE.md

**Updated:** Technology Stack table
- Added **Testing** row: `Vitest | 1.1+ | Monorepo test runner`
- Positioned after Telemetry, before Frontend for logical grouping

**Rationale:** Vitest is a core infrastructure component and should be documented in the canonical technology stack.

### 2. README.md

**Updated:** Available Scripts section and added Testing section

**Changes:**
- Expanded test scripts in table with descriptions for all four test commands
- Added comprehensive "Testing" section covering:
  - Running tests (all commands with examples)
  - Coverage reports (HTML, console, JSON locations)
  - Coverage thresholds (80% minimum)
  - Test structure (AAA pattern example)
  - Cross-reference to CONVENTIONS.md

**Rationale:** README is the first place developers look for testing instructions. Comprehensive guide improves onboarding and reduces friction.

### 3. CONVENTIONS.md

**Updated:** Testing section with Vitest Configuration subsection

**Changes:**
- Added "Vitest Configuration" subsection after "Coverage Requirements"
- Documented three-tier configuration strategy (Root → Workspace → Package)
- Explained purpose of each configuration level
- Provided quick reference for running tests
- Added checklist for adding new packages to ensure proper test setup

**Rationale:** CONVENTIONS.md is the canonical reference for code patterns. Developers adding packages need clear guidance on test configuration requirements.

### Files Modified

- `docs/ARCHITECTURE.md` - Added Vitest to technology stack (line 40)
- `README.md` - Enhanced testing documentation (lines 87-148)
- `docs/CONVENTIONS.md` - Added Vitest configuration guide (lines 506-545)

### Impact

These documentation updates ensure that:
1. New developers can quickly understand the testing setup
2. The testing infrastructure is properly documented in canonical references
3. Future package additions follow the correct configuration pattern
4. Coverage requirements and test patterns are clearly communicated
