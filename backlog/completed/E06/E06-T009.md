---
id: "E06-T009"
title: "Document testing patterns and conventions"
status: "done"
priority: "high"
task_type: "backend"
labels:
  - docs
  - testing
assignee: ""

workflow_state: "DONE"
epic: "E06"
depends_on: ["E06-T002"]
blocks: []
breakpoint: false
assigned_agent: ""

created_at: "2026-01-13"
updated_at: "2026-01-14"
started_at: "2026-01-14"
completed_at: "2026-01-14"

spec_file: ""
test_files: []
code_files:
  - apps/docs/src/testing/index.md
  - apps/docs/src/testing/concepts/vitest-setup.md
  - apps/docs/src/testing/concepts/test-structure.md
  - apps/docs/src/testing/concepts/index.md
  - apps/docs/src/testing/patterns/index.md
  - apps/docs/src/testing/patterns/mocking.md
  - apps/docs/src/testing/patterns/factories.md
  - apps/docs/src/testing/patterns/fastify-testing.md
  - apps/docs/src/testing/patterns/fastify-plugin-encapsulation.md
  - apps/docs/src/testing/patterns/integration-tests.md
  - apps/docs/src/testing/troubleshooting/index.md
  - apps/docs/src/testing/troubleshooting/common-issues.md
  - apps/docs/src/.vitepress/config.ts
pr_url: ""
---

# E06-T009: Document testing patterns and conventions

## Description

Create comprehensive KB documentation for the testing infrastructure and patterns by examining the actual implemented code from E01-T008 (Vitest setup) and E02-T008 (auth integration tests). This populates the testing domain that was created in E06-T002 but never filled with content, and integrates existing content from docs/kb/testing/.

## Why This Matters

Testing is fundamental to code quality and confidence. Accurate documentation helps developers and agents understand how to write effective tests, use the Vitest infrastructure, follow AAA patterns, create mocks and factories, and handle Fastify-specific testing challenges. Documentation must reflect what's actually implemented and the lessons learned from real test development.

## Acceptance Criteria

- [x] AC1: testing/index.md provides domain overview and navigation
- [x] AC2: testing/concepts/vitest-setup.md documents monorepo Vitest configuration
- [x] AC3: testing/concepts/test-structure.md documents AAA pattern with examples
- [x] AC4: testing/patterns/mocking.md documents mock patterns and vi.hoisted()
- [x] AC5: testing/patterns/factories.md documents test data factory patterns
- [x] AC6: testing/patterns/fastify-testing.md integrates existing Fastify plugin encapsulation docs
- [x] AC7: testing/patterns/integration-tests.md documents integration test patterns
- [x] AC8: testing/troubleshooting/common-issues.md documents common test failures
- [x] AC9: All docs have frontmatter with related_code pointing to actual files
- [x] AC10: All docs reference implementing tasks (E01-T008, E02-T008, E03-T003, E04-T003)

## Constraints

- Document only what is implemented (check completed tasks and test files)
- Integrate existing content from docs/kb/testing/fastify/
- Use code snippets from real test files, not invented examples
- Frontmatter must include last_verified date
- Document lessons learned from actual implementation challenges

## Out of Scope

- End-to-end tests (not implemented)
- Visual regression tests (not implemented)
- Performance testing (not implemented)
- Test coverage enforcement CI (not implemented)
- Frontend component testing (not implemented)

## Context

### Source Material

**Completed Tasks:**

- E01-T008: Configure Vitest for monorepo
- E02-T008: Auth integration tests
- E03-T003: Assignments and submissions schemas (has tests)
- E04-T003: Usage tracking schema and service (has tests)

**Key Source Files:**

- `vitest.config.ts` - Root Vitest configuration
- `vitest.workspace.ts` - Workspace configuration
- `packages/core/vitest.config.ts` - Package-level config
- `packages/db/vitest.config.ts` - Package-level config
- `apps/api/src/__tests__/integration/auth.routes.test.ts` - Integration test example
- `apps/api/src/__tests__/integration/auth.guards.test.ts` - Guard test example
- `packages/auth/src/__tests__/abilities.test.ts` - Unit test example
- `apps/api/src/__tests__/config.test.ts` - Configuration test example
- `apps/api/src/__tests__/middleware/error-handler.test.ts` - Middleware test example

**Existing Knowledge Base:**

- `docs/kb/testing/fastify/README.md` - Overview of Fastify testing
- `docs/kb/testing/fastify/plugin-encapsulation.md` - Plugin encapsulation issue and solution

**Specs and Reviews:**

- `backlog/docs/specs/E01/E01-T008-spec.md` - Vitest setup implementation
- `backlog/docs/specs/E02/E02-T008-spec.md` - Auth integration tests implementation
- `backlog/docs/reviews/E01/E01-T008-code-review.md` - Code review findings
- `backlog/docs/reviews/E02/E02-T008-code-review.md` - Code review findings

### Documentation Structure

```
apps/docs/src/testing/
├── index.md                      # Overview, philosophy, quick links
├── concepts/
│   ├── vitest-setup.md           # Monorepo configuration, workspace pattern
│   ├── test-structure.md         # AAA pattern, describe/it blocks
│   └── coverage.md               # Coverage configuration, thresholds
├── patterns/
│   ├── mocking.md                # vi.mock(), vi.hoisted(), spies
│   ├── factories.md              # Test data factories, createMockUser
│   ├── fastify-testing.md        # Integrate plugin-encapsulation.md content
│   ├── integration-tests.md      # Fastify inject pattern, full flow tests
│   └── unit-tests.md             # Pure function tests, service tests
├── decisions/
│   └── 001-vitest-over-jest.md   # ADR for test framework choice
└── troubleshooting/
    ├── common-issues.md          # Common failures and solutions
    └── plugin-encapsulation.md   # Migrate from docs/kb/testing/fastify/
```

### Key Patterns to Document

**1. AAA Pattern (from E02-T008):**

```typescript
describe("UserService", () => {
  describe("getById", () => {
    it("should return user when found", async () => {
      // Arrange
      const expectedUser = createMockUser({ id: "123" });
      mockDb.query.users.findFirst.mockResolvedValue(expectedUser);

      // Act
      const result = await service.getById("123");

      // Assert
      expect(result).toEqual(expectedUser);
      expect(mockDb.query.users.findFirst).toHaveBeenCalledWith({
        where: expect.any(Object),
      });
    });
  });
});
```

**2. Mock Pattern with vi.hoisted() (from E02-T008):**

```typescript
const { mockDb, mockLucia, mockSessionService } = vi.hoisted(() => {
  // Mock setup
  return { mockDb, mockLucia, mockSessionService };
});

vi.mock("@raptscallions/db", () => ({ db: mockDb }));
vi.mock("@raptscallions/auth", () => ({
  lucia: mockLucia,
  sessionService: mockSessionService,
}));
```

**3. Factory Pattern (from E02-T008):**

```typescript
function createMockUser(overrides: Partial<User> = {}): User {
  return {
    id: "user-123",
    email: "test@example.com",
    name: "Test User",
    createdAt: new Date(),
    ...overrides,
  };
}
```

**4. Fastify Integration Test (from E02-T001):**

```typescript
beforeAll(async () => {
  const fastify = await import("fastify");
  app = fastify.default({ logger: false });

  // Register plugins...

  await app.ready();
});

it("should return 200 OK for health check", async () => {
  const response = await app.inject({
    method: "GET",
    url: "/health",
  });

  expect(response.statusCode).toBe(200);
  expect(response.json()).toEqual({
    status: "ok",
    timestamp: expect.any(String),
  });
});
```

**5. Dependency Injection for Testing (from E02-T008 docs/kb):**

```typescript
// Middleware with DI support
interface SessionMiddlewareOptions {
  sessionService?: SessionServiceLike;
}

export const sessionMiddleware = fp<SessionMiddlewareOptions>(
  async (fastify, opts) => {
    const service = opts.sessionService || sessionService;
    // Use service...
  }
);

// Test with mock service
await app.register(sessionMiddleware, {
  sessionService: mockSessionService,
});
```

### Vitest Configuration Hierarchy (from E01-T008)

Document the three-tier configuration:

1. **Root** (`vitest.config.ts`) - Base configuration, coverage thresholds
2. **Workspace** (`vitest.workspace.ts`) - Package discovery
3. **Package** (`packages/*/vitest.config.ts`) - Package-specific overrides

### Lessons Learned to Document

From E02-T008 implementation:

- Fastify plugin encapsulation causes hooks to not apply globally
- Solution: Use `fastify-plugin` (`fp()`) wrapper
- Dependency injection preferred over `vi.mock()` for Fastify tests
- `SessionServiceLike` interface pattern for type-safe DI

From E01-T008 reviews:

- 80% coverage threshold for all metrics (lines, functions, branches, statements)
- Tests can be co-located (`*.test.ts`) or in `__tests__/` directories
- Use `vi.clearAllMocks()` in `beforeEach` for clean test state

### Integration with Existing Content

The existing files in `docs/kb/testing/fastify/` should be:

1. Migrated to `apps/docs/src/testing/troubleshooting/plugin-encapsulation.md`
2. Referenced from `testing/patterns/fastify-testing.md`
3. Updated with frontmatter and related_code links

### Example Doc Structure

```markdown
---
title: Vitest Monorepo Setup
related_code:
  - vitest.config.ts
  - vitest.workspace.ts
  - packages/core/vitest.config.ts
implements_task: E01-T008
last_verified: 2026-01-13
---

# Vitest Monorepo Setup

## Overview

RaptScallions uses a three-tier Vitest configuration to support testing across
the monorepo while allowing package-specific customization.

## Configuration Hierarchy

### Root Configuration

[Explain root vitest.config.ts purpose and structure]

### Workspace Configuration

[Explain vitest.workspace.ts purpose]

### Package Configuration

[Explain package-level configs]

## Running Tests

[Document test commands from package.json]

## References

**Implements:** [E01-T008](../../../backlog/completed/E01/E01-T008.md)

**Key Files:**

- [vitest.config.ts](../../../vitest.config.ts)
- [vitest.workspace.ts](../../../vitest.workspace.ts)

**Related Docs:**

- [Coverage Configuration](./coverage.md)
- [Test Structure](./test-structure.md)
```

## Technical Notes

This task is about documentation, not implementation. The testing infrastructure and patterns already exist in the codebase. The goal is to capture what's been built and the lessons learned so that future developers and agents can understand and follow the established patterns.

## Documentation Written

### Files Created

| File | Purpose |
|------|---------|
| `testing/index.md` | Domain overview with quick reference, common gotchas, and navigation |
| `testing/concepts/index.md` | Concepts section landing page |
| `testing/concepts/vitest-setup.md` | Three-tier Vitest configuration (root, workspace, package) |
| `testing/concepts/test-structure.md` | AAA pattern, describe blocks, naming conventions |
| `testing/patterns/index.md` | Patterns section with quick decision guide |
| `testing/patterns/mocking.md` | vi.mock(), vi.hoisted(), dependency injection |
| `testing/patterns/factories.md` | Test factory patterns with real examples |
| `testing/patterns/fastify-testing.md` | app.inject() API, test server setup |
| `testing/patterns/fastify-plugin-encapsulation.md` | Plugin encapsulation problem and solution |
| `testing/patterns/integration-tests.md` | Full integration test examples |
| `testing/troubleshooting/index.md` | Troubleshooting section landing page |
| `testing/troubleshooting/common-issues.md` | Solutions for frequent test failures |

### VitePress Sidebar Updated

Added complete navigation structure with:
- Concepts section (Vitest Monorepo Setup, Test Structure)
- Patterns section (Mocking, Test Factories, Fastify Testing, Plugin Encapsulation, Integration Tests)
- Troubleshooting section (Common Issues)

### Key Features

- All files include proper frontmatter with `related_code`, `last_verified`
- Code examples extracted from actual test files (auth.routes.test.ts, auth.guards.test.ts, abilities.test.ts, etc.)
- Cross-references between related documentation
- Task references (E01-T008, E02-T008, etc.) included
- Design system compliance (containers, proper markdown formatting)

## History

| Date       | State      | Agent    | Notes                                              |
| ---------- | ---------- | -------- | -------------------------------------------------- |
| 2026-01-13 | DRAFT      | pm       | Task created                                       |
| 2026-01-14 | DOC_REVIEW | writer   | Documentation written, 11 files created, sidebar updated |
| 2026-01-14 | DONE       | reviewer | Documentation review passed, all ACs met           |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Doc Review

- **Reviewer:** reviewer
- **Date:** 2026-01-14
- **Verdict:** APPROVED
- **Notes:** All 10 acceptance criteria met. Code examples verified against actual implementation. Documentation is comprehensive, well-organized, and follows KB page design patterns.
- **Review File:** [E06-T009-doc-review.md](../../docs/reviews/E06/E06-T009-doc-review.md)

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
