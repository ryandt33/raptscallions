---
id: "E06-T003-BUG"
title: "Fix failing tests in E06-T003 staleness tracking"
status: "in_progress"
workflow_state: "IMPLEMENTED"
priority: "high"
epic: "E06"
agentic_style: "prescriptive"
depends_on: []
blocks: ["E06-T004"]
labels: ["bug", "testing"]
code_files:
  - apps/docs/scripts/lib/git-helper.ts
  - apps/docs/scripts/lib/frontmatter-parser.ts
  - apps/docs/scripts/__tests__/lib/git-helper.test.ts
  - apps/docs/scripts/__tests__/check-staleness.test.ts
---

# Fix Failing Tests in E06-T003 Staleness Tracking

## Bug Report

### Summary

The E06-T003 (Documentation Staleness Tracking System) implementation has **11 failing tests** that were never detected because `apps/docs` was not included in `vitest.workspace.ts`. When E06-T004 added `apps/docs` to the workspace to run CI integration tests, these pre-existing failures were exposed.

### Discovery

- **Discovered during:** E06-T004 implementation
- **Discovered by:** Adding `apps/docs` to `vitest.workspace.ts`
- **Original commit:** `6525beb feat(docs): implement documentation staleness tracking system`
- **Commit claimed:** "120 comprehensive unit tests (all passing)"
- **Actual state:** Tests were never run because apps/docs wasn't in workspace

### Failing Tests (11 total)

#### 1. git-helper.test.ts (9 failures)

| Test | Error |
|------|-------|
| `isGitAvailable > should return true when git is available` | Mock not applied - `execFileAsync` not being mocked correctly |
| `getGitRepoRoot > should return repo root when in git repository` | Mock not applied |
| `getFileLastModified > should return date when file has git history` | Mock not applied |
| `getFileLastModified > should use commit date by default` | Expected call count: 0 |
| `getFileLastModified > should use author date when requested` | Expected call count: 0 |
| `batchGetFileLastModified > should query multiple files` | Expected call count: 0 |
| `batchGetFileLastModified > should handle mixed success and failure` | Expected call count: 0 |
| `batchGetFileLastModified > should batch requests with concurrency limit` | Expected call count: 0 |
| `batchGetFileLastModified > should use author date when requested` | Expected call count: 0 |

**Root cause:** The `vi.mock()` for `child_process` isn't being applied correctly. The tests mock `execFileAsync` but the real function is being called instead.

#### 2. frontmatter-parser.test.ts (1 failure)

| Test | Error |
|------|-------|
| `parseDocFrontmatter > should return null for invalid ISO date` | Expected `null`, received object with parsed data |

**Root cause:** The implementation doesn't reject invalid ISO date formats in `last_verified` - it accepts them instead of returning null.

#### 3. check-staleness.test.ts (1 failure)

| Test | Error |
|------|-------|
| `CLI arguments > should accept custom config file path` | Test assertion failing |

**Root cause:** Need to investigate the specific test expectations vs implementation behavior.

### Files Affected

```
apps/docs/scripts/__tests__/lib/git-helper.test.ts
apps/docs/scripts/__tests__/lib/frontmatter-parser.test.ts
apps/docs/scripts/__tests__/check-staleness.test.ts
apps/docs/scripts/lib/git-helper.ts
apps/docs/scripts/lib/frontmatter-parser.ts
apps/docs/scripts/check-staleness.ts
```

### Reproduction Steps

```bash
# After adding apps/docs to vitest.workspace.ts:
pnpm test

# Or run specific test files:
pnpm test apps/docs/scripts/__tests__/lib/git-helper.test.ts
pnpm test apps/docs/scripts/__tests__/lib/frontmatter-parser.test.ts
pnpm test apps/docs/scripts/__tests__/check-staleness.test.ts
```

### Impact

- **E06-T004** is blocked from full completion until these are fixed
- **CI pipeline** will fail on these tests once `apps/docs` is in the workspace
- The staleness tracking feature may have undiscovered bugs due to tests not running

### Recommended Fix Approach

1. **git-helper.ts mocking issue:**
   - Review how `execFileAsync` is imported and exported
   - Ensure `vi.mock('child_process')` is correctly hoisting
   - May need to use `vi.spyOn` instead or adjust module structure

2. **frontmatter-parser.ts date validation:**
   - Add ISO date format validation for `last_verified` field
   - Return `null` when date is not a valid ISO format (e.g., "not-a-date")

3. **check-staleness.ts CLI:**
   - Review the custom config file path test expectations
   - Verify argument parsing handles the flag correctly

### Acceptance Criteria

- [x] All 9 git-helper.test.ts tests pass
- [x] frontmatter-parser.test.ts invalid date test passes
- [x] check-staleness.test.ts config file path test passes
- [x] `pnpm test` passes with apps/docs in vitest.workspace.ts

## History

| Date | Event | Actor |
|------|-------|-------|
| 2026-01-14 | Bug discovered during E06-T004 implementation - tests were never being run | Developer Agent |
| 2026-01-14 | All 11 tests fixed and passing (200 total tests in apps/docs now pass) | Developer Agent |

## Implementation Notes

### Fix 1: git-helper.ts mocking issue (9 tests)

**Problem:** The original implementation used `promisify(execFile)` at module load time, which meant the mock wasn't applied because the function was captured before mocking.

**Solution:** Refactored to use an internal helper function `execFilePromise` exposed via `_internal` object that can be mocked with `vi.spyOn`:

```typescript
// Export for testing - allows mocking this function
export const _internal = {
  execFilePromise,
};

// Functions use _internal.execFilePromise() instead of direct promisify
export async function isGitAvailable(): Promise<boolean> {
  try {
    await _internal.execFilePromise('git', ['--version']);
    return true;
  } catch {
    return false;
  }
}
```

Test now uses:
```typescript
vi.spyOn(_internal, 'execFilePromise').mockImplementation(mockExecFilePromise);
```

### Fix 2: frontmatter-parser.ts date validation (1 test)

**Problem:** gray-matter's default YAML parsing auto-converts date strings like `2026-13-45` to JavaScript Date objects, which then get "rolled" to valid dates (e.g., February 14, 2027) through JavaScript's date rolling behavior.

**Solution:** Use `js-yaml`'s `JSON_SCHEMA` which doesn't include timestamp parsing, keeping dates as raw strings for validation:

```typescript
const matterOptions = {
  engines: {
    yaml: {
      parse: (str: string) => yaml.load(str, { schema: yaml.JSON_SCHEMA }),
      stringify: yaml.dump,
    },
  },
};
```

This allows the `isValidISODate()` function to properly validate and reject invalid dates.

### Fix 3: check-staleness.test.ts CLI test (1 test)

**Problem:** Test called `loadConfig('custom-config.yml')` with one argument but asserted `expect.anything()` for a second argument.

**Solution:** Updated test to pass empty object as second argument:
```typescript
await loadConfig('custom-config.yml', {});
```
