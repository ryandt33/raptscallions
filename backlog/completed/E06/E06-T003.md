---
id: "E06-T003"
title: "Staleness tracking schema and detection logic"
workflow_state: "DONE"
priority: "high"
epic: "E06"
depends_on: []
blocks: ["E06-T004"]
spec_file: "backlog/docs/specs/E06/E06-T003-spec.md"
code_review_file: "backlog/docs/reviews/E06/E06-T003-code-review.md"
qa_report_file: "backlog/docs/reviews/E06/E06-T003-qa-report.md"
integration_report_file: "backlog/docs/reviews/E06/E06-T003-integration-report.md"
test_files:
  - apps/docs/scripts/__tests__/lib/types.test.ts
  - apps/docs/scripts/__tests__/lib/git-helper.test.ts
  - apps/docs/scripts/__tests__/lib/frontmatter-parser.test.ts
  - apps/docs/scripts/__tests__/lib/config-loader.test.ts
  - apps/docs/scripts/__tests__/lib/staleness-checker.test.ts
  - apps/docs/scripts/__tests__/lib/report-generator.test.ts
  - apps/docs/scripts/__tests__/check-staleness.test.ts
code_files:
  - apps/docs/scripts/lib/types.ts
  - apps/docs/scripts/lib/git-helper.ts
  - apps/docs/scripts/lib/frontmatter-parser.ts
  - apps/docs/scripts/lib/config-loader.ts
  - apps/docs/scripts/lib/staleness-checker.ts
  - apps/docs/scripts/lib/report-generator.ts
  - apps/docs/scripts/check-staleness.ts
  - package.json
updated_at: "2026-01-14T00:00:00Z"
---

# Staleness Tracking Schema and Detection Logic

## Description

Implement a system to detect when documentation may be out of sync with code changes. Documents declare their related code files, and the system compares modification dates to flag potentially stale content.

## Why This Matters

Documentation drift is a common problem - code changes but docs don't update. Automated detection catches staleness early, preventing developers from following outdated guidance. This is especially important for agents relying on KB content for implementation decisions.

## Acceptance Criteria

- [x] AC1: Frontmatter schema defined for doc-code relationships
- [x] AC2: Docs can declare related code paths in frontmatter
- [x] AC3: Script scans all docs in apps/docs/src/ and extracts relationships
- [x] AC4: Script compares doc verification date with code file last-modified
- [x] AC5: Report generated listing potentially stale docs
- [x] AC6: Configurable threshold for staleness (e.g., code changed 7+ days after doc)
- [x] AC7: Ignore patterns supported (e.g., stable reference docs)
- [x] AC8: JSON/markdown output format for integration with CI
- [x] AC9: `pnpm docs:check-stale` command available

## Constraints

- Must work in CI environment (no interactive prompts)
- Should complete quickly (under 30 seconds for typical doc count)
- Git history access required for accurate modification dates
- Should not block builds (warning-level, not error)

## Out of Scope

- Automatic doc updates
- Integration with PR comments
- Slack/email notifications
- Determining what specifically changed (just flags staleness)

## Context

### Frontmatter Schema

```yaml
---
title: Session Lifecycle
related_code:
  - packages/auth/src/session.service.ts
  - apps/api/src/middleware/session.middleware.ts
implements_task: E02-T002
last_verified: 2026-01-12
---
```

### Detection Logic

```
For each doc with related_code:
  1. Get doc's last_verified date
  2. For each related code file:
     a. Get file's last commit date
     b. If commit date > last_verified + threshold:
        - Flag doc as potentially stale
  3. Generate report
```

### Output Format

```json
{
  "stale": [
    {
      "doc": "apps/docs/src/auth/concepts/session-lifecycle.md",
      "last_verified": "2026-01-10",
      "related_changes": [
        {
          "file": "packages/auth/src/session.service.ts",
          "changed": "2026-01-12",
          "commit": "abc123"
        }
      ]
    }
  ],
  "fresh": 42,
  "unchecked": 5
}
```

Unchecked = docs without `related_code` frontmatter (can't verify)

## Documentation Updates

**Writer:** writer
**Date:** 2026-01-14

### Files Updated

| File                                           | Changes                                                                                                                           |
| ---------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| `apps/docs/src/contributing/kb-page-design.md` | Added "Staleness Tracking (Optional)" section documenting `related_code` and `last_verified` frontmatter fields                   |
| `README.md`                                    | Added `pnpm docs:check-stale` to Available Scripts table and added "Checking Documentation Staleness" section with usage examples |
| `docs/CONVENTIONS.md`                          | Updated "Adding Documentation" workflow example to include optional staleness tracking fields with link to detailed documentation |

### Files Created

None. All documentation already existed.

### Summary

Added comprehensive documentation for the staleness tracking system across three key documents:

**KB Page Design Patterns (`kb-page-design.md`):**

- **Field definitions:** `related_code` (array of code file paths/glob patterns) and `last_verified` (ISO 8601 date)
- **Example usage:** Complete YAML frontmatter example showing both fields in use
- **Glob pattern support:** Documented single file, wildcard, and deep match patterns
- **Validation rules:** Data type requirements, format constraints, and path conventions
- **Purpose explanation:** How fields integrate with `pnpm docs:check-stale` command
- **Usage guidance:** Tip container explaining when to use staleness tracking (implementation docs vs conceptual docs)

**Root README (`README.md`):**

- **Available Scripts table:** Added `pnpm docs:check-stale` command entry
- **Usage examples:** Added "Checking Documentation Staleness" section with command examples (basic check, custom threshold, JSON output)
- **Cross-reference:** Link to KB Page Design Patterns for frontmatter field documentation

**Conventions Guide (`docs/CONVENTIONS.md`):**

- **Workflow integration:** Updated "Adding Documentation" example frontmatter to include optional `related_code` and `last_verified` fields
- **Guidance note:** Added explanation of when to use staleness tracking with link to detailed documentation
- **By-example learning:** Developers following the conventions will now see staleness tracking as part of the standard workflow

This documentation satisfies AC1's requirement that the schema be documented in the KB page design guide, enabling developers to use the staleness detection system effectively. The documentation is discoverable at three levels: README (quick-start), CONVENTIONS (workflow integration), and kb-page-design.md (detailed reference).

### Verification

- [x] All code references are accurate (`related_code` and `last_verified` match implementation in `frontmatter-parser.ts`)
- [x] Examples are runnable (YAML frontmatter is syntactically correct)
- [x] Links work (references to `pnpm docs:check-stale` command)
- [x] Formatting is consistent (follows existing kb-page-design.md conventions)

## QA Issues to Fix

### BUG-001: Frontmatter schema not documented in kb-page-design.md

**Severity:** Critical (Blocks PASS)

**Location:** `apps/docs/src/contributing/kb-page-design.md`

**Issue:** The `related_code` and `last_verified` frontmatter fields are not documented in kb-page-design.md, even though the spec explicitly requires this (spec line 1224, 96).

**Impact:**

- Developers don't know these fields exist
- No guidance on proper usage
- Feature cannot be adopted without documentation
- Violates AC1 completion criteria

**Fix required:**
Add section to `apps/docs/src/contributing/kb-page-design.md` in the "Frontmatter and Title" section (after line 50) documenting the staleness tracking fields:

````markdown
**Staleness Tracking (Optional):**

- `related_code: string[]` — Array of code file paths or glob patterns (relative to repo root) that this doc describes
- `last_verified: string` — ISO 8601 date (YYYY-MM-DD) when this doc was last verified against the related code

**Example with staleness tracking:**

```yaml
---
title: Session Lifecycle
description: How Lucia sessions are created, validated, and expired
related_code:
  - packages/auth/src/session.service.ts
  - apps/api/src/middleware/session.middleware.ts
  - packages/auth/**/*.ts
last_verified: 2026-01-12
---
```
````

These fields enable automated staleness detection via `pnpm docs:check-stale`. The system compares `last_verified` dates with code file modification dates to flag potentially outdated documentation.

**Validation rules:**

- `related_code` must be an array of strings (file paths or glob patterns)
- `last_verified` must be valid ISO 8601 date in YYYY-MM-DD format
- Both fields are optional
- If either is missing, the doc is counted as "unchecked" (staleness cannot be determined)

```

## History

| Date | Event | Actor |
|------|-------|-------|
| 2026-01-13 | Task analyzed - spec created at backlog/docs/specs/E06/E06-T003-spec.md | Analyst Agent |
| 2026-01-13 | Tests written - 7 test files created with comprehensive coverage | Developer Agent |
| 2026-01-13 | Implementation completed - All source files created, 108/120 tests passing, typecheck and lint pass | Developer Agent |
| 2026-01-13 | Test issues fixed - All 120 tests now passing (1058/1058 total suite) | Developer Agent |
| 2026-01-13 | Code review completed - ✅ APPROVED with 2 should-fix items and 3 suggestions. All 9 ACs met, 120/120 tests pass, zero TS/lint errors. Production-ready. | Code Reviewer Agent |
| 2026-01-13 | Code review fixes applied - Fixed CLI --output flag implementation and markdown directory creation. All 1058 tests pass, typecheck and lint clean. | Developer Agent |
| 2026-01-13 | QA review completed - ❌ FAILED. AC1 incomplete: frontmatter schema not documented in kb-page-design.md (spec requirement). All other ACs pass. Tests: 1058/1058. Fix required: Add documentation section. | QA Agent |
| 2026-01-14 | Documentation updated - Added staleness tracking frontmatter fields documentation to kb-page-design.md. AC1 now complete. Ready for PR. | Tech Writer Agent |
| 2026-01-14 | Integration tests passed - All 9 ACs verified working in real environment. CLI functional, reports generated correctly, documentation complete. 1058/1058 tests pass, typecheck clean. Production-ready. | Integration Tester |
```
