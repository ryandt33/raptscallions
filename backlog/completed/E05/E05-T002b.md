---
id: "E05-T002b"
title: "Storage configuration system with validation"
status: "in-progress"
priority: "critical"
labels: [backend, infrastructure, configuration]
assignee: ""
workflow_state: "COMMITTED"
epic: "E05"
agentic_style: "prescriptive"
depends_on: ["E05-T002a"]
blocks: ["E05-T003", "E05-T004", "E05-T005"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-15T00:00:00Z"
updated_at: "2026-01-16T12:00:00Z"
spec_file: "backlog/docs/specs/E05/E05-T002b-spec.md"
test_files: ["packages/storage/src/__tests__/config.test.ts", "packages/storage/src/__tests__/config-registry.test.ts"]
code_files: ["packages/storage/src/config.ts", "packages/storage/src/config-registry.ts", "packages/storage/src/index.ts"]
pr_url: ""
---

# E05-T002b: Storage configuration system with validation

## Description

Create a Zod-based configuration system for the storage package that validates environment variables, enforces backend-specific requirements, and provides lazy initialization matching existing patterns (e.g., `packages/ai/config.ts`).

## Why This Matters

Storage backends require different configuration (S3 needs bucket/keys, Azure needs account/container, local needs filesystem path). The system must validate that the selected backend has all required configuration before instantiation, provide clear error messages for missing config, and defer parsing until first use (for faster startup and easier testing).

## Acceptance Criteria

- [ ] AC1: Configuration schema validates common settings (backend identifier, max file size, storage quota, signed URL expiration)
- [ ] AC2: Configuration schema validates backend-specific settings (S3 bucket/keys, Azure account, GCS project, local path, etc.)
- [ ] AC3: Configuration validates that selected backend has all required settings present
- [ ] AC4: Missing or invalid configuration produces clear error messages identifying what's missing
- [ ] AC5: Configuration is lazy-loaded (not parsed until first access)
- [ ] AC6: Tests can reset configuration state between test cases
- [ ] AC7: Configuration supports extensibility (new backends can define their config requirements)
- [ ] AC8: Default values are provided for common settings (10MB file size, 1GB quota, 15min signed URL expiration)
- [ ] AC9: Environment variables are the primary configuration source
- [ ] AC10: Configuration is read-only after initialization (immutable)

## Constraints

- Must use Zod for validation (matches project conventions)
- Lazy initialization using Proxy pattern (matches `packages/ai/config.ts`)
- Backend-specific validation should support backends registered via E05-T002a plugin system
- Configuration validation must occur before backend instantiation (fail fast)
- Zero configuration required for local filesystem backend (sensible defaults)

## Out of Scope

- Actual backend implementations (E05-T003, E05-T004, E05-T005)
- Runtime configuration updates (config is immutable after load)
- Configuration UI or admin interface
- Secrets management (uses plain env vars, secrets handling is deployment concern)
- Configuration persistence to database

## Context

### Existing Pattern

The `packages/ai/config.ts` uses lazy Proxy-based loading:
```typescript
export const aiConfig = new Proxy({} as AiConfig, {
  get(_target, prop: keyof AiConfig) {
    const config = loadConfig();
    return config[prop];
  },
});
```

This pattern should be replicated for storage config.

### Backend-Specific Validation

Different backends need different config:
- **Local**: Just filesystem path (default: `./storage/uploads`)
- **S3-compatible**: Endpoint (optional), region, bucket, access key ID, secret key
- **Azure Blob**: Account name, access key, container name
- **GCS**: Project ID, bucket, key file path (or ADC)
- **Aliyun OSS**: Region, bucket, access key ID, secret

Validation should ensure required fields are present when that backend is selected.

### Integration with Plugin System

Configuration should work with E05-T002a's plugin registry:
- Plugins can optionally provide config schema
- Config system validates against registered backend's requirements
- Unknown backends fail validation unless they provide config schema

## Reviews

| Type | Verdict | Date | Link |
| ---- | ------- | ---- | ---- |
| Architecture Review | APPROVED | 2026-01-16 | [E05-T002b-spec.md](../../docs/specs/E05/E05-T002b-spec.md#architecture-review) |
| Code Review | APPROVED | 2026-01-16 | [E05-T002b-code-review.md](../../docs/reviews/E05/E05-T002b-code-review.md) |
| Integration Test | PASS | 2026-01-16 | [E05-T002b-integration-report.md](../../docs/reviews/E05/E05-T002b-integration-report.md) |

## Documentation Updates

**KB Documentation (Restructured):**

Created new `storage/` domain (moved from `api/concepts/storage-backends.md`):

- Created: `apps/docs/src/storage/index.md` — Domain overview with quick start example
- Created: `apps/docs/src/storage/concepts/index.md` — Concepts index page
- Created: `apps/docs/src/storage/concepts/backend-interface.md` — IStorageBackend contract, plugin registry, factory, errors (from E05-T002a)
- Created: `apps/docs/src/storage/concepts/configuration.md` — Lazy config loading, env vars, config registry (from E05-T002b)
- Created: `apps/docs/src/storage/patterns/index.md` — Patterns index page
- Created: `apps/docs/src/storage/patterns/custom-backends.md` — How to implement custom backends
- Created: `apps/docs/src/storage/troubleshooting/index.md` — Placeholder for future troubleshooting guides
- Updated: `apps/docs/src/.vitepress/config.ts` — Added Storage section to sidebar
- Deleted: `apps/docs/src/api/concepts/storage-backends.md` — Moved to storage/ domain

**Legacy Documentation:**

- Updated: `docs/ARCHITECTURE.md`
  - Added `config.ts` and `config-registry.ts` to storage package file tree
- Updated: `docs/CONVENTIONS.md`
  - Added Storage environment variables section with KB cross-reference

**Verification:**

- ✅ Build check passed (no broken links)
- ✅ All KB pages include backlog references
- ✅ Staleness check not available (script not implemented yet)

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-16 | DOCS_UPDATE | qa | Integration tests PASS; all 10 acceptance criteria validated in real Node.js runtime; lazy loading, reset, immutability, extensibility, error messages all verified |
| 2026-01-16 | QA_REVIEW | reviewer | Code review APPROVED; all 10 acceptance criteria satisfied; 76 config tests pass; implementation matches AI package pattern; ready for QA |
| 2026-01-16 | IMPLEMENTED | developer | Implemented config-registry.ts (Map-based schema registry with register, get, has, list, reset functions) and config.ts (lazy Proxy-based config loading with Zod validation, built-in schemas for local/s3/azure/gcs/aliyun backends); all 174 tests pass; lint and typecheck pass |
| 2026-01-16 | TESTS_READY | developer | Wrote 56 tests covering config-registry (20 tests) and config (36 tests); all tests fail with "Not implemented" (TDD red phase); added stub files and ConfigurationError class |
| 2026-01-16 | APPROVED | architect | Architecture review passed; spec follows established patterns from packages/ai/config.ts |
| 2026-01-16 | ANALYZED | analyst | Created implementation spec with Proxy-based lazy config, config registry for extensibility, and built-in backend schemas |
| 2026-01-15 | REPLANNED | pm | Split from E05-T002, focused on config validation without prescribing implementation |
| 2026-01-13 | DRAFT | pm | Original task created for Epic E05 |
