---
id: "E05-T001"
title: "Files and storage limits schemas"
status: "in_progress"
priority: "critical"
labels: [backend, database, schema]
assignee: ""
workflow_state: "COMMITTED"
epic: "E05"
depends_on: []
blocks: ["E05-T005", "E05-T006"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-13T00:00:00Z"
updated_at: "2026-01-15T18:45:00Z"
spec_file: "backlog/docs/specs/E05/E05-T001-spec.md"
test_files:
  - packages/db/src/__tests__/schema/files.test.ts
  - packages/db/src/__tests__/schema/user-storage-limits.test.ts
  - packages/core/src/__tests__/schemas/storage.schema.test.ts
code_files:
  - packages/db/src/schema/files.ts
  - packages/db/src/schema/user-storage-limits.ts
  - packages/db/src/migrations/0012_create_files_storage.sql
  - packages/core/src/schemas/storage.schema.ts
pr_url: ""
---

# E05-T001: Files and storage limits schemas

## Description

Define database schemas for file storage infrastructure: a `files` table to track uploaded files and a `user_storage_limits` table for per-user quota overrides. This provides the foundational data layer for file management without dependencies on E03 entities.

## Why This Matters

Before files can be uploaded, downloaded, or managed, the system needs a way to track file metadata (name, size, location) and enforce storage quotas. This schema enables the three-tier limit system (system -> role -> user) that controls how much each user can store.

## Acceptance Criteria

### Files Table
- [x] AC1: Files table stores core metadata: name, MIME type, size in bytes, storage location key
- [x] AC2: Files track which storage backend they're stored in (s3, local, etc.)
- [x] AC3: Files track which user uploaded them (required) and optionally which group they belong to
- [x] AC4: Files have a `purpose` field to categorize usage without requiring FK dependencies
- [x] AC5: Files support soft delete with status tracking (active, soft_deleted)
- [x] AC6: Storage key is unique across all files
- [x] AC7: Proper indexes for common query patterns (by user, by group, by purpose, by status)
- [x] AC8: Standard timestamps (created_at, updated_at with trigger, deleted_at for soft delete)

### User Storage Limits Table
- [x] AC9: Tracks per-user storage limit overrides (max file size, total quota)
- [x] AC10: Limit fields are nullable - NULL means inherit from role/system default
- [x] AC11: Tracks current usage (used_bytes) for quota enforcement
- [x] AC12: Includes audit trail: who set the override (set_by) and why (reason)
- [x] AC13: One record per user (unique constraint on user_id)
- [x] AC14: Proper foreign key relationships to users table

### Group Settings Extension
- [x] AC15: Document the structure for role-based limits in groups.settings JSONB
- [x] AC16: Zod schema validates storage limits configuration structure

### Migration & Types
- [x] AC17: Migration creates both tables with proper constraints and indexes
- [x] AC18: TypeScript types exported for use in services
- [x] AC19: Zod schema tests verify validation logic (rejects negative/non-integer bytes, validates structure)

## Constraints

- Files table must NOT have foreign keys to entities from E03 (classes, assignments, tools)
- Must work with existing users and groups tables from E01/E02
- Follow existing Drizzle patterns: UUID PKs, timestamps, soft deletes
- Storage key must be unique to prevent collisions across backends
- Purpose field uses varchar, not enum, for flexibility

## Out of Scope

- Service layer logic (E05-T005)
- API routes (E05-T006, E05-T007)
- Storage backend implementations (E05-T003, E05-T004)
- Entity association tables like user_avatars, assignment_attachments (deferred to post-E03)

## Context

This schema is intentionally decoupled from E03 entities. The `purpose` field provides categorization (e.g., 'general', 'avatar', 'attachment') without requiring foreign keys to tables that don't exist yet. When E03 is complete, a follow-up epic can add proper association tables that link files to specific entities.

The three-tier limit system resolves limits in this order:
1. Check `user_storage_limits` for user-specific override
2. Check `groups.settings.storageLimits[role]` for role-based limit
3. Fall back to system defaults from environment variables

See the E05 epic notes for the complete storage limit resolution algorithm.

## Reviews

| Review Type | Verdict | Link |
| ----------- | ------- | ---- |
| Code Review | APPROVED | [E05-T001-code-review.md](../../docs/reviews/E05/E05-T001-code-review.md) |
| QA Review | PASS | [E05-T001-qa-report.md](../../docs/reviews/E05/E05-T001-qa-report.md) |
| Integration Test | PASS | [E05-T001-integration-report.md](../../docs/reviews/E05/E05-T001-integration-report.md) |

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-13 | DRAFT | pm | Task created for Epic E05 |
| 2026-01-15 | DRAFT | pm | Rewritten to remove E03 dependencies; replaced entity_type/entity_id with purpose field |
| 2026-01-15 | ANALYZED | analyst | Created implementation spec with detailed schemas, migration, and Zod validation |
| 2026-01-15 | APPROVED | architect | Architecture review passed; group_id FK changed to SET NULL (soft delete policy) |
| 2026-01-15 | TESTS_READY | developer | Tests written for files schema, user_storage_limits schema, and Zod storage schemas. Tests fail as expected (red phase - implementation files don't exist yet). |
| 2026-01-15 | IMPLEMENTED | developer | Implementation complete. Created files.ts, user-storage-limits.ts schemas, migration 0012, and storage.schema.ts Zod schemas. All 158 tests pass. Updated barrel exports in both packages. |
| 2026-01-15 | CODE_REVIEW | reviewer | Code review APPROVED. All acceptance criteria met, 242 tests pass, follows established patterns. Ready for QA. |
| 2026-01-15 | QA_REVIEW | qa | QA PASS. All 19 acceptance criteria verified. 1550 tests pass. Build and typecheck successful. Ready for integration testing. |
| 2026-01-15 | INTEGRATION_TESTING | qa | Integration PASS. All 19 ACs verified against real PostgreSQL. Tables, constraints, indexes, triggers, and FK cascade behaviors all work correctly. |
| 2026-01-15 | DOCS_UPDATE | writer | KB documentation updated. Created new file-storage-schema.md concept page documenting the three-tier storage limit system, file metadata patterns, and migration details. |

## Documentation Updates

**KB Documentation:**

- Created: `apps/docs/src/database/concepts/file-storage-schema.md`
  - Comprehensive documentation of files and user_storage_limits tables
  - Three-tier storage limit system with resolution algorithm and examples
  - File metadata tracking patterns (purpose field, soft delete, multi-backend)
  - Foreign key behaviors (CASCADE on uploaded_by, SET NULL on group_id)
  - Common query patterns with code examples
  - Migration 0012 details (enums, constraints, indexes, triggers)
  - Set frontmatter: `related_code`, `implements_task: E05-T001`, `last_verified: 2026-01-15`
  - Added backlog references in Related Pages section

- Updated: `apps/docs/src/.vitepress/config.ts`
  - Added "File Storage Schema" entry to Database → Concepts sidebar section
  - Replaced "Coming Soon" placeholder with actual page link

**Legacy Documentation:**

No updates needed. File storage schema is thoroughly documented in KB; legacy docs (ARCHITECTURE.md, CONVENTIONS.md) provide high-level references that don't require updates for this schema addition.

**Verification:**

- ✅ Build check passed (`pnpm docs:build` - no broken links, valid markdown)
- ⏭️ Staleness check skipped (script not yet implemented in E06-T003)
- ✅ All KB pages include backlog references
- ✅ Sidebar navigation updated with new page
