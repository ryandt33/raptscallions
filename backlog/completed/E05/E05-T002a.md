---
id: "E05-T002a"
title: "Storage backend interface and extensible plugin system"
status: "todo"
priority: "critical"
labels: [backend, infrastructure, architecture]
assignee: ""
workflow_state: "DONE"
epic: "E05"
depends_on: []
blocks: ["E05-T002b", "E05-T003", "E05-T004", "E05-T005"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-15T00:00:00Z"
updated_at: "2026-01-16T00:00:00Z"
spec_file: "backlog/docs/specs/E05/E05-T002a-spec.md"
test_files: ["packages/storage/src/__tests__/errors.test.ts", "packages/storage/src/__tests__/registry.test.ts", "packages/storage/src/__tests__/factory.test.ts", "packages/storage/src/__tests__/types.test.ts"]
code_files: ["packages/storage/src/types.ts", "packages/storage/src/errors.ts", "packages/storage/src/registry.ts", "packages/storage/src/factory.ts", "packages/storage/src/index.ts"]
pr_url: ""
---

# E05-T002a: Storage backend interface and extensible plugin system

## Description

Establish the `@raptscallions/storage` package with a typed interface for storage backends and a plugin registration system that allows third parties to add custom storage backends without modifying package code.

## Why This Matters

Different deployments need different storage solutions (local filesystem for development, S3 for AWS, MinIO for self-hosted, Azure Blob for Microsoft shops, etc.). Hardcoding a fixed set of backends limits extensibility. A plugin system allows users to add custom backends (e.g., company-specific object storage, NAS systems) without forking the codebase.

The typed error classes provide consistent error handling across all storage operations, with appropriate HTTP status codes for API responses. Factory/instance management ensures backends are initialized lazily and reused efficiently.

## Acceptance Criteria

### Package & Interface
- [x] AC1: Package `@raptscallions/storage` created with proper structure and dependencies
- [x] AC2: IStorageBackend interface defines contract: upload, download, delete, exists, getSignedUrl
- [x] AC3: Package exports TypeScript types for interface and helper types (UploadParams, UploadResult, SignedUrl)

### Plugin Registry
- [x] AC4: Storage backends can be registered programmatically at runtime
- [x] AC5: Backend registration validates that implementations satisfy the interface contract
- [x] AC6: System provides a way to retrieve registered backend by identifier
- [x] AC7: Built-in backends (local, S3) can be registered using the same mechanism
- [x] AC8: Attempting to retrieve an unregistered backend fails with clear, actionable error
- [x] AC9: Multiple backends can be registered simultaneously without conflicts
- [x] AC10: Backend registration is idempotent (re-registering same backend overwrites safely)

### Factory & Instance Management
- [x] AC11: Factory creates backend instances on demand (lazy instantiation)
- [x] AC12: Factory caches instances (singleton per backend type)
- [x] AC13: Factory throws typed error for unknown backend identifiers
- [x] AC14: Tests can reset factory state between test cases

### Error Types
- [x] AC15: Package exports StorageError (extends AppError with 500 status)
- [x] AC16: Package exports QuotaExceededError (extends AppError with 403 status)
- [x] AC17: Package exports FileNotFoundError (extends AppError with 404 status)
- [x] AC18: Package exports InvalidFileTypeError (extends AppError with 400 status)

## Constraints

- TypeScript strict mode with zero errors
- No hardcoded list of backend types in the interface layer
- Plugin registration must be type-safe (TypeScript enforces interface compliance)
- Factory must support lazy loading (don't instantiate until needed)
- Factory caching must be thread-safe (avoid race conditions)
- Error types must extend AppError with correct status codes
- Must work with ES modules (not just CommonJS)
- Registry state must be resettable for testing (global state cleanup)

## Out of Scope

- Configuration system (E05-T002b)
- Actual backend implementations for local, S3, etc. (E05-T003, E05-T004, E05-T005)
- File service business logic (E05-T006+)
- API routes for file operations (E05-T007, E05-T008)
- Database schema for files table (E05-T001)

## Context

### Extensibility Pattern

The storage system should follow a plugin architecture where:
1. Core package defines the interface (this task)
2. Backend implementations register themselves (E05-T003+)
3. Configuration selects which backend to use (E05-T002b)
4. Factory/registry creates instances on demand (this task)

### Integration Points

- Uses Zod for type validation (from `@raptscallions/core`)
- Error types extend AppError from `@raptscallions/core`
- Configuration system (E05-T002b) will consume the registry

### Error Types Usage

Error types provide domain-specific errors for storage operations:
- **StorageError**: Generic backend failures (network, permissions, service unavailable)
- **QuotaExceededError**: User/group storage quota exceeded (thrown before upload)
- **FileNotFoundError**: File lookup fails (download, delete, exists operations)
- **InvalidFileTypeError**: MIME type not in allowed list (upload validation)

These map to appropriate HTTP status codes for API responses.

### Factory Pattern

Factory should:
- Lazy instantiate backends (don't create until first use)
- Cache instances per backend type (singleton pattern)
- Support backend registration before or after factory use
- Provide reset mechanism for testing

### Patterns to Consider

- Similar to how Fastify plugins register themselves
- Similar to how module loaders work in E04 module system
- Registry pattern with type-safe plugin registration

## Reviews

| Type | Verdict | Date | Link |
| ---- | ------- | ---- | ---- |
| Code Review | APPROVED | 2026-01-16 | [E05-T002a-code-review.md](../../docs/reviews/E05/E05-T002a-code-review.md) |
| QA Review | PASS | 2026-01-16 | [E05-T002a-qa-report.md](../../docs/reviews/E05/E05-T002a-qa-report.md) |
| Integration Test | PASS | 2026-01-16 | [E05-T002a-integration-report.md](../../docs/reviews/E05/E05-T002a-integration-report.md) |

## Documentation Updates

**KB Documentation:**

- Created: `apps/docs/src/api/concepts/storage-backends.md`
  - New concept page documenting the IStorageBackend interface, plugin registry, factory pattern, and error types
  - Set `implements_task: E05-T002a`
  - Set `related_code` with all 5 storage package files
  - Set `last_verified: 2026-01-16`
  - Added Related Pages section with backlog references and related KB links
- Updated: `apps/docs/src/.vitepress/config.ts`
  - Added "Storage Backends" entry to API Concepts sidebar section

**Legacy Documentation:**

- Updated: `docs/ARCHITECTURE.md`
  - Added `packages/storage/` to monorepo structure diagram
  - Added "Plugin registry for storage" to Key Design Decisions table

**Verification:**

- Build check passed (no broken links)
- Staleness check passed (0 stale docs)
- All KB pages include backlog references

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-16 | PR_READY | writer | Documentation complete; new KB page created; legacy docs updated |
| 2026-01-16 | DOCS_UPDATE | qa | Integration PASS; all 18 ACs verified at runtime; package exports, registry, factory, and errors validated |
| 2026-01-16 | INTEGRATION_TESTING | qa | QA PASS; all 18 ACs verified; 98 tests pass; build and typecheck pass |
| 2026-01-16 | QA_REVIEW | reviewer | Code review APPROVED; all 98 tests pass; zero TypeScript errors; implementation follows spec and conventions |
| 2026-01-16 | IMPLEMENTED | developer | TDD green phase complete; all 98 tests pass; 5 implementation files created |
| 2026-01-16 | TESTS_READY | developer | TDD red phase complete; 4 test files created covering errors, registry, factory, and types |
| 2026-01-16 | APPROVED | architect | Architecture review passed; spec follows established patterns |
| 2026-01-16 | ANALYZED | analyst | Created implementation spec with detailed interface, registry, factory, and error definitions |
| 2026-01-15 | REPLANNED | pm | Split from E05-T002, removed hardcoded enums, focused on extensibility |
| 2026-01-13 | DRAFT | pm | Original task created for Epic E05 |
