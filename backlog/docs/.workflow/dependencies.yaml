# Raptscallions Task Dependencies
# Single source of truth for epic definitions and task dependency graph
#
# This file is read by the orchestrator to determine:
# - Which tasks can be started (all dependencies satisfied)
# - Blocking relationships
# - Epic organization

version: "1.0"

# =============================================================================
# EPICS
# =============================================================================

epics:
  E01:
    title: "Foundation Infrastructure"
    description: "Core infrastructure setup - monorepo, database, types"
    phase: 1
    estimated_weeks: 2
    priority: 1

  E02:
    title: "API Foundation & Authentication"
    description: "Fastify server, Lucia auth, OAuth, CASL permissions"
    phase: 2
    estimated_weeks: 2
    priority: 2
    depends_on_epics: [E01]

  E03:
    title: "Core Entity CRUD"
    description: "Groups, Classes, Tools, Assignments services and routes"
    phase: 2
    estimated_weeks: 2
    priority: 3
    depends_on_epics: [E01, E02]

  E04:
    title: "AI Gateway & Chat Runtime"
    description: "OpenRouter integration, session management, chat message flow"
    phase: 2
    estimated_weeks: 2
    priority: 4
    depends_on_epics: [E02, E03]

# =============================================================================
# TASKS
# =============================================================================
# Organized by epic. Each task specifies its dependencies.

tasks:
  # ─────────────────────────────────────────────────────────────────────────
  # EPIC 01: Foundation Infrastructure
  # ─────────────────────────────────────────────────────────────────────────

  E01-T001:
    title: "Initialize pnpm monorepo"
    epic: E01
    priority: critical
    depends_on: []
    estimated_hours: 4

  E01-T002:
    title: "Setup packages/core with Zod"
    epic: E01
    priority: critical
    depends_on: [E01-T001]
    estimated_hours: 3

  E01-T003:
    title: "Setup packages/db with Drizzle"
    epic: E01
    priority: critical
    depends_on: [E01-T001]
    estimated_hours: 4

  E01-T004:
    title: "Create users schema"
    epic: E01
    priority: critical
    depends_on: [E01-T003]
    estimated_hours: 3

  E01-T005:
    title: "Create groups schema with ltree"
    epic: E01
    priority: high
    depends_on: [E01-T003, E01-T004]
    estimated_hours: 4

  E01-T006:
    title: "Create group_members schema"
    epic: E01
    priority: high
    depends_on: [E01-T004, E01-T005]
    estimated_hours: 3

  E01-T007:
    title: "Setup packages/telemetry (stub)"
    epic: E01
    priority: medium
    depends_on: [E01-T001]
    estimated_hours: 3

  E01-T008:
    title: "Configure Vitest for monorepo"
    epic: E01
    priority: high
    depends_on: [E01-T001]
    estimated_hours: 4

  # ─────────────────────────────────────────────────────────────────────────
  # EPIC 02: API Foundation & Authentication
  # ─────────────────────────────────────────────────────────────────────────

  E02-T001:
    title: "Fastify API server foundation"
    epic: E02
    priority: critical
    depends_on: []
    estimated_hours: 6

  E02-T002:
    title: "Sessions table and Lucia setup"
    epic: E02
    priority: critical
    depends_on: [E02-T001]
    estimated_hours: 5

  E02-T003:
    title: "Email/password authentication routes"
    epic: E02
    priority: critical
    depends_on: [E02-T002]
    estimated_hours: 6

  E02-T004:
    title: "OAuth integration with Arctic"
    epic: E02
    priority: high
    depends_on: [E02-T002]
    estimated_hours: 6

  E02-T005:
    title: "CASL permission definitions and middleware"
    epic: E02
    priority: high
    depends_on: [E02-T002]
    estimated_hours: 6

  E02-T006:
    title: "Authentication guards and decorators"
    epic: E02
    priority: high
    depends_on: [E02-T003, E02-T005]
    estimated_hours: 4

  E02-T007:
    title: "Rate limiting middleware"
    epic: E02
    priority: medium
    depends_on: [E02-T001]
    estimated_hours: 3

  E02-T008:
    title: "Auth integration tests"
    epic: E02
    priority: high
    depends_on: [E02-T006]
    estimated_hours: 6

  # ─────────────────────────────────────────────────────────────────────────
  # EPIC 03: Core Entity CRUD
  # ─────────────────────────────────────────────────────────────────────────

  E03-T001:
    title: "Classes and class_members schemas"
    epic: E03
    priority: critical
    depends_on: []
    estimated_hours: 4

  E03-T002:
    title: "Tools schema with YAML storage"
    epic: E03
    priority: critical
    depends_on: []
    estimated_hours: 3

  E03-T003:
    title: "Assignments and submissions schemas"
    epic: E03
    priority: high
    depends_on: [E03-T001, E03-T002]
    estimated_hours: 4

  E03-T004:
    title: "Groups service and API routes"
    epic: E03
    priority: high
    depends_on: [E03-T001]
    estimated_hours: 6

  E03-T005:
    title: "Classes service and API routes"
    epic: E03
    priority: high
    depends_on: [E03-T001]
    estimated_hours: 5

  E03-T006:
    title: "Tools service with YAML parsing"
    epic: E03
    priority: high
    depends_on: [E03-T002]
    estimated_hours: 5

  E03-T007:
    title: "Assignments service and API routes"
    epic: E03
    priority: high
    depends_on: [E03-T003]
    estimated_hours: 5

  E03-T008:
    title: "Theme service with inheritance logic"
    epic: E03
    priority: medium
    depends_on: [E03-T004]
    estimated_hours: 4

  # ─────────────────────────────────────────────────────────────────────────
  # EPIC 04: AI Gateway & Chat Runtime
  # ─────────────────────────────────────────────────────────────────────────

  E04-T001:
    title: "Sessions and messages schemas"
    epic: E04
    priority: critical
    depends_on: []
    estimated_hours: 4

  E04-T002:
    title: "OpenRouter client with streaming"
    epic: E04
    priority: critical
    depends_on: []
    estimated_hours: 5

  E04-T003:
    title: "Usage tracking schema and service"
    epic: E04
    priority: high
    depends_on: [E04-T002]
    estimated_hours: 4

  E04-T004:
    title: "SessionService with message persistence"
    epic: E04
    priority: high
    depends_on: [E04-T001]
    estimated_hours: 5

  E04-T005:
    title: "Chat message flow and context building"
    epic: E04
    priority: critical
    depends_on: [E04-T002, E04-T004]
    estimated_hours: 6

  E04-T006:
    title: "SSE streaming endpoint"
    epic: E04
    priority: high
    depends_on: [E04-T005]
    estimated_hours: 5

  E04-T007:
    title: "Chat API routes"
    epic: E04
    priority: high
    depends_on: [E04-T006]
    estimated_hours: 4

  E04-T008:
    title: "Chat integration tests"
    epic: E04
    priority: high
    depends_on: [E04-T007]
    estimated_hours: 6

# =============================================================================
# DEPENDENCY GRAPH SUMMARY
# =============================================================================
# Phase 2 Planning - API Foundation and Core Features
#
# E02: API Foundation & Authentication (depends on E01)
#   ├── E02-T001: Fastify server foundation
#   ├── E02-T002: Sessions + Lucia → E02-T003 (Email/password)
#   │                             → E02-T004 (OAuth)
#   │                             → E02-T005 (CASL permissions)
#   ├── E02-T006: Auth guards (depends on T003, T005)
#   ├── E02-T007: Rate limiting
#   └── E02-T008: Integration tests
#
# E03: Core Entity CRUD (depends on E01, E02)
#   ├── E03-T001: Classes schemas
#   ├── E03-T002: Tools schemas
#   ├── E03-T003: Assignments schemas (depends on T001, T002)
#   ├── E03-T004: Groups service + routes
#   ├── E03-T005: Classes service + routes
#   ├── E03-T006: Tools service with YAML parsing
#   ├── E03-T007: Assignments service + routes
#   └── E03-T008: Theme service
#
# E04: AI Gateway & Chat Runtime (depends on E02, E03)
#   ├── E04-T001: Sessions/messages schemas
#   ├── E04-T002: OpenRouter client
#   ├── E04-T003: Usage tracking (depends on T002)
#   ├── E04-T004: SessionService (depends on T001)
#   ├── E04-T005: Chat message flow (depends on T002, T004)
#   ├── E04-T006: SSE streaming (depends on T005)
#   ├── E04-T007: Chat API routes (depends on T006)
#   └── E04-T008: Integration tests (depends on T007)
