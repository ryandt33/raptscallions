---
id: "E06-T003"
title: "Staleness tracking schema and detection logic"
status: "todo"
priority: "high"
epic: "E06"
depends_on: []
blocks: ["E06-T004"]
---

# Staleness Tracking Schema and Detection Logic

## Description

Implement a system to detect when documentation may be out of sync with code changes. Documents declare their related code files, and the system compares modification dates to flag potentially stale content.

## Why This Matters

Documentation drift is a common problem - code changes but docs don't update. Automated detection catches staleness early, preventing developers from following outdated guidance. This is especially important for agents relying on KB content for implementation decisions.

## Acceptance Criteria

- [ ] AC1: Frontmatter schema defined for doc-code relationships
- [ ] AC2: Docs can declare related code paths in frontmatter
- [ ] AC3: Script scans all docs in apps/docs/src/ and extracts relationships
- [ ] AC4: Script compares doc verification date with code file last-modified
- [ ] AC5: Report generated listing potentially stale docs
- [ ] AC6: Configurable threshold for staleness (e.g., code changed 7+ days after doc)
- [ ] AC7: Ignore patterns supported (e.g., stable reference docs)
- [ ] AC8: JSON/markdown output format for integration with CI
- [ ] AC9: `pnpm docs:check-stale` command available

## Constraints

- Must work in CI environment (no interactive prompts)
- Should complete quickly (under 30 seconds for typical doc count)
- Git history access required for accurate modification dates
- Should not block builds (warning-level, not error)

## Out of Scope

- Automatic doc updates
- Integration with PR comments
- Slack/email notifications
- Determining what specifically changed (just flags staleness)

## Context

### Frontmatter Schema

```yaml
---
title: Session Lifecycle
related_code:
  - packages/auth/src/session.service.ts
  - apps/api/src/middleware/session.middleware.ts
implements_task: E02-T002
last_verified: 2026-01-12
---
```

### Detection Logic

```
For each doc with related_code:
  1. Get doc's last_verified date
  2. For each related code file:
     a. Get file's last commit date
     b. If commit date > last_verified + threshold:
        - Flag doc as potentially stale
  3. Generate report
```

### Output Format

```json
{
  "stale": [
    {
      "doc": "apps/docs/src/auth/concepts/session-lifecycle.md",
      "last_verified": "2026-01-10",
      "related_changes": [
        {
          "file": "packages/auth/src/session.service.ts",
          "changed": "2026-01-12",
          "commit": "abc123"
        }
      ]
    }
  ],
  "fresh": 42,
  "unchecked": 5
}
```

Unchecked = docs without `related_code` frontmatter (can't verify)
