---
id: "E06-T010"
title: "Document API patterns and conventions"
status: "todo"
priority: "high"
task_type: "backend"
labels:
  - docs
  - backend
  - api
assignee: ""

workflow_state: "DRAFT"
epic: "E06"
depends_on: ["E06-T002"]
blocks: []
breakpoint: false
assigned_agent: ""

created_at: "2026-01-13"
updated_at: "2026-01-13"
started_at: ""
completed_at: ""

spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E06-T010: Document API patterns and conventions

## Description

Create comprehensive KB documentation for the API layer by examining the actual implemented code from E02 completed tasks. This populates the API domain that was marked as "partial" in E06-T002, covering Fastify server setup, plugin architecture, route handler patterns, error handling conventions, request validation, and middleware patterns.

## Why This Matters

The API layer is the primary interface for clients and orchestrates all backend functionality. Accurate documentation helps developers and agents understand how to add routes, handle errors, validate requests, implement middleware, and follow Fastify best practices. Documentation must reflect what's actually implemented and the patterns established across E02 tasks.

## Acceptance Criteria

- [ ] AC1: api/index.md provides domain overview and navigation
- [ ] AC2: api/concepts/fastify-setup.md documents server initialization and configuration
- [ ] AC3: api/concepts/plugin-architecture.md documents plugin pattern and encapsulation
- [ ] AC4: api/concepts/request-lifecycle.md documents onRequest, preHandler, handler flow
- [ ] AC5: api/patterns/route-handlers.md documents route definition patterns with types
- [ ] AC6: api/patterns/error-handling.md documents error handler and typed error classes
- [ ] AC7: api/patterns/validation.md documents Zod schema validation with Fastify
- [ ] AC8: api/patterns/middleware.md documents auth guards, rate limiting, logging
- [ ] AC9: All docs have frontmatter with related_code pointing to actual files
- [ ] AC10: All docs reference implementing tasks (E02-T001 through E02-T007)

## Constraints

- Document only what is implemented (check completed E02 tasks)
- Use code snippets from real route handlers, not invented examples
- Frontmatter must include last_verified date
- Document the Fastify-specific patterns, not generic REST patterns

## Out of Scope

- GraphQL API (not implemented)
- WebSocket API (not implemented - Socket.io is separate)
- API versioning (not implemented)
- OpenAPI/Swagger documentation (separate concern)
- API gateway patterns (not implemented)

## Context

### Source Material

**Completed Tasks:**

- E02-T001: Fastify API server foundation
- E02-T002: Sessions table and Lucia setup
- E02-T003: Email/password authentication routes
- E02-T004: OAuth integration with Arctic
- E02-T005: CASL permission definitions and middleware
- E02-T006: Authentication guards and decorators
- E02-T007: Rate limiting middleware

**Key Source Files:**

- `apps/api/src/server.ts` - Server setup and plugin registration
- `apps/api/src/config.ts` - Environment configuration with Zod
- `apps/api/src/middleware/error-handler.ts` - Global error handler
- `apps/api/src/middleware/request-logger.ts` - Request logging
- `apps/api/src/middleware/session.middleware.ts` - Session middleware with DI
- `apps/api/src/middleware/auth.middleware.ts` - Authentication guards
- `apps/api/src/middleware/rate-limit.middleware.ts` - Rate limiting
- `apps/api/src/routes/health.routes.ts` - Health check routes
- `apps/api/src/routes/auth.routes.ts` - Auth routes with validation
- `apps/api/src/routes/oauth.routes.ts` - OAuth routes
- `apps/api/src/services/auth.service.ts` - Auth business logic
- `apps/api/src/services/oauth.service.ts` - OAuth business logic

**Specs and Reviews:**

- `backlog/docs/specs/E02/` - All E02 implementation specifications
- `backlog/docs/reviews/E02/` - All E02 code reviews and QA reports

### Documentation Structure

```
apps/docs/src/api/
├── index.md                         # Overview, REST principles, quick links
├── concepts/
│   ├── fastify-setup.md             # Server initialization, graceful shutdown
│   ├── plugin-architecture.md       # Fastify plugins, encapsulation rules
│   ├── request-lifecycle.md         # Hook order, preHandler, handler flow
│   └── configuration.md             # Environment validation, config object
├── patterns/
│   ├── route-handlers.md            # Route definition, typed requests
│   ├── error-handling.md            # Error handler, AppError classes
│   ├── validation.md                # Zod schemas, request validation
│   ├── middleware.md                # Auth guards, rate limiting, logging
│   ├── service-layer.md             # Service pattern, business logic separation
│   └── response-format.md           # Standard response envelopes
├── decisions/
│   └── 001-fastify-over-express.md  # ADR for framework choice
└── troubleshooting/
    ├── plugin-issues.md             # Plugin encapsulation problems
    └── common-errors.md             # Common API errors and solutions
```

### Key Patterns to Document

**1. Route Handler with Types (from E02-T003):**

```typescript
app.post<{ Body: RegisterInput }>(
  "/register",
  {
    schema: { body: registerSchema },
  },
  async (request, reply) => {
    const user = await authService.register(request.body);
    return reply.status(201).send({ data: user });
  }
);
```

**2. Error Handler (from E02-T001):**

```typescript
app.setErrorHandler((error, request, reply) => {
  if (error instanceof AppError) {
    return reply.status(error.statusCode).send({
      error: error.message,
      code: error.code,
      details: error.details,
    });
  }

  logger.error({ error, requestId: request.id }, "Unhandled error");
  return reply.status(500).send({
    error: "Internal server error",
    code: "INTERNAL_ERROR",
  });
});
```

**3. Authentication Guard (from E02-T006):**

```typescript
export const requireAuth = async (
  request: FastifyRequest,
  reply: FastifyReply
) => {
  if (!request.user) {
    throw new UnauthorizedError("Authentication required");
  }
};

export const requireRole = (role: UserRole) => {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new UnauthorizedError("Authentication required");
    }
    if (request.user.role !== role && request.user.role !== "system_admin") {
      throw new ForbiddenError(`Role ${role} required`);
    }
  };
};
```

**4. Validation with Zod (from E02-T003):**

```typescript
const registerSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  name: z.string().min(1).max(100),
});

type RegisterInput = z.infer<typeof registerSchema>;

app.post<{ Body: RegisterInput }>(
  "/register",
  {
    schema: { body: registerSchema },
  },
  async (request, reply) => {
    // request.body is typed and validated
  }
);
```

**5. Rate Limiting (from E02-T007):**

```typescript
const rateLimitConfig = {
  global: true,
  max: 100,
  timeWindow: "15 minutes",
  ban: 5,
};

app.register(rateLimit, rateLimitConfig);

// Route-specific override
app.post(
  "/login",
  {
    config: {
      rateLimit: {
        max: 5,
        timeWindow: "1 minute",
      },
    },
  },
  handler
);
```

**6. Session Middleware with DI (from E02-T002, E02-T008):**

```typescript
interface SessionMiddlewareOptions {
  sessionService?: SessionServiceLike;
}

export const sessionMiddleware = fp<SessionMiddlewareOptions>(
  async (fastify, opts) => {
    const service = opts.sessionService || sessionService;

    fastify.addHook("onRequest", async (request, reply) => {
      const sessionId = request.cookies["session"];
      if (!sessionId) return;

      const { session, user } = await service.validate(sessionId);
      if (session && user) {
        request.session = session;
        request.user = user;
      }
    });
  }
);
```

**7. Service Layer Pattern (from E02-T003):**

```typescript
export const authService = {
  async register(input: RegisterInput): Promise<UserResponse> {
    // Validate email uniqueness
    const existing = await db.query.users.findFirst({
      where: eq(users.email, input.email),
    });

    if (existing) {
      throw new ConflictError("Email already registered");
    }

    // Hash password
    const passwordHash = await hashPassword(input.password);

    // Create user
    const [user] = await db
      .insert(users)
      .values({ ...input, passwordHash })
      .returning();

    return toUserResponse(user);
  },

  async login(input: LoginInput): Promise<LoginResponse> {
    // Service logic...
  },
};
```

**8. Plugin Registration Pattern (from E02-T001):**

```typescript
export const createServer = async (): Promise<FastifyInstance> => {
  const app = fastify({
    logger: createLogger(),
    requestIdHeader: "x-request-id",
  });

  // Core middleware (order matters)
  await app.register(cors, { origin: config.corsOrigins });
  await app.register(helmet);
  await app.register(rateLimit, rateLimitConfig);
  await app.register(cookie);
  await app.register(sessionMiddleware);

  // Error handler
  app.setErrorHandler(errorHandler);

  // Routes
  await app.register(healthRoutes, { prefix: "" });
  await app.register(authRoutes, { prefix: "/auth" });
  await app.register(oauthRoutes, { prefix: "/oauth" });

  return app;
};
```

### Request Lifecycle (from Fastify docs + E02 implementation)

Document the hook execution order:

1. `onRequest` - First hook, session validation happens here
2. `preParsing` - Before body parsing
3. `preValidation` - Before validation
4. `preHandler` - **Auth guards run here**, last chance before handler
5. `handler` - Route handler executes
6. `preSerialization` - Modify response before serialization
7. `onSend` - Modify payload before sending
8. `onResponse` - After response sent (logging)
9. `onError` - If error thrown
10. `onRequestAbort` - If connection aborted

### Environment Configuration (from E02-T001)

Document the Zod validation pattern:

```typescript
const envSchema = z.object({
  NODE_ENV: z
    .enum(["development", "test", "production"])
    .default("development"),
  PORT: z.coerce.number().default(3000),
  DATABASE_URL: z.string().url(),
  REDIS_URL: z.string().url(),
  CORS_ORIGINS: z.string().default("http://localhost:5173"),
  SESSION_SECRET: z.string().min(32),
});

export const config = envSchema.parse(process.env);
```

### Response Format Conventions (from E02-T003, E02-T004)

Document the standard response patterns:

**Success (200):**

```json
{
  "data": { "id": "123", "email": "user@example.com" }
}
```

**Created (201):**

```json
{
  "data": { "id": "123", "email": "user@example.com" }
}
```

**Error (4xx, 5xx):**

```json
{
  "error": "Email already registered",
  "code": "EMAIL_CONFLICT",
  "details": { "email": "user@example.com" }
}
```

### Typed Errors (from @raptscallions/core/errors)

Document the error class hierarchy:

- `AppError` (base class)
  - `BadRequestError` (400)
  - `UnauthorizedError` (401)
  - `ForbiddenError` (403)
  - `NotFoundError` (404)
  - `ConflictError` (409)
  - `ValidationError` (422)
  - `InternalServerError` (500)

### Example Doc Structure

```markdown
---
title: Route Handler Patterns
related_code:
  - apps/api/src/routes/auth.routes.ts
  - apps/api/src/routes/oauth.routes.ts
  - apps/api/src/routes/health.routes.ts
implements_task: E02-T003
last_verified: 2026-01-13
---

# Route Handler Patterns

## Overview

Fastify route handlers in RaptScallions follow a consistent pattern with
TypeScript types, Zod validation, and error handling.

## Basic Route Pattern

[Code example from auth.routes.ts]

## Typed Request Bodies

[Explain generic types and validation]

## Route Configuration

[Explain schema option, preHandler, etc.]

## Service Layer Integration

[Show service pattern]

## References

**Implements:** [E02-T003](../../../backlog/completed/E02/E02-T003.md)

**Key Files:**

- [auth.routes.ts](../../../apps/api/src/routes/auth.routes.ts)
- [health.routes.ts](../../../apps/api/src/routes/health.routes.ts)

**Related Docs:**

- [Validation Patterns](./validation.md)
- [Error Handling](./error-handling.md)
- [Service Layer](./service-layer.md)
```

## Technical Notes

This task is about documentation, not implementation. The API patterns and conventions already exist in the codebase from E02 tasks. The goal is to capture what's been built so that future developers and agents can understand and follow the established patterns.

Focus on documenting:

- What makes Fastify different from Express
- Why we use specific patterns (typed requests, preHandler vs middleware)
- How the pieces fit together (plugins, routes, services, middleware)
- Common pitfalls and their solutions

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2026-01-13 | DRAFT | pm    | Task created |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
