---
id: "E06-T006"
title: "Document implemented database entities"
status: "todo"
priority: "high"
epic: "E06"
depends_on: ["E06-T002"]
blocks: []
---

# Document Implemented Database Entities

## Description

Create comprehensive KB documentation for the database layer by examining the actual implemented schemas from E01, E03, and E04 completed tasks. This covers Drizzle setup, all entity schemas, relationships, and database patterns.

## Why This Matters

The database schema is the foundation of the application's data model. Accurate documentation helps developers and agents understand entity relationships, query patterns, and how to extend the schema. Documentation must reflect what's actually built.

## Acceptance Criteria

- [ ] AC1: database/index.md provides domain overview and entity map
- [ ] AC2: database/concepts/users.md documents users schema and status enum
- [ ] AC3: database/concepts/groups.md documents groups schema with ltree
- [ ] AC4: database/concepts/group-members.md documents membership and roles
- [ ] AC5: database/concepts/sessions.md documents auth sessions schema
- [ ] AC6: database/concepts/classes.md documents classes and class-members
- [ ] AC7: database/concepts/tools.md documents tools schema with YAML storage
- [ ] AC8: database/concepts/chat.md documents chat-sessions and messages
- [ ] AC9: database/patterns/drizzle.md documents Drizzle patterns used
- [ ] AC10: All docs have frontmatter with related_code to schema files

## Constraints

- Document only what is implemented (check completed tasks and schema files)
- Verify all claims against actual source code in packages/db/
- Include actual SQL migration snippets where helpful
- Frontmatter must include last_verified date

## Out of Scope

- Assignments schema (not implemented - E03-T003 not complete)
- Runs schema (not implemented)
- AI usage tracking schema (not implemented)
- OneRoster sync tables (not implemented)

## Context

### Source Material

**Completed Tasks:**
- E01-T003: Setup packages/db with Drizzle
- E01-T004: Create users schema
- E01-T005: Create groups schema with ltree
- E01-T006: Create group_members schema
- E02-T002: Sessions table and Lucia setup
- E03-T001: Classes and class_members schemas
- E03-T002: Tools schema with YAML storage
- E04-T001: Sessions and messages schemas (chat)

**Key Source Files:**
- `packages/db/src/schema/users.ts`
- `packages/db/src/schema/groups.ts`
- `packages/db/src/schema/group-members.ts`
- `packages/db/src/schema/sessions.ts`
- `packages/db/src/schema/classes.ts`
- `packages/db/src/schema/class-members.ts`
- `packages/db/src/schema/tools.ts`
- `packages/db/src/schema/chat-sessions.ts`
- `packages/db/src/schema/messages.ts`
- `packages/db/src/migrations/`
- `packages/db/src/client.ts`

**Specs and Reviews:**
- `backlog/docs/specs/E01/` - Foundation specs
- `backlog/docs/specs/E03/` - Entity specs
- `backlog/docs/specs/E04/` - Chat specs

### Documentation Structure

```
apps/docs/src/database/
├── index.md                    # Overview, entity relationship diagram
├── concepts/
│   ├── users.md                # Users schema, status enum
│   ├── groups.md               # Groups with ltree hierarchy
│   ├── group-members.md        # Membership, roles
│   ├── sessions.md             # Auth sessions (Lucia)
│   ├── classes.md              # Classes and class-members
│   ├── tools.md                # Tools with YAML storage
│   └── chat.md                 # Chat sessions and messages
├── patterns/
│   ├── drizzle.md              # Drizzle patterns, query builder
│   ├── migrations.md           # Migration conventions
│   └── soft-delete.md          # Soft delete pattern
└── decisions/
    └── 001-drizzle-over-prisma.md  # ADR for ORM choice
```

### Entity Relationships (to document)

```
users
  ├── group_members (user_id → users.id)
  ├── class_members (user_id → users.id)
  ├── sessions (user_id → users.id)
  ├── tools (created_by → users.id)
  └── chat_sessions (user_id → users.id)

groups
  ├── group_members (group_id → groups.id)
  ├── classes (group_id → groups.id)
  └── tools (group_id → groups.id, nullable)

classes
  └── class_members (class_id → classes.id)

tools
  └── chat_sessions (tool_id → tools.id)

chat_sessions
  └── messages (session_id → chat_sessions.id)
```

### Example Doc Structure

```markdown
---
title: Groups Schema
related_code:
  - packages/db/src/schema/groups.ts
  - packages/db/src/migrations/0002_create_groups.sql
implements_task: E01-T005
last_verified: 2026-01-13
---

# Groups Schema

## Overview

Groups represent organizational units with hierarchical relationships using
PostgreSQL's ltree extension.

## Schema Definition

[Code from packages/db/src/schema/groups.ts]

## Hierarchy with ltree

[Explain ltree path format, queries for ancestors/descendants]

## Group Types

[Document the group_type enum: district, school, department, custom]

## References

**Implements:** [E01-T005](../../../backlog/completed/E01/E01-T005.md)

**Key Files:**
- [groups.ts](../../../packages/db/src/schema/groups.ts)
- [0002_create_groups.sql](../../../packages/db/src/migrations/0002_create_groups.sql)
```
