---
id: "E06-T007"
title: "Document implemented AI gateway"
status: "todo"
priority: "medium"
epic: "E06"
depends_on: ["E06-T002"]
blocks: []
---

# Document Implemented AI Gateway

## Description

Create KB documentation for the AI gateway integration by examining the actual implemented code from E04 completed tasks. This covers the OpenRouter client, streaming, error handling, and chat session/message persistence.

## Why This Matters

The AI gateway is core to the platform's value proposition. Accurate documentation helps developers and agents understand how to use the AI client, handle streaming responses, and extend AI capabilities. Documentation must reflect what's actually built.

## Acceptance Criteria

- [ ] AC1: ai/index.md provides domain overview
- [ ] AC2: ai/concepts/openrouter.md documents OpenRouter client configuration
- [ ] AC3: ai/concepts/streaming.md documents streaming response handling
- [ ] AC4: ai/patterns/chat-flow.md documents the message flow pattern
- [ ] AC5: ai/patterns/error-handling.md documents AI-specific error types
- [ ] AC6: All docs have frontmatter with related_code to actual files
- [ ] AC7: All docs reference implementing tasks (E04-T001, E04-T002)
- [ ] AC8: Code examples from actual implementation

## Constraints

- Document only what is implemented (check backlog/completed/E04/)
- Verify all claims against actual source code
- Use code snippets from real files, not invented examples
- Frontmatter must include last_verified date

## Out of Scope

- Chat API routes (not fully implemented)
- SSE endpoint (not fully implemented)
- Usage tracking (not implemented)
- Product tool runtime (not implemented)
- Module hooks (not implemented)

## Context

### Source Material

**Completed Tasks (backlog/completed/E04/):**
- E04-T001: Sessions and messages schemas
- E04-T002: OpenRouter client with streaming

**Key Source Files:**
- `packages/ai/src/client.ts` - OpenRouterClient class
- `packages/ai/src/types.ts` - TypeScript types
- `packages/ai/src/errors.ts` - AI-specific error classes
- `packages/ai/src/config.ts` - Environment configuration
- `packages/db/src/schema/chat-sessions.ts` - Chat session schema
- `packages/db/src/schema/messages.ts` - Message schema

**Specs and Reviews:**
- `backlog/docs/specs/E04/` - Implementation specifications
- `backlog/docs/reviews/E04/` - Code reviews and QA reports

### Documentation Structure

```
apps/docs/src/ai/
├── index.md                    # Overview: AI gateway, available features
├── concepts/
│   ├── openrouter.md           # Client configuration, model selection
│   └── streaming.md            # Async generator pattern, chunk types
├── patterns/
│   ├── chat-flow.md            # Message flow from user to persistence
│   └── error-handling.md       # RateLimitError, TimeoutError, etc.
└── decisions/
    └── 001-openrouter-over-direct.md  # ADR for gateway choice
```

### Key Types to Document

```typescript
// From packages/ai/src/types.ts
interface ChatMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

type StreamChunk =
  | { type: 'content'; content: string }
  | { type: 'done'; result: ChatCompletionResult };

interface ChatCompletionResult {
  content: string;
  usage: UsageMetadata;
  model: string;
  finishReason: 'stop' | 'length' | 'content_filter' | 'error' | null;
}
```

### Error Types to Document

- `RateLimitError` (429)
- `AuthenticationError` (401/403)
- `ModelNotAvailableError` (400)
- `TimeoutError`
- `InvalidResponseError`
- `AiError` (generic)

### Example Doc Structure

```markdown
---
title: OpenRouter Client
related_code:
  - packages/ai/src/client.ts
  - packages/ai/src/config.ts
implements_task: E04-T002
last_verified: 2026-01-13
---

# OpenRouter Client

## Overview

The OpenRouterClient provides a streaming-first interface to OpenRouter's
unified AI gateway.

## Configuration

[Environment variables from config.ts]

## Streaming Usage

[Code example from actual client.ts]

## Non-Streaming Usage

[Code example from actual client.ts]

## References

**Implements:** [E04-T002](../../../backlog/completed/E04/E04-T002.md)

**Key Files:**
- [client.ts](../../../packages/ai/src/client.ts)
- [config.ts](../../../packages/ai/src/config.ts)
```
