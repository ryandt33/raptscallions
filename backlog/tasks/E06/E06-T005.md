---
id: "E06-T005"
title: "Document implemented auth system"
status: "todo"
priority: "high"
epic: "E06"
depends_on: ["E06-T002"]
blocks: ["E06-T008"]
---

# Document Implemented Auth System

## Description

Create comprehensive KB documentation for the authentication and authorization system by examining the actual implemented code from E02 completed tasks. This covers Lucia sessions, email/password auth, OAuth, CASL permissions, guards, and rate limiting.

## Why This Matters

The auth system is foundational - every other feature depends on it. Accurate documentation helps developers and agents understand how to use guards, check permissions, and extend auth flows. Documentation must reflect what's actually built, not what was planned.

## Acceptance Criteria

- [ ] AC1: auth/index.md provides domain overview and navigation
- [ ] AC2: auth/concepts/sessions.md documents Lucia session lifecycle
- [ ] AC3: auth/concepts/lucia.md explains Lucia configuration and adapter
- [ ] AC4: auth/concepts/oauth.md documents Google/Microsoft OAuth flows
- [ ] AC5: auth/concepts/casl.md explains permission system and role definitions
- [ ] AC6: auth/patterns/guards.md documents authentication guard middleware
- [ ] AC7: auth/patterns/rate-limiting.md documents rate limit configuration
- [ ] AC8: All docs have frontmatter with related_code pointing to actual files
- [ ] AC9: All docs reference implementing tasks (E02-T002 through E02-T008)
- [ ] AC10: At least one troubleshooting doc based on lessons from implementation

## Constraints

- Document only what is implemented (check backlog/completed/E02/)
- Verify all claims against actual source code
- Use code snippets from real files, not invented examples
- Frontmatter must include last_verified date

## Out of Scope

- Password reset (not implemented)
- Two-factor authentication (not implemented)
- Clever OAuth (not implemented)
- Frontend login UI (not implemented)

## Context

### Source Material

**Completed Tasks (backlog/completed/E02/):**
- E02-T001: Fastify API server foundation
- E02-T002: Sessions table and Lucia setup
- E02-T003: Email/password authentication routes
- E02-T004: OAuth integration with Arctic
- E02-T005: CASL permission definitions and middleware
- E02-T006: Authentication guards and decorators
- E02-T007: Rate limiting middleware
- E02-T008: Auth integration tests

**Key Source Files:**
- `packages/auth/src/lucia.ts` - Lucia configuration
- `packages/auth/src/session.service.ts` - Session CRUD
- `packages/auth/src/abilities.ts` - CASL ability definitions
- `packages/auth/src/permissions.ts` - Permission middleware
- `packages/auth/src/oauth.ts` - OAuth client setup
- `apps/api/src/services/auth.service.ts` - Auth service
- `apps/api/src/services/oauth.service.ts` - OAuth service
- `apps/api/src/middleware/session.middleware.ts` - Session middleware
- `apps/api/src/middleware/auth.middleware.ts` - Auth guards
- `apps/api/src/middleware/rate-limit.middleware.ts` - Rate limiting
- `apps/api/src/routes/auth.routes.ts` - Auth API routes

**Specs and Reviews:**
- `backlog/docs/specs/E02/` - Implementation specifications
- `backlog/docs/reviews/E02/` - Code reviews and QA reports

### Documentation Structure

```
apps/docs/src/auth/
├── index.md                    # Overview: what auth covers, quick links
├── concepts/
│   ├── sessions.md             # Session lifecycle, cookies, extension
│   ├── lucia.md                # Lucia v3 setup, adapter, types
│   ├── oauth.md                # OAuth flow, providers, account linking
│   └── casl.md                 # Permissions, roles, hierarchy
├── patterns/
│   ├── guards.md               # requireAuth, requireRole, etc.
│   └── rate-limiting.md        # Tiered limits, configuration
├── decisions/
│   └── 001-lucia-over-passport.md  # ADR for auth library choice
└── troubleshooting/
    └── session-not-found.md    # Common session issues
```

### Example Doc Structure

```markdown
---
title: Session Lifecycle
related_code:
  - packages/auth/src/session.service.ts
  - packages/auth/src/lucia.ts
  - apps/api/src/middleware/session.middleware.ts
implements_task: E02-T002
last_verified: 2026-01-13
---

# Session Lifecycle

## Overview

[Explain what sessions do, how they work]

## Session Creation

[Code from actual implementation]

## Session Validation

[How middleware validates on each request]

## Session Extension

[Fresh session logic]

## References

**Implements:** [E02-T002](../../../backlog/completed/E02/E02-T002.md)

**Key Files:**
- [session.service.ts](../../../packages/auth/src/session.service.ts)
- [session.middleware.ts](../../../apps/api/src/middleware/session.middleware.ts)
```
