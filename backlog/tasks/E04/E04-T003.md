---
id: "E04-T003"
title: "Usage tracking schema and service"
status: "todo"
priority: "high"
labels: [backend, database]
assignee: ""
workflow_state: "DRAFT"
epic: "E04"
depends_on: ["E04-T002"]
blocks: ["E04-T005"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E04-T003: Usage tracking schema and service

## Description

Create ai_usage table and UsageService to track tokens, costs, and metadata for every AI request.

## Acceptance Criteria

- [ ] AC1: ai_usage table with user_id, group_id, tool_id, session_id, model, tokens, cost
- [ ] AC2: Computed column total_tokens = input_tokens + output_tokens
- [ ] AC3: Indexes on user_id, group_id, created_at for reporting
- [ ] AC4: Migration file 0009_create_ai_usage.sql
- [ ] AC5: UsageService.track method records usage
- [ ] AC6: Cost calculation from model pricing (stub for now)
- [ ] AC7: TypeScript types exported
- [ ] AC8: Tests verify usage recording
- [ ] AC9: Query helpers for usage reports (by user, group, date range)
- [ ] AC10: Handles missing/null fields gracefully

## Technical Notes

```typescript
export const aiUsage = pgTable('ai_usage', {
  id: uuid('id').primaryKey().defaultRandom(),
  userId: uuid('user_id').notNull().references(() => users.id),
  groupId: uuid('group_id').references(() => groups.id),
  toolId: uuid('tool_id').references(() => tools.id),
  sessionId: uuid('session_id').references(() => sessions.id),
  model: varchar('model', { length: 100 }).notNull(),
  inputTokens: integer('input_tokens').notNull(),
  outputTokens: integer('output_tokens').notNull(),
  totalTokens: integer('total_tokens').generatedAlwaysAs(
    sql`input_tokens + output_tokens`
  ),
  cost: numeric('cost', { precision: 10, scale: 6 }).notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
}, (table) => ({
  userIdIdx: index('ai_usage_user_id_idx').on(table.userId),
  groupIdIdx: index('ai_usage_group_id_idx').on(table.groupId),
  createdAtIdx: index('ai_usage_created_at_idx').on(table.createdAt),
}));
```

Cost calculation stub (real pricing in future epic):
```typescript
function calculateCost(model: string, usage: Usage): number {
  // TODO: lookup from ai_models table
  // For now, use rough estimates
  const costPer1kInput = 0.003;  // $3 per 1M tokens
  const costPer1kOutput = 0.015; // $15 per 1M tokens

  return (usage.inputTokens * costPer1kInput / 1000) +
         (usage.outputTokens * costPer1kOutput / 1000);
}
```

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-12 | DRAFT | pm | Task created |

## Reviews

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
