---
id: "E04-T006"
title: "SSE streaming endpoint"
status: "todo"
priority: "high"
labels: [backend, api]
assignee: ""
workflow_state: "DRAFT"
epic: "E04"
depends_on: ["E04-T005"]
blocks: ["E04-T007"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E04-T006: SSE streaming endpoint

## Description

Implement Server-Sent Events (SSE) endpoint for streaming AI responses to client in real-time.

## Acceptance Criteria

- [ ] AC1: SSE response with Content-Type: text/event-stream
- [ ] AC2: Stream chunks as 'data: {content}' format
- [ ] AC3: Send final event with usage metadata
- [ ] AC4: Close connection after complete response
- [ ] AC5: Handle client disconnect gracefully
- [ ] AC6: Support reconnection with Last-Event-ID
- [ ] AC7: Error events sent as 'event: error' with message
- [ ] AC8: Keep-alive comments every 30s
- [ ] AC9: Tests verify streaming format
- [ ] AC10: TypeScript types for SSE events

## Technical Notes

Fastify SSE pattern:
```typescript
app.post('/sessions/:id/messages', {
  preHandler: [requireAuth],
}, async (request, reply) => {
  const { content } = request.body;

  reply.raw.writeHead(200, {
    'Content-Type': 'text/event-stream',
    'Cache-Control': 'no-cache',
    'Connection': 'keep-alive',
  });

  try {
    const chunks = chatService.sendMessage(session.id, content);

    for await (const chunk of chunks) {
      if (typeof chunk === 'string') {
        reply.raw.write(`data: ${JSON.stringify({ content: chunk })}\n\n`);
      } else {
        // Final chunk with usage
        reply.raw.write(`data: ${JSON.stringify({ done: true, usage: chunk.usage })}\n\n`);
      }
    }
  } catch (error) {
    reply.raw.write(`event: error\ndata: ${JSON.stringify({ error: error.message })}\n\n`);
  } finally {
    reply.raw.end();
  }
});
```

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-12 | DRAFT | pm | Task created |

## Reviews

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
