---
id: E04-T010
title: Chat forking support (branch conversations)
status: todo
priority: medium
labels:
  - backend
  - database
  - enhancement
assignee: ""
workflow_state: DRAFT
epic: E04
depends_on:
  - E04-T001
  - E04-T009
blocks: []
breakpoint: false
assigned_agent: ""
created_at: 2026-01-14T00:00:00Z
updated_at: 2026-01-14T00:00:00Z
spec_file: backlog/docs/specs/E04/E04-T010-spec.md
test_files: []
code_files: []
pr_url: ""
---

# E04-T010: Chat Forking Support (Branch Conversations)

## Description

Add the ability to fork chat sessions, creating branching conversation paths. This allows users to explore different conversation directions from a specific point in the chat history without losing the original conversation thread.

**Use Cases:**
- User wants to try a different approach to a question mid-conversation
- Teacher wants to demonstrate multiple problem-solving paths
- User made a mistake and wants to restart from an earlier point
- Exploring "what if" scenarios in educational contexts

## Acceptance Criteria

### Schema Changes
- [ ] AC1: Add `parent_session_id` field to chat_sessions (nullable UUID, self-reference)
- [ ] AC2: Add `fork_from_seq` field to chat_sessions (nullable integer) indicating fork point message
- [ ] AC3: Add foreign key constraint with SET NULL on delete (parent session deletion doesn't cascade)
- [ ] AC4: Add index on `parent_session_id` for efficient fork tree queries
- [ ] AC5: Migration file 0011_add_chat_forking.sql

### Type Safety
- [ ] AC6: Update `ChatSession` and `NewChatSession` types to include fork fields
- [ ] AC7: Create Zod schema for fork validation (parent must exist, fork_from_seq valid)

### Relations
- [ ] AC8: Define Drizzle relations for parent/child session navigation
- [ ] AC9: Support querying session with all forks (tree structure)

### Testing
- [ ] AC10: Tests verify fork creation with valid parent and sequence
- [ ] AC11: Tests verify orphaned forks when parent is deleted (parent_session_id becomes null)
- [ ] AC12: Tests verify fork tree queries return correct structure

## Technical Notes

### Schema Design

```typescript
// chat-sessions.ts additions
export const chatSessions = pgTable("chat_sessions", {
  // ... existing fields ...

  // Fork support - allows branching conversations
  parentSessionId: uuid("parent_session_id")
    .references(() => chatSessions.id, { onDelete: "set null" }),
  forkFromSeq: integer("fork_from_seq"),

  // Note: fork_from_seq indicates which message in the parent session
  // was the last message before the fork. The forked session starts
  // fresh from that point.
}, (table) => ({
  // ... existing indexes ...
  parentSessionIdIdx: index("chat_sessions_parent_session_id_idx")
    .on(table.parentSessionId),
}));
```

### Fork Behavior

**Creating a Fork:**
1. User selects a message in an existing session to fork from
2. System creates new session with:
   - `parentSessionId` = original session ID
   - `forkFromSeq` = sequence number of selected message
   - Same `toolId` and `userId` as parent
   - State = "active"
3. Service layer can optionally copy messages 1 to `forkFromSeq` into new session
   - OR query pattern retrieves parent messages up to fork point when loading session

**Query Pattern for Fork Tree:**
```typescript
// Get all forks of a session
const forks = await db.query.chatSessions.findMany({
  where: eq(chatSessions.parentSessionId, sessionId),
  with: {
    messages: {
      orderBy: asc(messages.seq)
    }
  }
});

// Get full fork lineage (parent chain)
async function getSessionLineage(sessionId: string): Promise<ChatSession[]> {
  const lineage: ChatSession[] = [];
  let currentId: string | null = sessionId;

  while (currentId) {
    const session = await db.query.chatSessions.findFirst({
      where: eq(chatSessions.id, currentId)
    });
    if (!session) break;
    lineage.unshift(session);
    currentId = session.parentSessionId;
  }

  return lineage;
}
```

### Foreign Key Behavior

**SET NULL on Parent Delete:**
- When parent session is deleted, `parent_session_id` becomes null
- Forked sessions remain as standalone sessions
- This preserves student work even if teacher deletes the original

**Alternative Considered:**
- CASCADE delete would remove all forks when parent is deleted
- Rejected: Too destructive, loses valuable conversation branches

### UI Considerations (Out of Scope for Schema)

Future implementation needs:
- Visual fork tree/graph in session list
- "Fork from here" button on messages
- Navigation between parent and fork sessions
- Merge/compare fork branches (advanced feature)

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-14 | DRAFT | analyst | Task created based on user request for chat forking support |

## Reviews

### UX Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### Plan Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**
