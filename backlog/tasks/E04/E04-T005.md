---
id: "E04-T005"
title: "Chat message flow and context building"
status: "todo"
priority: "critical"
labels: [backend, ai]
assignee: ""
workflow_state: "DRAFT"
epic: "E04"
depends_on: ["E04-T002", "E04-T004"]
blocks: ["E04-T006", "E04-T007"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E04-T005: Chat message flow and context building

## Description

Implement the core chat flow: receive user message → build context (system + history) → call AI → persist response → track usage.

## Acceptance Criteria

- [ ] AC1: Build system message from tool behavior definition
- [ ] AC2: Fetch recent message history (last 20 messages default)
- [ ] AC3: Construct OpenAI messages array with roles
- [ ] AC4: Call OpenRouter with streaming enabled
- [ ] AC5: Collect full response while streaming
- [ ] AC6: Persist user message and AI response with sequence numbers
- [ ] AC7: Track usage after response complete
- [ ] AC8: Handle AI errors gracefully (retry logic for 429)
- [ ] AC9: Return generator for streaming chunks
- [ ] AC10: Tests verify context building and message persistence

## Technical Notes

Context building:
```typescript
async function buildContext(session: Session, userMessage: string) {
  const tool = await getToolById(session.toolId);
  const definition = parseToolYAML(tool.definition);

  const history = await db.query.messages.findMany({
    where: eq(messages.sessionId, session.id),
    orderBy: asc(messages.seq),
    limit: 20, // configurable
  });

  const messages = [
    { role: 'system', content: definition.behavior },
    ...history.map(m => ({ role: m.role, content: m.content })),
    { role: 'user', content: userMessage },
  ];

  return { messages, model: definition.model || env.AI_DEFAULT_MODEL };
}
```

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-12 | DRAFT | pm | Task created |

## Reviews

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
