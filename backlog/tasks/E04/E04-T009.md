---
id: "E04-T009"
title: "Chat schema enhancements (E04-T001 follow-up)"
status: "todo"
priority: "medium"
labels: [backend, database, follow-up]
assignee: ""
workflow_state: "DOCS_UPDATE"
epic: "E04"
depends_on: ["E04-T001"]
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-14T00:00:00Z"
updated_at: "2026-01-14T17:00:00Z"
spec_file: "backlog/docs/specs/E04/E04-T009-spec.md"
test_files: [
  "packages/core/src/__tests__/schemas/message-meta.schema.test.ts",
  "packages/db/src/__tests__/schema/chat-sessions.test.ts"
]
code_files: [
  "packages/core/src/schemas/message-meta.schema.ts",
  "packages/core/src/schemas/index.ts",
  "packages/db/src/schema/chat-sessions.ts",
  "packages/db/src/migrations/0010_enhance_chat_sessions.sql"
]
pr_url: ""
---

# E04-T009: Chat schema enhancements (E04-T001 follow-up)

## Description

Address deferred recommendations from E04-T001 code review and architecture review. These improvements enhance type safety, data integrity, and UX of the chat system.

**Source:** E04-T001 reviews identified these as "Should Address" or "Consider" items that were intentionally deferred during initial implementation.

## Acceptance Criteria

### Schema Changes
- [x] AC1: Remove "paused" state from session_state enum (YAGNI cleanup)
- [x] AC2: Add `deleted_at` timestamp to chat_sessions for soft delete support
- [x] AC3: Add `title` field (varchar 200) to chat_sessions for user-facing session names
- [x] AC4: Add `last_activity_at` timestamp to chat_sessions for "last active" display
- [x] AC5: Migration file 0010_enhance_chat_sessions.sql with enum alteration and new columns

### Type Safety
- [x] AC6: Create Zod schema for message meta field in `@raptscallions/core/schemas`
- [x] AC7: Export `MessageMeta` type inferred from Zod schema
- [x] AC8: Document common meta field patterns (tokens, model, latency_ms, extractions)

### Testing
- [x] AC9: Tests verify soft delete behavior (deleted sessions excluded from queries)
- [x] AC10: Tests verify meta field validation with Zod schema

## Technical Notes

### 1. Remove "paused" State

The "paused" state was speculatively added but has no defined user flow or UI. Per YAGNI principle, remove it:

```sql
-- Requires careful migration: update any 'paused' rows to 'active' first
UPDATE chat_sessions SET state = 'active' WHERE state = 'paused';
-- Then recreate enum without 'paused'
ALTER TYPE session_state RENAME TO session_state_old;
CREATE TYPE session_state AS ENUM ('active', 'completed');
ALTER TABLE chat_sessions ALTER COLUMN state TYPE session_state USING state::text::session_state;
DROP TYPE session_state_old;
```

**Note:** If any sessions exist with 'paused' state, they must be migrated first.

### 2. Soft Delete Support

Add soft delete to support "Delete conversation" feature without losing data:

```typescript
// chat-sessions.ts
deletedAt: timestamp("deleted_at", { withTimezone: true }),
```

Query pattern:
```typescript
const activeSessions = await db.query.chatSessions.findMany({
  where: isNull(chatSessions.deletedAt),
});
```

### 3. Session Metadata Fields

```typescript
// chat-sessions.ts - add fields
title: varchar("title", { length: 200 }),
lastActivityAt: timestamp("last_activity_at", { withTimezone: true }),
```

- `title`: User-editable session name (e.g., "Math homework help - Jan 14")
- `lastActivityAt`: Auto-updated on each message, enables "Last active 5 min ago" display

### 4. Message Meta Zod Schema

```typescript
// packages/core/src/schemas/message-meta.schema.ts
import { z } from "zod";

export const messageMetaSchema = z.object({
  tokens: z.number().int().positive().optional(),
  model: z.string().optional(),
  latency_ms: z.number().positive().optional(),
  extractions: z.array(z.object({
    type: z.string(),
    value: z.unknown(),
  })).optional(),
}).passthrough(); // Allow additional fields for extensibility

export type MessageMeta = z.infer<typeof messageMetaSchema>;
```

### 5. Migration Strategy

Create migration `0010_enhance_chat_sessions.sql`:
- Handle enum change carefully (PostgreSQL enum alterations are tricky)
- Add nullable columns first, then consider defaults
- Ensure rollback is possible

## Review References

This task addresses items from:
- **UX Review (E04-T001-spec.md lines 788-839)**: Paused state, soft delete, session metadata
- **Architecture Review (E04-T001-spec.md lines 1104-1240)**: YAGNI, Zod validation, type safety
- **Code Review (E04-T001-code-review.md lines 433-488)**: Deferred recommendations

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-14 | DRAFT | analyst | Task created from E04-T001 review follow-up analysis |
| 2026-01-14 | ANALYZED | analyst | Implementation spec created with detailed technical design for enum alteration, soft delete, session metadata, and Zod schema |
| 2026-01-14 | TESTS_READY | developer | Tests written for message-meta schema and updated chat-sessions schema. Tests currently fail (red phase) due to missing implementation: new fields (title, lastActivityAt, deletedAt) don't exist yet, paused state still in enum, message-meta schema not created |
| 2026-01-14 | IMPLEMENTED | developer | Implementation complete. Created message-meta Zod schema with extraction support. Updated chat-sessions schema to remove "paused" state and add title, lastActivityAt, deletedAt fields. Created migration 0010_enhance_chat_sessions.sql. All 66 tests pass. TypeScript and linting checks pass. |
| 2026-01-14 | QA_REVIEW | reviewer | Code review complete. APPROVED with excellent quality rating. All 10 acceptance criteria met. Zero defects found. Comprehensive test coverage (39 message-meta tests, 27 chat-sessions tests). Proper PostgreSQL enum alteration strategy. Migration includes data safety measures and backfill. Type safety throughout with Zod + TypeScript. Documentation excellent. Ready for QA validation. |
| 2026-01-14 | INTEGRATION_TESTING | qa | QA validation complete. PASS with zero defects. All automated checks pass (1306 tests, build, typecheck). All 10 acceptance criteria verified. Excellent code quality: proper PostgreSQL enum migration, comprehensive documentation, thorough test coverage (66 tests). Implementation production-ready. Report: backlog/docs/reviews/E04/E04-T009-qa-report.md. Ready for integration testing with real infrastructure. |
| 2026-01-14 | DOCS_UPDATE | integration-test | Integration testing complete. PASS with all 10 acceptance criteria validated against real Docker infrastructure (PostgreSQL 16, Redis 7). All schema changes applied successfully: enum alteration (paused removed), soft delete (deleted_at + index), session metadata (title, last_activity_at), and message meta JSONB storage. Manual migration required for enum (drizzle-kit push limitation documented). Production-ready. Report: backlog/docs/reviews/E04/E04-T009-integration-report.md |

## Documentation Updates

**Date:** 2026-01-14
**Updated By:** writer agent

### KB Documentation

1. **apps/docs/src/database/concepts/chat-schema.md** (created/updated)
   - Comprehensive KB page documenting chat sessions and messages schemas
   - Documents both E04-T001 initial implementation AND E04-T009 enhancements
   - **E04-T009 specific content:**
     - Session lifecycle updated to `active` → `completed` (removed paused state)
     - Soft delete pattern with `deleted_at` field
     - Session metadata fields: `title` and `lastActivityAt`
     - PostgreSQL enum alteration strategy documented with warning callout
     - Query patterns for soft delete filtering
     - Migration history section noting both 0008 and 0010 migrations
   - Set `related_code` frontmatter including all related schema and migration files
   - Set `last_verified: 2026-01-14`
   - Set `implements_task: E04-T001` (original implementation task)

2. **apps/docs/src/api/patterns/validation.md** (updated)
   - Added comprehensive "Message Meta Validation" section
   - Documents messageMetaSchema with extractionSchema
   - **E04-T009 specific content:**
     - Complete schema definition from packages/core/src/schemas/message-meta.schema.ts
     - Explanation of `.passthrough()` for extensibility
     - Validation helpers: parseMessageMeta, safeParseMessageMeta
     - Example usage for storing and extracting validated metadata
     - Cross-reference to chat-schema.md for database integration
   - Updated `related_code` frontmatter to include message-meta.schema.ts
   - Updated `last_verified: 2026-01-14`

### Legacy Documentation

1. **docs/ARCHITECTURE.md** (updated)
   - **Chat Sessions section:**
     - Status updated to "✅ Implemented (E04-T001, E04-T009)"
     - State lifecycle updated: removed "paused", now `active` → `completed`
     - Added soft delete support bullet point
     - Added session metadata bullet point
     - Updated key fields to include `title`, `last_activity_at`, `deleted_at`
     - Added `chat_sessions_deleted_at_idx` to indexes list
     - Updated migrations to list both 0008 and 0010
     - Added note explaining paused state removal per YAGNI
   - **Messages section:**
     - Status updated to "✅ Implemented (E04-T001, E04-T009)"
     - Added "Meta Validation" bullet point
     - Added validation schema reference
     - Expanded meta field documentation with common fields list
     - Updated metadata examples to include extractions with full structure
     - Noted `.passthrough()` usage for additional custom fields

### Summary

Documentation comprehensively covers E04-T009 enhancements:

**New Concepts Documented:**
- PostgreSQL enum alteration strategy (rename-recreate-drop pattern)
- Soft delete pattern for chat sessions
- Session metadata for UX improvements (title, last activity)
- Message meta Zod validation with .passthrough() for extensibility
- Extraction schema for module-generated structured data

**KB Coverage:**
- database/concepts/chat-schema.md: Full schema documentation with E04-T009 changes
- api/patterns/validation.md: Zod validation patterns including message meta

**Legacy Coverage:**
- ARCHITECTURE.md: High-level overview updated with all E04-T009 changes

**Verification:**
- ✅ Build check passed: KB builds successfully with no broken links
- ✅ All cross-references validated
- ✅ Frontmatter fields properly set (related_code, last_verified)
- ✅ Dead links fixed (removed references to non-existent pages)

All implementations follow existing database and validation conventions documented in CONVENTIONS.md.

## Reviews

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:** 2026-01-14
- **Verdict:** ✅ APPROVED
- **Notes:** Excellent implementation quality. All acceptance criteria met. Zero defects. Comprehensive tests (66 total). Proper migration strategy with data safety. Review: backlog/docs/reviews/E04/E04-T009-code-review.md

### QA Review
- **Reviewer:** qa
- **Date:** 2026-01-14
- **Verdict:** ✅ PASS
- **Notes:** All 10 acceptance criteria verified. 1306 tests passing (100% pass rate). Zero defects. Excellent implementation quality with proper PostgreSQL enum migration strategy, comprehensive documentation, and thorough test coverage. Production-ready. Report: backlog/docs/reviews/E04/E04-T009-qa-report.md

### Integration Test Review
- **Reviewer:** integration-test
- **Date:** 2026-01-14
- **Verdict:** ✅ PASS
- **Notes:** All 10 acceptance criteria validated against real Docker infrastructure (PostgreSQL 16, Redis 7). Schema changes successfully applied: enum alteration (paused removed), soft delete with indexed deleted_at, session metadata (title, last_activity_at), message meta JSONB storage. Manual migration required for enum removal (drizzle-kit push limitation). Production-ready. Report: backlog/docs/reviews/E04/E04-T009-integration-report.md
