---
id: "E04-T009"
title: "Chat schema enhancements (E04-T001 follow-up)"
status: "todo"
priority: "medium"
labels: [backend, database, follow-up]
assignee: ""
workflow_state: "ANALYZED"
epic: "E04"
depends_on: ["E04-T001"]
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-14T00:00:00Z"
updated_at: "2026-01-14T00:00:00Z"
spec_file: "backlog/docs/specs/E04/E04-T009-spec.md"
test_files: []
code_files: []
pr_url: ""
---

# E04-T009: Chat schema enhancements (E04-T001 follow-up)

## Description

Address deferred recommendations from E04-T001 code review and architecture review. These improvements enhance type safety, data integrity, and UX of the chat system.

**Source:** E04-T001 reviews identified these as "Should Address" or "Consider" items that were intentionally deferred during initial implementation.

## Acceptance Criteria

### Schema Changes
- [ ] AC1: Remove "paused" state from session_state enum (YAGNI cleanup)
- [ ] AC2: Add `deleted_at` timestamp to chat_sessions for soft delete support
- [ ] AC3: Add `title` field (varchar 200) to chat_sessions for user-facing session names
- [ ] AC4: Add `last_activity_at` timestamp to chat_sessions for "last active" display
- [ ] AC5: Migration file 0010_enhance_chat_sessions.sql with enum alteration and new columns

### Type Safety
- [ ] AC6: Create Zod schema for message meta field in `@raptscallions/core/schemas`
- [ ] AC7: Export `MessageMeta` type inferred from Zod schema
- [ ] AC8: Document common meta field patterns (tokens, model, latency_ms, extractions)

### Testing
- [ ] AC9: Tests verify soft delete behavior (deleted sessions excluded from queries)
- [ ] AC10: Tests verify meta field validation with Zod schema

## Technical Notes

### 1. Remove "paused" State

The "paused" state was speculatively added but has no defined user flow or UI. Per YAGNI principle, remove it:

```sql
-- Requires careful migration: update any 'paused' rows to 'active' first
UPDATE chat_sessions SET state = 'active' WHERE state = 'paused';
-- Then recreate enum without 'paused'
ALTER TYPE session_state RENAME TO session_state_old;
CREATE TYPE session_state AS ENUM ('active', 'completed');
ALTER TABLE chat_sessions ALTER COLUMN state TYPE session_state USING state::text::session_state;
DROP TYPE session_state_old;
```

**Note:** If any sessions exist with 'paused' state, they must be migrated first.

### 2. Soft Delete Support

Add soft delete to support "Delete conversation" feature without losing data:

```typescript
// chat-sessions.ts
deletedAt: timestamp("deleted_at", { withTimezone: true }),
```

Query pattern:
```typescript
const activeSessions = await db.query.chatSessions.findMany({
  where: isNull(chatSessions.deletedAt),
});
```

### 3. Session Metadata Fields

```typescript
// chat-sessions.ts - add fields
title: varchar("title", { length: 200 }),
lastActivityAt: timestamp("last_activity_at", { withTimezone: true }),
```

- `title`: User-editable session name (e.g., "Math homework help - Jan 14")
- `lastActivityAt`: Auto-updated on each message, enables "Last active 5 min ago" display

### 4. Message Meta Zod Schema

```typescript
// packages/core/src/schemas/message-meta.schema.ts
import { z } from "zod";

export const messageMetaSchema = z.object({
  tokens: z.number().int().positive().optional(),
  model: z.string().optional(),
  latency_ms: z.number().positive().optional(),
  extractions: z.array(z.object({
    type: z.string(),
    value: z.unknown(),
  })).optional(),
}).passthrough(); // Allow additional fields for extensibility

export type MessageMeta = z.infer<typeof messageMetaSchema>;
```

### 5. Migration Strategy

Create migration `0010_enhance_chat_sessions.sql`:
- Handle enum change carefully (PostgreSQL enum alterations are tricky)
- Add nullable columns first, then consider defaults
- Ensure rollback is possible

## Review References

This task addresses items from:
- **UX Review (E04-T001-spec.md lines 788-839)**: Paused state, soft delete, session metadata
- **Architecture Review (E04-T001-spec.md lines 1104-1240)**: YAGNI, Zod validation, type safety
- **Code Review (E04-T001-code-review.md lines 433-488)**: Deferred recommendations

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-14 | DRAFT | analyst | Task created from E04-T001 review follow-up analysis |
| 2026-01-14 | ANALYZED | analyst | Implementation spec created with detailed technical design for enum alteration, soft delete, session metadata, and Zod schema |

## Reviews

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
