---
id: E04-T001
title: Sessions and messages schemas
status: done
priority: critical
labels:
  - backend
  - database
assignee: ""
workflow_state: DONE
epic: E04
depends_on: []
blocks:
  - E04-T004
  - E04-T005
breakpoint: false
assigned_agent: writer
created_at: 2026-01-12T00:00:00Z
updated_at: 2026-01-11T22:51:54.251Z
spec_file: backlog/docs/specs/E04/E04-T001-spec.md
test_files:
  - packages/db/src/__tests__/schema/chat-sessions.test.ts
  - packages/db/src/__tests__/schema/messages.test.ts
code_files:
  - packages/db/src/schema/chat-sessions.ts
  - packages/db/src/schema/messages.ts
  - packages/db/src/migrations/0008_create_chat_sessions_messages.sql
  - packages/db/src/schema/index.ts
pr_url: ""
started_at: 2026-01-11T22:30:56.724Z
---

# E04-T001: Sessions and messages schemas

## Description

Define Drizzle schemas for chat sessions (user + tool + state) and messages (conversation history with roles).

## Acceptance Criteria

- [ ] AC1: sessions table with id, tool_id, user_id, state, timestamps
- [ ] AC2: session_state enum: 'active', 'paused', 'completed'
- [ ] AC3: messages table with id, session_id, role, content, seq, created_at
- [ ] AC4: message_role enum: 'user', 'assistant', 'system'
- [ ] AC5: Foreign keys with CASCADE delete
- [ ] AC6: Index on (session_id, seq) for message ordering
- [ ] AC7: Migration file 0008_create_sessions_messages.sql
- [ ] AC8: TypeScript types exported
- [ ] AC9: Relations defined
- [ ] AC10: Tests verify constraints and ordering

## Technical Notes

```typescript
export const sessionStateEnum = pgEnum('session_state', ['active', 'paused', 'completed']);
export const messageRoleEnum = pgEnum('message_role', ['user', 'assistant', 'system']);

export const sessions = pgTable('sessions', {
  id: uuid('id').primaryKey().defaultRandom(),
  toolId: uuid('tool_id').notNull().references(() => tools.id, { onDelete: 'restrict' }),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  state: sessionStateEnum('state').notNull().default('active'),
  startedAt: timestamp('started_at', { withTimezone: true }).defaultNow().notNull(),
  endedAt: timestamp('ended_at', { withTimezone: true }),
});

export const messages = pgTable('messages', {
  id: uuid('id').primaryKey().defaultRandom(),
  sessionId: uuid('session_id').notNull().references(() => sessions.id, { onDelete: 'cascade' }),
  role: messageRoleEnum('role').notNull(),
  content: text('content').notNull(),
  seq: integer('seq').notNull(),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  meta: jsonb('meta').default('{}'),
}, (table) => ({
  sessionSeqIdx: index('messages_session_seq_idx').on(table.sessionId, table.seq),
}));
```

## Documentation Updates

**Date:** 2026-01-14
**Updated By:** writer agent

### KB Documentation

1. **apps/docs/src/database/concepts/chat-schema.md** (new file)
   - Created comprehensive KB page documenting chat sessions and messages schemas
   - Covers E04-T001 initial implementation and E04-T009 enhancements
   - Includes schema definitions, field descriptions, lifecycle states, foreign key behaviors
   - Documents soft delete pattern, session metadata fields, message sequencing
   - Provides query patterns and example usage
   - Cross-references to related KB pages (validation patterns, tools schema)
   - Set `related_code` frontmatter for staleness tracking
   - Set `last_verified: 2026-01-14`
   - Set `implements_task: E04-T001`

2. **apps/docs/src/api/patterns/validation.md** (updated)
   - Added "Message Meta Validation" section documenting messageMetaSchema
   - Includes schema definition, .passthrough() usage for extensibility
   - Provides validation helpers (parseMessageMeta, safeParseMessageMeta)
   - Example usage for storing and extracting validated metadata
   - Added cross-reference to chat-schema.md
   - Updated `related_code` frontmatter to include message-meta.schema.ts
   - Updated `last_verified: 2026-01-14`

### Legacy Documentation

1. **docs/ARCHITECTURE.md** (updated sections for Chat Sessions and Messages)
   - Updated Chat Sessions section with E04-T009 changes:
     - Changed state lifecycle: removed "paused", now `active` → `completed`
     - Added soft delete support (`deleted_at`)
     - Added session metadata fields (`title`, `last_activity_at`)
     - Added new index `chat_sessions_deleted_at_idx`
     - Updated status to "✅ Implemented (E04-T001, E04-T009)"
     - Added migrations list (0008 initial, 0010 enhancements)
     - Added note explaining paused state removal
   - Updated Messages section with E04-T009 changes:
     - Added Meta Validation bullet point
     - Added Validation Schema reference (`packages/core/src/schemas/message-meta.schema.ts`)
     - Expanded meta field documentation with common fields and .passthrough() note
     - Updated metadata examples to include extractions
     - Updated status to "✅ Implemented (E04-T001, E04-T009)"

### Summary

Documentation is now comprehensive and synchronized across both KB and legacy docs:

**KB Pages (apps/docs/src/):**
- New dedicated page for chat schema concepts in database domain
- Updated validation patterns page with message meta schema
- Both pages have staleness tracking enabled (`related_code`, `last_verified`)
- Cross-references between related pages

**Legacy Docs (docs/):**
- ARCHITECTURE.md updated with complete E04-T009 changes
- High-level overview with cross-references to KB for details
- No duplication of code examples (KB has detailed examples)

**Verification:**
- ✅ Build check passed: KB builds successfully with no broken links
- ✅ All cross-references validated
- ✅ Frontmatter fields properly set (related_code, last_verified, implements_task)

No changes needed to CONVENTIONS.md as all implementations follow existing database and validation conventions documented there.

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-12 | DRAFT | pm | Task created |
| 2026-01-12 | ANALYZED | analyst | Spec created: E04-T001-spec.md |
| 2026-01-12 | PLAN_REVIEW | designer | UX review completed, approved with recommendations |
| 2026-01-11 22:37 | PLAN_REVIEW → APPROVED | architect | Architecture review completed |
| 2026-01-12 07:40 | APPROVED → TESTS_READY | developer | Tests written (TDD red phase) - 2 test files created |
| 2026-01-11 22:44 | TESTS_READY → IMPLEMENTING | developer |
| 2026-01-11 22:45 | IMPLEMENTED → CODE_REVIEW | developer |
| 2026-01-12 07:45 | CODE_REVIEW → QA_REVIEW | reviewer | Code review completed: APPROVED. All critical requirements met, 44/44 tests passing |
| 2026-01-12 07:50 | QA_REVIEW → DOCS_UPDATE | qa | QA validation completed: PASSED - All acceptance criteria met, 44/44 tests passing |
| 2026-01-12 08:15 | DOCS_UPDATE → DONE | writer | Documentation updated: ARCHITECTURE.md updated with chat sessions and messages entities |


##ws

### UX Review
- **Reviewer:** designer
- **Date:** 2026-01-12
- **Verdict:** APPROVED with Recommendations
- **Notes:** Data model is solid (8.5/10). Must address: naming inconsistency with auth sessions, add seq unique constraint. Should address: remove "paused" state (YAGNI), add meta Zod schemas. See full review in spec file.

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:** 2026-01-12
- **Verdict:** APPROVED (Ready for QA)
- **Notes:** Excellent implementation. All critical architecture requirements met, including unique constraint on (session_id, seq). 44/44 tests passing, no TypeScript errors. Quality score: 9.5/10. See full review in backlog/docs/reviews/E04/E04-T001-code-review.md

### QA Review
- **Reviewer:** qa
- **Date:** 2026-01-12
- **Verdict:** PASSED (Ready for Production)
- **Notes:** All 10 acceptance criteria met. 44/44 tests passing. Excellent implementation with unique constraint on message sequencing. Quality score: 9.5/10. See full report in backlog/docs/reviews/E04/E04-T001-qa-report.md
| 2026-01-12 07:50 | QA_REVIEW → DOCS_UPDATE | qa | QA validation completed: PASSED - All acceptance criteria met, 44/44 tests passing |
