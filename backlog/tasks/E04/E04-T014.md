---
id: "E04-T014"
title: "Integrate credentials with OpenRouterClient"
status: "todo"
priority: "critical"
labels: [backend, ai, refactor]
assignee: ""
workflow_state: "DRAFT"
epic: "E04"
depends_on: ["E04-T012", "E04-T002"]
blocks: ["E04-T005", "E04-T015"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-16T00:00:00Z"
updated_at: "2026-01-16T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E04-T014: Integrate Credentials with OpenRouterClient

## Description

Update the OpenRouterClient and chat flow to use per-group credentials from the database instead of a global environment variable. This connects the credential system (E04-T012, E04-T013) with the AI client (E04-T002).

**Key Changes:**
- Chat service fetches credential for user's group before calling AI
- OpenRouterClient accepts credential at call time (not just construction)
- `AiNotConfiguredError` returned when group has no credential
- Update `last_used_at` after successful API calls

## Acceptance Criteria

### Client Factory
- [ ] AC1: Create `getAiClientForGroup(groupId)` factory function
- [ ] AC2: Factory fetches active credential from CredentialService
- [ ] AC3: Factory creates OpenRouterClient with decrypted API key
- [ ] AC4: Throws `AiNotConfiguredError` if no credential exists

### OpenRouterClient Updates
- [ ] AC5: Remove singleton that reads from env (or make it optional fallback)
- [ ] AC6: Constructor requires explicit apiKey (no auto-reading from env)
- [ ] AC7: Add optional `credentialId` to track which credential was used

### Chat Service Integration
- [ ] AC8: Update chat message flow to use `getAiClientForGroup()`
- [ ] AC9: Pass user's groupId to get appropriate credential
- [ ] AC10: Call `credentialService.updateLastUsed()` after successful response

### Error Handling
- [ ] AC11: `AiNotConfiguredError` returns 424 with user-friendly message
- [ ] AC12: Error message guides user to settings page

### Testing
- [ ] AC13: Tests verify correct credential is fetched per group
- [ ] AC14: Tests verify AiNotConfiguredError when no credential
- [ ] AC15: Tests verify last_used_at is updated after use

## Technical Notes

### Client Factory

```typescript
// packages/ai/src/factory.ts
import { OpenRouterClient } from "./client.js";
import { credentialService } from "@raptscallions/api/services";
import { AiNotConfiguredError } from "@raptscallions/core/errors";

/**
 * Get an AI client configured for a specific group
 *
 * @param groupId - The group to get credentials for
 * @returns Configured OpenRouterClient
 * @throws AiNotConfiguredError if group has no active credential
 */
export async function getAiClientForGroup(
  groupId: string
): Promise<{ client: OpenRouterClient; credentialId: string }> {
  // Fetch and decrypt credential
  const credential = await credentialService.getActiveForGroup(groupId);

  // Create client with group's API key
  const client = new OpenRouterClient({
    apiKey: credential.apiKey,
    // Use default baseURL and model from config
  });

  return {
    client,
    credentialId: credential.id,
  };
}

/**
 * Provider-agnostic factory for future expansion
 */
export async function getAiClient(
  groupId: string,
  provider: string = "openrouter"
): Promise<{ client: AiClient; credentialId: string }> {
  const credential = await credentialService.getActiveForGroup(groupId, provider);

  switch (provider) {
    case "openrouter":
      return {
        client: new OpenRouterClient({ apiKey: credential.apiKey }),
        credentialId: credential.id,
      };
    // Future: case 'anthropic': ...
    default:
      throw new Error(`Unsupported AI provider: ${provider}`);
  }
}
```

### Updated OpenRouterClient Constructor

```typescript
// packages/ai/src/client.ts (updated)

export class OpenRouterClient {
  private client: OpenAI;
  private defaultModel: string;

  constructor(options: {
    apiKey: string;  // Now required, not optional
    baseURL?: string;
    defaultModel?: string;
    timeout?: number;
    maxRetries?: number;
  }) {
    // apiKey is now required - no fallback to env
    if (!options.apiKey) {
      throw new Error("apiKey is required for OpenRouterClient");
    }

    this.client = new OpenAI({
      apiKey: options.apiKey,
      baseURL: options.baseURL ?? aiConfig.AI_GATEWAY_URL,
      timeout: options.timeout ?? aiConfig.AI_REQUEST_TIMEOUT_MS,
      maxRetries: options.maxRetries ?? aiConfig.AI_MAX_RETRIES,
    });

    this.defaultModel = options.defaultModel ?? aiConfig.AI_DEFAULT_MODEL;
  }

  // ... rest unchanged
}

// Remove or deprecate the global singleton
// export const openRouterClient = ...
```

### Chat Service Integration

```typescript
// apps/api/src/services/chat.service.ts (updated)

import { getAiClientForGroup } from "@raptscallions/ai";
import { credentialService } from "./credential.service.js";

export class ChatService {
  /**
   * Send a message in a chat session
   */
  async *sendMessage(
    sessionId: string,
    userMessage: string,
    userId: string
  ): AsyncGenerator<StreamChunk> {
    // Get session with user's group
    const session = await this.getSession(sessionId);
    const user = await this.getUser(userId);

    // Get AI client for user's group
    const { client, credentialId } = await getAiClientForGroup(user.groupId);

    // Build context and call AI
    const context = await this.buildContext(session, userMessage);

    try {
      for await (const chunk of client.streamChat(context.messages, {
        model: context.model,
      })) {
        yield chunk;

        // On completion, update last used
        if (chunk.type === "done") {
          await credentialService.updateLastUsed(credentialId);
        }
      }
    } catch (error) {
      // Re-throw with context
      throw error;
    }
  }
}
```

### Error Response

```typescript
// When AiNotConfiguredError is thrown, return:
{
  "error": "AI is not configured for this group. Please add an API key in settings.",
  "code": "AI_NOT_CONFIGURED",
  "statusCode": 424
}
```

### Migration Path for Existing Code

The existing `openRouterClient` singleton reads from env. Options:

1. **Remove it entirely** - Force all callers to use factory
2. **Keep as development fallback** - For local dev without DB setup
3. **Deprecate with warning** - Log warning when singleton is used

Recommend option 1 (remove) for clarity. Development can use a test group with a credential.

### Configuration Changes

```typescript
// packages/ai/src/config.ts (updated)

// These are now optional (only used if no credential provided)
export const aiConfig = {
  AI_GATEWAY_URL: env.AI_GATEWAY_URL ?? "https://openrouter.ai/api/v1",
  AI_DEFAULT_MODEL: env.AI_DEFAULT_MODEL ?? "anthropic/claude-3-haiku-20240307",
  AI_REQUEST_TIMEOUT_MS: parseInt(env.AI_REQUEST_TIMEOUT_MS ?? "120000"),
  AI_MAX_RETRIES: parseInt(env.AI_MAX_RETRIES ?? "2"),

  // API key is NO LONGER read from env here
  // It comes from per-group credentials
};
```

### Sequence Diagram

```
User sends message
       │
       ▼
ChatService.sendMessage(sessionId, message, userId)
       │
       ▼
Get user's groupId from session/user
       │
       ▼
getAiClientForGroup(groupId)
       │
       ▼
credentialService.getActiveForGroup(groupId)
       │
       ├── No credential? → throw AiNotConfiguredError
       │
       ▼
Decrypt API key from database
       │
       ▼
Create OpenRouterClient with decrypted key
       │
       ▼
client.streamChat(messages)
       │
       ▼
Stream response to user
       │
       ▼
credentialService.updateLastUsed(credentialId)
```

## Out of Scope

- Caching decrypted credentials (evaluate if needed for performance)
- Multiple providers in single request
- Credential fallback chain (try provider A, then B)
- Frontend changes

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-16 | DRAFT | pm | Task created to integrate credentials with AI client |

## Reviews

### Plan Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**
