---
id: "E04-T015"
title: "Validate AI client with real API keys"
status: "todo"
priority: "high"
labels: [backend, ai, validation, integration]
assignee: ""
workflow_state: "DRAFT"
epic: "E04"
depends_on: ["E04-T014"]
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-16T00:00:00Z"
updated_at: "2026-01-16T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E04-T015: Validate AI Client with Real API Keys

## Description

This is the **capstone validation task** for the AI gateway. After implementing:
- E04-T012: Credentials schema and encryption
- E04-T013: Credential management service and API
- E04-T014: OpenRouterClient integration with credentials

This task validates the **complete flow** works end-to-end with real API keys:
1. Store an encrypted API key in the database via the credential service
2. Retrieve and decrypt it
3. Make actual API calls to OpenRouter
4. Validate streaming, usage metadata, and error handling

**Why This Matters:**
- Mock tests verify logic but not real-world behavior
- OpenRouter's API may have quirks not covered by mocks
- Encryption/decryption must work correctly with real keys
- This proves the entire credential → client → API flow works

## Acceptance Criteria

### Full Flow Validation
- [ ] AC1: Test creates a credential via CredentialService
- [ ] AC2: Test retrieves credential and creates OpenRouterClient
- [ ] AC3: Streaming chat completion works with database-stored key
- [ ] AC4: Usage metadata (prompt_tokens, completion_tokens) is returned
- [ ] AC5: Test with at least 2 different models via OpenRouter

### Error Handling
- [ ] AC6: Invalid/expired API key returns proper error
- [ ] AC7: Missing credential for group throws AiNotConfiguredError
- [ ] AC8: Decryption failure is handled gracefully

### Integration Test Setup
- [ ] AC9: Create `packages/ai/src/__tests__/integration/` directory
- [ ] AC10: Tests are skipped by default (require explicit flag)
- [ ] AC11: Create npm script `pnpm test:ai:live`
- [ ] AC12: Tests timeout gracefully (don't hang on network issues)

### Documentation
- [ ] AC13: README documents how to run live validation
- [ ] AC14: Document required environment variables

## Technical Notes

### Test Structure

```typescript
// packages/ai/src/__tests__/integration/credentials-flow.integration.test.ts
import { describe, it, expect, beforeAll, afterAll } from 'vitest';
import { CredentialService } from '@raptscallions/api/services';
import { OpenRouterClient } from '../../client.js';
import { db } from '@raptscallions/db';

const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;
const describeIf = OPENROUTER_API_KEY ? describe : describe.skip;

describeIf('Full Credential Flow Integration', () => {
  let credentialService: CredentialService;
  let testGroupId: string;
  let testCredentialId: string;

  beforeAll(async () => {
    // Setup test group and credential service
    credentialService = new CredentialService(db);
    testGroupId = await createTestGroup();

    // Store real API key via service (encrypted)
    const cred = await credentialService.create({
      groupId: testGroupId,
      provider: 'openrouter',
      apiKey: OPENROUTER_API_KEY!, // Will be encrypted
      createdBy: 'test-admin',
    });
    testCredentialId = cred.id;
  });

  afterAll(async () => {
    // Cleanup
    await credentialService.delete(testCredentialId);
    await deleteTestGroup(testGroupId);
  });

  it('should complete chat using database-stored credential', async () => {
    // Retrieve credential (decrypts automatically)
    const credential = await credentialService.getActiveForGroup(testGroupId);

    // Create client with decrypted key
    const client = new OpenRouterClient({
      apiKey: credential.apiKey,
      defaultModel: 'anthropic/claude-3-haiku-20240307',
    });

    const result = await client.chat([
      { role: 'user', content: 'Say "integration test passed"' }
    ]);

    expect(result.content.toLowerCase()).toContain('integration');
    expect(result.usage.totalTokens).toBeGreaterThan(0);
  }, 30000);

  it('should stream using database-stored credential', async () => {
    const credential = await credentialService.getActiveForGroup(testGroupId);
    const client = new OpenRouterClient({ apiKey: credential.apiKey });

    const chunks: string[] = [];
    for await (const chunk of client.streamChat([
      { role: 'user', content: 'Count from 1 to 3' }
    ])) {
      if (chunk.type === 'content') chunks.push(chunk.content);
    }

    expect(chunks.length).toBeGreaterThan(0);
  }, 30000);

  it('should throw AiNotConfiguredError for group without credential', async () => {
    const groupWithoutKey = await createTestGroup();

    await expect(
      credentialService.getActiveForGroup(groupWithoutKey)
    ).rejects.toThrow('AiNotConfiguredError');

    await deleteTestGroup(groupWithoutKey);
  });
});
```

### Environment Variables

```bash
# For live integration tests only (not needed in production)
OPENROUTER_API_KEY=sk-or-v1-xxxxx  # Your real key for testing

# Required for encryption (production and tests)
CREDENTIAL_ENCRYPTION_KEY=<32-byte-hex>  # From: openssl rand -hex 32
```

### Running Tests

```bash
# Run full integration test (requires real API key)
OPENROUTER_API_KEY=sk-or-v1-xxx pnpm test:ai:live

# This will:
# 1. Create a test group
# 2. Store your API key encrypted in DB
# 3. Retrieve and decrypt it
# 4. Make real API calls
# 5. Clean up test data
```

### Cost Considerations

- Uses cheapest models (Claude 3 Haiku)
- Minimal prompts ("say hello", "count to 3")
- Run manually, not in CI
- Estimated cost: ~$0.01-0.05 per run

## Out of Scope

- CI integration (requires secrets management)
- Performance benchmarking
- Load testing
- Testing every OpenRouter model

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-16 | DRAFT | pm | Task created as capstone validation for credential flow |

## Reviews

### Plan Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:**
- **Date:**
- **Verdict:**
- **Notes:**
