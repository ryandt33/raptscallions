---
id: E03-T009
title: Extend core entity schemas with metadata fields
status: draft
priority: high
labels:
  - backend
  - database
  - schema-enhancement
assignee: ""
workflow_state: DRAFT
epic: E03
depends_on:
  - E03-T001
  - E03-T002
blocks: []
breakpoint: false
created_at: 2026-01-13T00:00:00Z
updated_at: 2026-01-13T00:00:00Z
---

# E03-T009: Extend core entity schemas with metadata fields

## Description

Add metadata and profile fields to Users, Groups, Classes, Tools, and ClassMembers tables to support better UX, discovery, and analytics. These fields are lightweight additions that don't require file storage infrastructure.

## Acceptance Criteria

### Users Table Extensions
- [ ] AC1: Add `bio` (text, nullable) for user biography
- [ ] AC2: Add `display_name` (varchar 100, nullable) for preferred display name
- [ ] AC3: Add `timezone` (varchar 50, nullable) for user timezone preference
- [ ] AC4: Add `locale` (varchar 10, nullable, default 'en-US') for language preference
- [ ] AC5: Add `last_login_at` (timestamp with timezone, nullable) for login tracking

### Groups Table Extensions
- [ ] AC6: Add `description` (text, nullable) for group description

### Classes Table Extensions
- [ ] AC7: Add `description` (text, nullable) for class description
- [ ] AC8: Add `code` (varchar 50, nullable) for class code (e.g., "ALG1-03")
- [ ] AC9: Add `start_date` (timestamp with timezone, nullable) for class start date
- [ ] AC10: Add `end_date` (timestamp with timezone, nullable) for class end date
- [ ] AC11: Add index on `code` for lookup performance

### Tools Table Extensions
- [ ] AC12: Add `description` (text, nullable) for tool description (browsing/discovery)
- [ ] AC13: Add `usage_count` (integer, not null, default 0) for popularity tracking
- [ ] AC14: Add `tags` (jsonb, nullable) for categorization/search
- [ ] AC15: Add index on `tags` using GIN for efficient tag queries

### ClassMembers Table Extensions
- [ ] AC16: Add `enrolled_at` (timestamp with timezone, not null, default now()) for enrollment timestamp
- [ ] AC17: Add `dropped_at` (timestamp with timezone, nullable) for soft removal tracking
- [ ] AC18: Add `status` enum ('active', 'dropped', 'transferred') for enrollment status
- [ ] AC19: Add `notes` (text, nullable) for admin notes about enrollment

### Migrations
- [ ] AC20: Migration 0010_extend_users.sql with all user fields
- [ ] AC21: Migration 0011_extend_groups.sql with all group fields
- [ ] AC22: Migration 0012_extend_classes.sql with all class fields and index
- [ ] AC23: Migration 0013_extend_tools.sql with all tool fields and GIN index
- [ ] AC24: Migration 0014_extend_class_members.sql with all class member fields and enum

### Testing
- [ ] AC25: All existing tests continue to pass (no breaking changes)
- [ ] AC26: Tests verify new fields are nullable/have correct defaults
- [ ] AC27: Tests verify indexes exist and constraints work
- [ ] AC28: Tests verify enum values for class_member status

## Technical Notes

### Migration Strategy

All new fields are **nullable** or have **defaults** to ensure zero-downtime deployments and backward compatibility with existing data.

**Migration pattern:**
```sql
-- 0010_extend_users.sql
ALTER TABLE "users" ADD COLUMN "bio" text;
ALTER TABLE "users" ADD COLUMN "display_name" varchar(100);
ALTER TABLE "users" ADD COLUMN "timezone" varchar(50);
ALTER TABLE "users" ADD COLUMN "locale" varchar(10) DEFAULT 'en-US';
ALTER TABLE "users" ADD COLUMN "last_login_at" timestamp with time zone;
```

### Schema Updates

**Users:**
```typescript
bio: text("bio"),
displayName: varchar("display_name", { length: 100 }),
timezone: varchar("timezone", { length: 50 }),
locale: varchar("locale", { length: 10 }).default("en-US"),
lastLoginAt: timestamp("last_login_at", { withTimezone: true }),
```

**Groups:**
```typescript
description: text("description"),
```

**Classes:**
```typescript
description: text("description"),
code: varchar("code", { length: 50 }),
startDate: timestamp("start_date", { withTimezone: true }),
endDate: timestamp("end_date", { withTimezone: true }),
```

With index:
```typescript
(table) => ({
  groupIdIdx: index("classes_group_id_idx").on(table.groupId),
  codeIdx: index("classes_code_idx").on(table.code), // NEW
})
```

**Tools:**
```typescript
description: text("description"),
usageCount: integer("usage_count").notNull().default(0),
tags: jsonb("tags"),
```

With GIN index for JSONB tag queries:
```typescript
(table) => ({
  nameVersionUnique: unique().on(table.name, table.version),
  groupIdIdx: index("tools_group_id_idx").on(table.groupId),
  createdByIdx: index("tools_created_by_idx").on(table.createdBy),
  tagsGinIdx: index("tools_tags_gin_idx").using("gin", table.tags), // NEW
})
```

**ClassMembers:**
```typescript
export const classMemberStatusEnum = pgEnum("class_member_status", [
  "active",
  "dropped",
  "transferred",
]);

// In classMembers table:
enrolledAt: timestamp("enrolled_at", { withTimezone: true })
  .defaultNow()
  .notNull(),
droppedAt: timestamp("dropped_at", { withTimezone: true }),
status: classMemberStatusEnum("status").notNull().default("active"),
notes: text("notes"),
```

### Testing Strategy

Update existing tests to handle new nullable fields:
```typescript
// Existing tests should still pass
const user = createMockUser({ email: "test@example.com" });
// user.bio is undefined, displayName is undefined, etc.

// New tests for new fields
it("should allow setting bio and displayName", () => {
  const user = createMockUser({
    bio: "Math teacher with 10 years experience",
    displayName: "Ms. Smith",
  });
  expect(user.bio).toBe("Math teacher with 10 years experience");
});

it("should default locale to en-US", () => {
  const user = createMockUser({});
  expect(user.locale).toBe("en-US");
});
```

### Index Performance Notes

**Classes code index:**
- Class codes are frequently used in UI for navigation and search
- Index supports fast lookup by code

**Tools tags GIN index:**
- GIN (Generalized Inverted Index) optimized for JSONB containment queries
- Enables fast tag-based filtering: `WHERE tags @> '["essay"]'`
- Critical for tool discovery/browsing UX

### Type Safety

All new fields will have proper TypeScript types via Drizzle inference:
```typescript
export type User = typeof users.$inferSelect;
// Now includes: bio?, displayName?, timezone?, locale, lastLoginAt?

export type Tool = typeof tools.$inferSelect;
// Now includes: description?, usageCount, tags?
```

### Backward Compatibility

All changes are non-breaking:
- Existing INSERT operations work without new fields
- Existing SELECT operations return `null` for new fields
- No API changes required (new fields optional in request bodies)

## Design Rationale

### Why These Fields?

**Users:**
- `bio`, `displayName`: Teacher profiles, staff directories
- `timezone`, `locale`: I18n and scheduling (due dates in user's timezone)
- `lastLoginAt`: Security monitoring, analytics, inactive user cleanup

**Groups:**
- `description`: Help users understand group purpose/scope

**Classes:**
- `description`: Course descriptions for students/parents
- `code`: Official class codes for registration, transcripts
- `startDate`, `endDate`: Archive old classes, show active classes

**Tools:**
- `description`: Critical for tool browsing/discovery (UX review recommendation)
- `usageCount`: Surface popular tools, analytics
- `tags`: Categorization for search/filter

**ClassMembers:**
- `enrolledAt`, `droppedAt`: Audit trail for enrollment changes
- `status`: Track student transfers, drops without hard delete
- `notes`: Admin context for special cases (IEP, 504, etc.)

### Why Not Other Fields?

**Deferred to future epics:**
- Avatar/logo uploads (requires file storage infrastructure - separate epic)
- Class `subject`, `gradeLevel` (will come from foreign key tables or OneRoster)
- Tool `isPublic`, `lastUsedAt` (needs sharing/visibility epic first)
- Group contact info (not needed until parent portal)

## Out of Scope

- File upload infrastructure
- Foreign key tables for subjects, grade levels, categories
- Tool sharing/visibility logic
- OneRoster field mapping
- API endpoint changes (handled in subsequent tasks)

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-13 | DRAFT | pm | Task created based on schema extension requirements |
