---
id: "E03-T003"
title: "Assignments and submissions schemas"
status: "todo"
priority: "high"
labels: [backend, database]
assignee: ""
workflow_state: "DRAFT"
epic: "E03"
depends_on: ["E03-T001", "E03-T002"]
blocks: ["E03-T007"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E03-T003: Assignments and submissions schemas

## Description

Define schemas for assignments (tool assigned to class) and submissions (student work tracking).

## Acceptance Criteria

- [ ] AC1: assignments table with class_id, tool_id, name, instructions, due_at, config
- [ ] AC2: submissions table with assignment_id, user_id, session_id, run_id, state
- [ ] AC3: submission_state enum: 'in_progress', 'submitted', 'late'
- [ ] AC4: Foreign keys with appropriate CASCADE/RESTRICT
- [ ] AC5: Unique constraint on (assignment_id, user_id, attempt)
- [ ] AC6: Indexes for queries
- [ ] AC7: Migration file 0007_create_assignments.sql
- [ ] AC8: TypeScript types exported
- [ ] AC9: Relations defined
- [ ] AC10: Tests verify constraints

## Technical Notes

```typescript
export const submissionStateEnum = pgEnum('submission_state',
  ['in_progress', 'submitted', 'late']);

export const assignments = pgTable('assignments', {
  id: uuid('id').primaryKey().defaultRandom(),
  classId: uuid('class_id').notNull().references(() => classes.id, { onDelete: 'cascade' }),
  toolId: uuid('tool_id').notNull().references(() => tools.id, { onDelete: 'restrict' }),
  name: varchar('name', { length: 200 }).notNull(),
  instructions: text('instructions'),
  config: jsonb('config').notNull().default('{}'),
  availableAt: timestamp('available_at', { withTimezone: true }),
  dueAt: timestamp('due_at', { withTimezone: true }),
  closesAt: timestamp('closes_at', { withTimezone: true }),
  maxAttempts: integer('max_attempts').default(1),
  createdBy: uuid('created_by').notNull().references(() => users.id),
  createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true }).defaultNow().notNull(),
});

export const submissions = pgTable('submissions', {
  id: uuid('id').primaryKey().defaultRandom(),
  assignmentId: uuid('assignment_id').notNull().references(() => assignments.id, { onDelete: 'cascade' }),
  userId: uuid('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  sessionId: uuid('session_id').references(() => sessions.id),
  runId: uuid('run_id'),  // will add FK in later epic
  attempt: integer('attempt').notNull().default(1),
  state: submissionStateEnum('state').notNull().default('in_progress'),
  startedAt: timestamp('started_at', { withTimezone: true }).defaultNow().notNull(),
  submittedAt: timestamp('submitted_at', { withTimezone: true }),
}, (table) => ({
  uniqueSubmission: unique().on(table.assignmentId, table.userId, table.attempt),
}));
```

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-12 | DRAFT | pm | Task created |

## Reviews

### Plan Review
- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review
- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review
- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
