---
id: "E01-T015"
title: "Add Migration Journal Sync Validation"
status: "todo"
priority: "high"
labels: [infrastructure, database, ci-cd]
assignee: ""
epic: "E01"
depends_on: ["E01-T009"]
blocks: []
created_at: "2026-01-15T00:00:00Z"
updated_at: "2026-01-15T00:00:00Z"
workflow_state: "DRAFT"
---

# E01-T015: Add Migration Journal Sync Validation

## Description

Add validation to the migration script that verifies all SQL migration files are registered in Drizzle's `_journal.json`. This prevents scenarios where a developer creates a migration file but forgets to register it, causing the migration to silently not run.

## Why This Matters

During E05-T001 integration testing, we discovered that migration files can exist without being tracked in the Drizzle journal. This means:
- Local Docker migrations appear to succeed (no errors)
- CI migrations pass (at least 1 migration ran)
- But new tables aren't created because the migration wasn't in the journal

This is a silent failure that can reach production. The validation should fail fast during any migration run - local development, CI, or deployment.

## Acceptance Criteria

- [ ] AC1: Migration script validates journal sync before applying migrations
- [ ] AC2: Validation compares count of `.sql` files to journal entries
- [ ] AC3: Clear error message when mismatch detected, including file counts
- [ ] AC4: Error message suggests remediation: "Run pnpm drizzle-kit generate"
- [ ] AC5: Validation runs on `pnpm docker:up` (catches issues in local dev)
- [ ] AC6: Validation runs in CI (catches issues before merge)
- [ ] AC7: Zero performance impact on normal migration runs (just file counting)
- [ ] AC8: Test coverage for the validation logic

## Constraints

- Must integrate into existing `packages/db/scripts/migrate.ts`
- Must not require CI configuration changes (enforced at script level)
- Must handle edge case: fresh database with no migrations yet
- Must provide actionable error messages
- Should not block emergency migrations (consider --skip-validation flag)

## Out of Scope

- Validating migration content matches schema (drizzle-kit check does this)
- Validating migration order or dependencies
- Auto-fixing journal sync issues

## Context

**Discovery:** Found during E05-T001 integration testing when migration 0012 existed but wasn't in `_journal.json`. The automated migration ran successfully (8 migrations applied) but the new tables weren't created.

**Root cause:** The journal (`packages/db/src/migrations/meta/_journal.json`) only tracks migrations 0001-0008. Migrations 0009-0012 exist as SQL files but aren't registered, so Drizzle's migrator ignores them.

**Preferred approach:** Enhance `migrate.ts` to validate sync before running. This catches issues everywhere migrations run without requiring CI changes.

**Related tasks:**
- E01-T009: Created the migrate.ts script
- E01-T012: Added CI migration testing (checks migrations ran, not journal sync)
