---
id: "E01-T009"
title: "Fix Database Migration Workflow"
status: "todo"
priority: "high"
labels: [infrastructure, database, critical, process]
assignee: ""
workflow_state: "ANALYZED"
epic: "E01"
depends_on: []
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-14T18:00:00Z"
updated_at: "2026-01-14T18:30:00Z"
spec_file: "backlog/docs/specs/E01/E01-T009-spec.md"
test_files: []
code_files: []
pr_url: ""
---

# E01-T009: Fix Database Migration Workflow

## Description

Fix the critical database migration workflow issue discovered during E04-T009 integration testing where migration SQL files are created but never applied in development due to Docker using `drizzle-kit push --force` instead of running SQL migrations. This causes development and production to use different migration strategies, leading to schema drift and integration test failures.

**Incident Summary (E04-T009):**

- Migration file `0010_enhance_chat_sessions.sql` created and committed
- Schema changes NOT applied to development database
- Docker setup uses `push --force` which bypasses migration files
- Drizzle Kit push failed to handle PostgreSQL enum changes properly
- Manual SQL intervention required to fix production-ready migration

**Root Causes:**

1. **Process Gap:** Migration files generated but never validated or applied in development
2. **Tool Mismatch:** Docker uses `push`, production needs `migrate`
3. **Tool Limitation:** Drizzle Kit push doesn't handle PostgreSQL enum changes correctly
4. **Documentation Gap:** No clear guidance on when to use `push` vs `migrate`

## Acceptance Criteria

### Infrastructure Changes

- [ ] AC1: Docker Compose migrate service uses `drizzle-kit migrate` instead of `push --force`
- [ ] AC2: Migration validation script (`migrate-check.ts`) detects schema drift and unsafe patterns
- [ ] AC3: Pre-commit hook runs migration validation and blocks commits with schema drift
- [ ] AC4: CI applies migrations before running tests (catches migration failures early)

### Developer Experience

- [ ] AC5: Migration workflow documented in `docs/database-migrations.md` and `CONVENTIONS.md`
- [ ] AC6: Interactive migration helper script guides developers through workflow
- [ ] AC7: PostgreSQL enum migration pattern documented with examples (rename-recreate-drop)
- [ ] AC8: Migration rollback strategy documented (reverse migrations, backup/restore)

### Testing & Validation

- [ ] AC9: Migration application tests verify all migrations apply successfully
- [ ] AC10: Docker integration test verifies migrations run automatically on `docker compose up`
- [ ] AC11: Validation script warns on dangerous patterns (DROP TABLE without IF EXISTS, enum changes, NOT NULL without DEFAULT)

## Technical Notes

### Current Problem

**Docker setup (`docker-compose.yml` line 59):**

```yaml
command: ["pnpm", "exec", "drizzle-kit", "push", "--force"]
```

**Why this is wrong:**

- Bypasses migration files completely
- Doesn't handle PostgreSQL enum changes (E04-T009 example)
- Development diverges from production approach
- No migration tracking (`__drizzle_migrations` table not created)

### Correct Approach

**Development workflow (new):**

1. Modify Drizzle schema files
2. Run `pnpm --filter @raptscallions/db db:generate` (creates SQL migration)
3. Review and edit migration SQL if needed (especially for enum changes)
4. Run `pnpm --filter @raptscallions/db db:migrate` (applies migration locally)
5. Run tests to verify changes
6. Commit schema + migration files
7. CI validates migration before merge

**When to use each command:**

| Command         | Use Case                    | Safe? | Commit After? |
| --------------- | --------------------------- | ----- | ------------- |
| `db:generate`   | Create migration from schema | Yes   | Yes           |
| `db:migrate`    | Apply migrations             | Yes   | N/A           |
| `db:push`       | Rapid prototyping only       | No    | Never         |
| `db:push --force` | NEVER USE                  | No    | Never         |

### PostgreSQL Enum Migration Pattern

**Problem:** PostgreSQL doesn't support dropping enum values or renaming values.

**Solution:** Rename-recreate-drop pattern (from E04-T009):

```sql
-- 1. Migrate existing data using old enum value
UPDATE table_name SET column = 'new_value' WHERE column = 'old_value';

-- 2. Rename existing enum
ALTER TYPE enum_name RENAME TO enum_name_old;

-- 3. Create new enum with desired values
CREATE TYPE enum_name AS ENUM('value1', 'value2');

-- 4. Alter column to use new enum (cast through text)
ALTER TABLE table_name
  ALTER COLUMN column TYPE enum_name
  USING column::text::enum_name;

-- 5. Drop old enum
DROP TYPE enum_name_old;
```

**Common mistake:** Using `drizzle-kit push` for enum changes generates incorrect SQL.

**Correct approach:** Write SQL migration manually or carefully review/edit generated migration.

### Migration Validation

**Pre-commit checks:**

- Detect uncommitted schema changes without corresponding migration
- Warn on unsafe patterns:
  - `DROP TABLE` without `IF EXISTS`
  - `ALTER TYPE ... ENUM` without proper rename-recreate-drop
  - `ALTER COLUMN ... NOT NULL` without `DEFAULT`
- Exit with error if schema drift detected

**CI checks:**

- Apply migrations to fresh database
- Run tests against migrated database
- Fail build if migration fails or tests fail

## Implementation Checklist

### Phase 1: Infrastructure Setup

- [ ] Create `packages/db/scripts/migrate.ts` (TypeScript migration runner)
- [ ] Create `packages/db/scripts/migrate-check.ts` (validation script)
- [ ] Create `packages/db/scripts/migrate-with-signal.sh` (Docker healthcheck support)
- [ ] Add `db:migrate` and `db:migrate:check` scripts to `packages/db/package.json`
- [ ] Test migration scripts with existing migrations

### Phase 2: Docker Integration

- [ ] Update `docker-compose.yml` migrate service command to use `db:migrate`
- [ ] Add healthcheck to migrate service
- [ ] Test Docker workflow: `docker compose down -v && docker compose up -d`
- [ ] Verify `__drizzle_migrations` table created
- [ ] Verify API service waits for migration completion

### Phase 3: Developer Tooling

- [ ] Create `packages/db/docs/enum-migration-guide.md`
- [ ] Create `packages/db/scripts/migration-helper.ts` (interactive helper)
- [ ] Update `.github/hooks/pre-commit` with migration validation
- [ ] Add warning to `db:push` script discouraging use
- [ ] Test developer workflow end-to-end

### Phase 4: CI/CD Integration

- [ ] Create or update `.github/workflows/ci.yml`
- [ ] Add PostgreSQL service to CI
- [ ] Add migration step before tests
- [ ] Test CI with deliberate migration failure
- [ ] Verify PR blocking works

### Phase 5: Documentation

- [ ] Create `docs/database-migrations.md` (comprehensive workflow guide)
- [ ] Create `docs/troubleshooting-migrations.md` (common issues)
- [ ] Update `docs/CONVENTIONS.md` migration section (lines 452-457)
- [ ] Update `docs/ARCHITECTURE.md` migration strategy (around line 395)
- [ ] Update `README.md` with migration workflow
- [ ] Document rollback strategy

### Phase 6: Testing

- [ ] Create `packages/db/__tests__/migrations.test.ts` (unit tests)
- [ ] Create `packages/db/__tests__/integration/migration-workflow.test.ts`
- [ ] Test enum migration pattern
- [ ] Test schema drift detection
- [ ] Test CI workflow

## Edge Cases

1. **Migration fails mid-execution:** PostgreSQL transactions ensure atomic rollback
2. **Schema changes without migration:** Pre-commit hook blocks commit with actionable error
3. **Enum change in production:** Document downtime requirements and testing process
4. **Developer uses `push`:** Validation detects drift on next commit, recovery documented
5. **Multiple developers creating migrations:** Git conflict resolution documented, CI validates sequential numbering

## Success Criteria

**Technical:**

- Migration files successfully applied in Docker environment
- No schema drift detected by validation scripts
- All tests pass with migrated database
- CI applies migrations before tests without errors

**Developer Experience:**

- Clear error messages when validation fails
- Migration creation time < 5 minutes (generate + review + apply)
- Zero "push vs migrate" confusion after rollout

**Documentation:**

- Migration workflow clear and comprehensive
- Enum change pattern documented with examples
- Troubleshooting guide covers common issues

## Review References

This task addresses the critical incident discovered during:

- **E04-T009 Integration Testing:** Migration file created but not applied
- **E04-T009 QA Report:** `backlog/docs/reviews/E04/E04-T009-qa-report.md` lines 453-454
- **E04-T009 Migration:** `packages/db/src/migrations/0010_enhance_chat_sessions.sql` (exemplar for enum handling)

## Related Tasks

- **E04-T009** - Identified the issue during integration testing
- **E04-T010** - Will benefit from reliable migration workflow
- **E04-T011** - Will use new migration workflow
- All future database schema changes will use this workflow

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-14 | DRAFT | analyst | Task created to address critical migration workflow issue discovered in E04-T009 integration testing |
| 2026-01-14 | ANALYZED | analyst | Implementation spec created with comprehensive migration workflow, Docker integration, validation scripts, CI/CD setup, and documentation plan. Root cause analysis identifies process gap, tool mismatch, Drizzle Kit limitations, and documentation gaps. Solution adopts migrate-first workflow for all environments. |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
