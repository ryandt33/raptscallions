---
id: "E05-T003a"
title: "S3-compatible storage backend implementation"
status: "todo"
priority: "critical"
task_type: "backend"
workflow: "development"
labels: [backend, infrastructure, s3, storage]
assignee: ""
workflow_state: "PR_READY"
epic: "E05"
agentic_style: "outcome-focused"
depends_on: ["E05-T002a", "E05-T002b"]
blocks: ["E05-T003c", "E05-T005"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-16T00:00:00Z"
updated_at: "2026-01-16T00:00:00Z"
spec_file: "backlog/docs/specs/E05/E05-T003a-spec.md"
analysis_file: "backlog/docs/analysis/E05/E05-T003a-analysis.md"
test_files: ["packages/storage/src/__tests__/s3.backend.test.ts"]
code_files: ["packages/storage/src/backends/s3.backend.ts", "packages/storage/src/backends/index.ts"]
pr_url: ""
---

# E05-T003a: S3-compatible storage backend implementation

## Description

Implement a storage backend that works with any S3-compatible service (AWS S3, MinIO, DigitalOcean Spaces, Backblaze B2). This backend handles file upload, download, deletion, existence checks, and signed URL generation using the IStorageBackend interface from E05-T002a.

## Why This Matters

S3-compatible storage is the production default for RaptScallions. Schools and districts need reliable, scalable file storage for student work, teacher materials, and assignment attachments. MinIO compatibility enables self-hosted deployments without cloud vendor lock-in.

## Acceptance Criteria

- [ ] AC1: Backend implements the IStorageBackend interface from E05-T002a
- [ ] AC2: Files can be uploaded to S3-compatible storage with proper content types
- [ ] AC3: Files can be downloaded from S3-compatible storage
- [ ] AC4: Files can be deleted from S3-compatible storage
- [ ] AC5: Existence checks correctly identify present/missing files
- [ ] AC6: Signed URLs are generated with configurable expiration (default 15 minutes)
- [ ] AC7: Storage keys follow organized path structure (e.g., groupId/year/month/uuid.ext)
- [ ] AC8: Backend works with MinIO using path-style URLs (forcePathStyle)
- [ ] AC9: Network/auth failures produce clear StorageError messages
- [ ] AC10: Missing object errors are handled gracefully (not crashes)

## Constraints

- Performance: Upload/download operations should add minimal overhead (<5% of transfer time)
- Compatibility: Must work with MinIO (path-style URLs) and AWS S3 (virtual-hosted style)
- Streaming: Should support streaming for large files (avoid loading entire file in memory)
- Error handling: Must distinguish between "object not found" and "service unavailable"
- Configuration: Must integrate with config system from E05-T002b

## Workflow

**Category:** `development` (standard)

**Rationale:** Backend service implementation requiring TDD approach - write tests first, then implement to pass tests.

**Phases:**
1. `/analyze` - Research AWS SDK v3 patterns and existing storage patterns
2. Human approval of approach
3. `/review-plan` - Architect validates approach
4. `/write-tests` - TDD red phase (unit tests with mocked S3 client)
5. `/implement` - Write code to pass tests
6. `/review-code` - Fresh-eyes code review
7. `/qa` - Validation (unit tests only - integration tests in E05-T003c)
8. `/update-docs` - Update KB storage documentation
9. PR creation

## Out of Scope

- Docker/MinIO setup (E05-T003b)
- Integration tests with real MinIO (E05-T003c)
- Production S3 credentials (E05-T003d)
- Local filesystem backend (E05-T004)
- Other cloud providers (Azure, GCS - future epic)
- Multipart uploads for very large files (future enhancement)
- Server-side encryption configuration (future enhancement)

## Context

- Implements IStorageBackend interface from E05-T002a
- Uses configuration from E05-T002b (S3_ENDPOINT, S3_BUCKET, etc.)
- Follow patterns established in packages/ai for external service integration
- AWS SDK v3 is the standard for S3 operations (see package.json dependencies)

## Test Implementation Notes

The following considerations were identified during test writing and may require adjustment during implementation:

1. **Mock verification pattern**: Tests assert command objects have an `input` property (e.g., `expect.objectContaining({ input: { Bucket: '...' } })`). AWS SDK v3 command structure may differ - verify during implementation and adjust assertions if needed.

2. **Signed URL presigner**: Tests don't mock `@aws-sdk/s3-request-presigner`. The implementation may need to accept a presigner as a dependency for full DI testability, or tests may need adjustment to work with the actual presigner behavior.

3. **`createMockS3Body` helper**: Defined but not fully wired into download test mocks. Ensure download tests properly return this mock body structure.

These are acceptable TDD adjustments - test intent is clear, minor mock structure changes during implementation are normal.

## Documentation Updates

**KB Documentation:**

- Created: `apps/docs/src/storage/patterns/s3-backend.md`
  - Complete S3StorageBackend documentation with quick start, configuration, operations, error handling, and testing patterns
  - Added `related_code` frontmatter linking to backend files
  - Added `implements_task: E05-T003a`
  - Added backlog references in Related Pages section
- Updated: `apps/docs/src/storage/patterns/index.md`
  - Added S3-Compatible Backend to patterns list
- Updated: `apps/docs/src/storage/index.md`
  - Added S3-Compatible Backend to patterns list
  - Added E05-T003a backlog reference
- Updated: `apps/docs/src/storage/concepts/backend-interface.md`
  - Added S3 backend files to `related_code`
  - Added S3-Compatible Backend to Related Documentation
  - Added E05-T003a backlog reference
- Updated: `apps/docs/src/.vitepress/config.ts`
  - Added S3-Compatible Backend to storage patterns sidebar

**Verification:**

- Build check passed (no broken links)
- All KB pages include backlog references

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-16 | PR_READY | writer | KB documentation updated. Created S3-Compatible Backend pattern page. Updated storage index, patterns index, backend-interface concept, and VitePress sidebar config. Build passes. |
| 2026-01-16 | DOCS_UPDATE | qa | QA PASS. All 10 acceptance criteria verified. 217 tests pass (43 for S3 backend). Build, typecheck, lint all pass. Ready for documentation update. See report at backlog/docs/reviews/E05/E05-T003a-qa-report.md |
| 2026-01-16 | QA_REVIEW | developer | Addressed review feedback: created backends/index.ts with exports (SF-1), added exports to main index.ts, added CredentialsProviderError test (SG-3). Now 43 tests pass. |
| 2026-01-16 | QA_REVIEW | reviewer | Code review APPROVED. Excellent DI design, comprehensive error handling, all 42 tests pass. One Should Fix: missing backends/index.ts exports. See review at backlog/docs/reviews/E05/E05-T003a-code-review.md |
| 2026-01-16 | IMPLEMENTED | developer | Implemented S3StorageBackend class with all IStorageBackend methods. Added presigner DI for testability. All 42 unit tests pass. Lint and typecheck pass. |
| 2026-01-16 | TESTS_READY | developer | TDD red phase complete; 42 tests written covering all IStorageBackend methods, error handling, edge cases. Tests use DI pattern (injected mock S3Client). All tests fail due to missing implementation (module not found). |
| 2026-01-16 | APPROVED | architect | Approved Approach C (Hybrid DI); created spec with class structure, factory pattern, error handling strategy |
| 2026-01-16 | ANALYZED | analyst | Created analysis with 3 approaches; recommended Approach C (Hybrid - Class Backend with Injected S3Client) for best testability |
| 2026-01-16 | REPLANNED | pm | Split from E05-T003 - focused on core backend implementation |
| 2026-01-13 | DRAFT | pm | Original task created for Epic E05 |
