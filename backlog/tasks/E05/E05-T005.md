---
id: "E05-T005"
title: "File service with three-tier limits and quotas"
status: "todo"
priority: "critical"
labels: [backend, service, business-logic]
assignee: ""
workflow_state: "DRAFT"
epic: "E05"
depends_on: ["E05-T001", "E05-T002a", "E05-T002b", "E05-T003a"]
blocks: ["E05-T006", "E05-T007"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-13T00:00:00Z"
updated_at: "2026-01-15T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E05-T005: File service with three-tier limits and quotas

## Description

Implement FileService with three-tier limit resolution (system defaults → role-based → user overrides), quota tracking with atomic updates, CASL permission checks, and file lifecycle management (upload, download, delete).

## Why This Matters

This is the core business logic layer for file management. It enforces the three-tier limit system, tracks storage quotas accurately, and ensures proper access control. Without this service, the API routes can't safely manage files.

## Acceptance Criteria

### FileLimitsService
- [ ] AC1: getEffectiveLimits(userId) resolves limits following priority: user override → group role → system default
- [ ] AC2: Returns limit values with source indicator ('user_override', 'role_based', 'system_default')
- [ ] AC3: setUserOverride(userId, limits, setBy, reason) allows admins to set user-specific limits
- [ ] AC4: clearUserOverride(userId) removes user-specific override
- [ ] AC5: Partial overrides work (override file size but inherit quota from role)

### FileService - Upload
- [ ] AC6: uploadFile(params, ability) validates file size against effective limit
- [ ] AC7: Checks quota availability BEFORE upload (fail fast)
- [ ] AC8: CASL permission check: user can upload to specified group
- [ ] AC9: MIME type validation against configurable whitelist
- [ ] AC10: Transaction: upload to storage → insert DB record → update quota atomically
- [ ] AC11: Quota update uses SQL increment (atomic, no race conditions)
- [ ] AC12: Returns File record with metadata

### FileService - Download
- [ ] AC13: getFile(fileId, ability) retrieves file with permission check
- [ ] AC14: CASL permission check: user can read file
- [ ] AC15: Generates signed URL via storage backend
- [ ] AC16: Returns file metadata + signed URL
- [ ] AC17: Excludes soft-deleted files

### FileService - Delete
- [ ] AC18: softDeleteFile(fileId, ability) sets status='soft_deleted', deleted_at
- [ ] AC19: CASL permission check: user can delete file
- [ ] AC20: Updates quota (decrement used_bytes) atomically
- [ ] AC21: Does NOT delete from storage backend immediately

### FileService - Listing
- [ ] AC22: listFiles(userId, filters, pagination) with cursor-based pagination
- [ ] AC23: Filters: purpose, groupId, status
- [ ] AC24: Returns files with nextCursor for pagination

### Quota Tracking
- [ ] AC25: getUserQuota(userId) returns used/limit/remaining bytes + source
- [ ] AC26: Quota updates are atomic (database transaction + SQL increment)
- [ ] AC27: Soft-deleted files DO NOT count toward quota

### Testing
- [ ] AC28: Tests verify three-tier limit resolution (all scenarios)
- [ ] AC29: Tests verify quota enforcement blocks upload when exceeded
- [ ] AC30: Tests verify CASL permissions (owner, group admin, system admin)
- [ ] AC31: Tests verify transaction rollback on storage failure
- [ ] AC32: Tests verify concurrent quota updates don't race

## Constraints

- Must work without E03 entities - no references to classes, assignments, tools
- Use `purpose` field for categorization, not `entityType`/`entityId`
- Follow existing service patterns from E02 (auth services)
- Atomic quota updates to prevent race conditions

## Out of Scope

- API routes (E05-T006, E05-T007)
- Background cleanup jobs (E05-T008)
- Entity associations like avatars (deferred to post-E03)

## Context

The three-tier limit system resolves in this order:
1. Check `user_storage_limits` for user-specific override
2. Check `groups.settings.storageLimits[role]` for role-based limit
3. Fall back to system defaults from environment variables

See the E05 epic notes for detailed examples and the limit resolution algorithm.

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-13 | DRAFT | pm | Task created as E05-T006 |
| 2026-01-15 | DRAFT | pm | Renumbered to E05-T005; removed entityType/entityId references |
