---
id: "E05-T008"
title: "Integration tests and cleanup jobs"
status: "todo"
priority: "high"
labels: [backend, testing, workers]
assignee: ""
workflow_state: "DRAFT"
epic: "E05"
depends_on: ["E05-T005", "E05-T006"]
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-13T00:00:00Z"
updated_at: "2026-01-15T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E05-T008: Integration tests and cleanup jobs

## Description

Implement comprehensive integration tests for file storage workflows (upload → download → delete) with multi-backend support verification. Create BullMQ background jobs for orphaned file cleanup (30+ days soft-deleted) and weekly quota reconciliation.

## Why This Matters

Integration tests ensure the complete file storage flow works end-to-end with real storage backends. Cleanup jobs prevent storage costs from growing unbounded and ensure quota tracking remains accurate over time.

## Acceptance Criteria

### Integration Tests - Core Workflows
- [ ] AC1: Test complete upload → download → delete workflow
- [ ] AC2: Test upload with quota validation (success and quota exceeded)
- [ ] AC3: Test upload with file size validation (success and too large)
- [ ] AC4: Test signed URL generation and expiration
- [ ] AC5: Test file listing with pagination and filters
- [ ] AC6: Test soft delete updates quota correctly
- [ ] AC7: Test permission checks (owner, group admin, system admin)
- [ ] AC8: Test three-tier limit resolution (default → role → user override)

### Integration Tests - Multi-Backend
- [ ] AC9: Test S3/MinIO backend with real MinIO container
- [ ] AC10: Test local filesystem backend
- [ ] AC11: Test backend switching (upload to one, read from same)
- [ ] AC12: Verify storage key format consistency across backends
- [ ] AC13: Test error handling for backend failures
- [ ] AC14: Test signed URL validity for each backend

### Integration Tests - Admin Routes
- [ ] AC15: Test admin setting user limit override
- [ ] AC16: Test admin clearing user override
- [ ] AC17: Test admin setting group role limits
- [ ] AC18: Test non-admin forbidden from admin routes
- [ ] AC19: Test effective limits calculated correctly after override

### Cleanup Job - Orphaned Files
- [ ] AC20: OrphanedFileCleanupJob runs daily (cron: 0 2 * * *)
- [ ] AC21: Retention period configurable via `FILE_RETENTION_DAYS` env var (default: 30)
- [ ] AC22: Identifies files with status='soft_deleted' and deleted_at older than retention period
- [ ] AC23: Deletes file from storage backend
- [ ] AC24: Deletes file record from database
- [ ] AC25: Logs cleanup summary (files deleted, bytes freed, retention period used)
- [ ] AC26: Handles storage backend errors gracefully (marks file for retry)

### Cleanup Job - Quota Reconciliation
- [ ] AC27: QuotaReconciliationJob runs weekly (cron: 0 3 * * 0)
- [ ] AC28: Recalculates used_bytes for all users from files table
- [ ] AC29: Compares with user_storage_limits.used_bytes
- [ ] AC30: Updates user_storage_limits if discrepancy found
- [ ] AC31: Logs discrepancies (user_id, expected, actual, diff)
- [ ] AC32: Sends alert if discrepancy > 100MB for any user

### Test Infrastructure
- [ ] AC33: Docker Compose test environment with MinIO
- [ ] AC34: Test fixtures for files, users, groups
- [ ] AC35: Cleanup after tests (delete test files from storage)
- [ ] AC36: Integration tests can run against any backend
- [ ] AC37: Coverage report includes integration tests
- [ ] AC38: Tests run in CI/CD pipeline

### Monitoring & Observability
- [ ] AC39: OpenTelemetry traces for file operations
- [ ] AC40: Metrics: file_uploads_total, file_downloads_total, storage_bytes_used
- [ ] AC41: Metrics: quota_exceeded_total, cleanup_files_deleted_total
- [ ] AC42: Log structured events: file.uploaded, file.deleted, quota.exceeded

## Constraints

- Tests must not depend on E03 entities (no avatar/attachment association tests)
- MinIO container required for S3 integration tests
- Jobs should be idempotent (safe to run multiple times)

## Out of Scope

- Entity association tests (avatars, attachments) - deferred to post-E03
- File integrity verification (checksums)
- Storage cost analytics
- File deduplication
- Load testing for concurrent uploads

## Context

Integration tests use a real MinIO container via docker-compose.test.yml to verify S3 compatibility. The local filesystem backend tests run against a temporary directory that's cleaned up after each test.

Cleanup jobs run on a schedule via BullMQ with Redis. The orphaned file cleanup runs daily at 2 AM, and quota reconciliation runs weekly on Sunday at 3 AM. Both jobs are designed to be safe if they overlap or run multiple times.

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-13 | DRAFT | pm | Task created as E05-T010 |
| 2026-01-15 | DRAFT | pm | Renumbered to E05-T008; removed avatar/attachment association tests |
