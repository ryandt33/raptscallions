---
id: "E05-T002b"
title: "Storage configuration system with validation"
status: "todo"
priority: "critical"
labels: [backend, infrastructure, configuration]
assignee: ""
workflow_state: "DRAFT"
epic: "E05"
depends_on: ["E05-T002a"]
blocks: ["E05-T003", "E05-T004", "E05-T005"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-15T00:00:00Z"
updated_at: "2026-01-15T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E05-T002b: Storage configuration system with validation

## Description

Create a Zod-based configuration system for the storage package that validates environment variables, enforces backend-specific requirements, and provides lazy initialization matching existing patterns (e.g., `packages/ai/config.ts`).

## Why This Matters

Storage backends require different configuration (S3 needs bucket/keys, Azure needs account/container, local needs filesystem path). The system must validate that the selected backend has all required configuration before instantiation, provide clear error messages for missing config, and defer parsing until first use (for faster startup and easier testing).

## Acceptance Criteria

- [ ] AC1: Configuration schema validates common settings (backend identifier, max file size, storage quota, signed URL expiration)
- [ ] AC2: Configuration schema validates backend-specific settings (S3 bucket/keys, Azure account, GCS project, local path, etc.)
- [ ] AC3: Configuration validates that selected backend has all required settings present
- [ ] AC4: Missing or invalid configuration produces clear error messages identifying what's missing
- [ ] AC5: Configuration is lazy-loaded (not parsed until first access)
- [ ] AC6: Tests can reset configuration state between test cases
- [ ] AC7: Configuration supports extensibility (new backends can define their config requirements)
- [ ] AC8: Default values are provided for common settings (10MB file size, 1GB quota, 15min signed URL expiration)
- [ ] AC9: Environment variables are the primary configuration source
- [ ] AC10: Configuration is read-only after initialization (immutable)

## Constraints

- Must use Zod for validation (matches project conventions)
- Lazy initialization using Proxy pattern (matches `packages/ai/config.ts`)
- Backend-specific validation should support backends registered via E05-T002a plugin system
- Configuration validation must occur before backend instantiation (fail fast)
- Zero configuration required for local filesystem backend (sensible defaults)

## Out of Scope

- Actual backend implementations (E05-T003, E05-T004, E05-T005)
- Runtime configuration updates (config is immutable after load)
- Configuration UI or admin interface
- Secrets management (uses plain env vars, secrets handling is deployment concern)
- Configuration persistence to database

## Context

### Existing Pattern

The `packages/ai/config.ts` uses lazy Proxy-based loading:
```typescript
export const aiConfig = new Proxy({} as AiConfig, {
  get(_target, prop: keyof AiConfig) {
    const config = loadConfig();
    return config[prop];
  },
});
```

This pattern should be replicated for storage config.

### Backend-Specific Validation

Different backends need different config:
- **Local**: Just filesystem path (default: `./storage/uploads`)
- **S3-compatible**: Endpoint (optional), region, bucket, access key ID, secret key
- **Azure Blob**: Account name, access key, container name
- **GCS**: Project ID, bucket, key file path (or ADC)
- **Aliyun OSS**: Region, bucket, access key ID, secret

Validation should ensure required fields are present when that backend is selected.

### Integration with Plugin System

Configuration should work with E05-T002a's plugin registry:
- Plugins can optionally provide config schema
- Config system validates against registered backend's requirements
- Unknown backends fail validation unless they provide config schema

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-15 | REPLANNED | pm | Split from E05-T002, focused on config validation without prescribing implementation |
| 2026-01-13 | DRAFT | pm | Original task created for Epic E05 |
