---
id: "E05-T004"
title: "Local filesystem storage implementation"
status: "todo"
priority: "high"
task_type: "backend"
workflow: "development"
labels: [backend, storage]
assignee: ""
workflow_state: "DRAFT"
epic: "E05"
agentic_style: "outcome-focused"
depends_on: ["E05-T002a", "E05-T002b"]
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-13T00:00:00Z"
updated_at: "2026-01-18T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E05-T004: Local filesystem storage implementation

## Description

Implement local filesystem storage backend as a fallback for development and self-hosted deployments without cloud storage. Files are stored in an organized directory structure with token-based download URLs that bypass the API for direct file serving.

## Why This Matters

Self-hosted schools and small districts may not want or afford cloud storage costs. Local filesystem storage provides a zero-cost, zero-configuration option that works immediately after deployment. It's also essential for local development without cloud credentials.

## Acceptance Criteria

### Core Storage Operations
- [ ] AC1: Backend implements IStorageBackend interface from E05-T002a
- [ ] AC2: Files upload to configurable local directory with organized path structure
- [ ] AC3: Files download correctly with proper error handling for missing files
- [ ] AC4: Files delete from disk (soft delete tracking handled by database layer)
- [ ] AC5: Existence checks correctly identify present/missing files
- [ ] AC6: File writes are atomic (no partial files on failure/crash)

### Token-Based Download URLs
- [ ] AC7: Signed URLs use JWT tokens instead of S3-style presigning
- [ ] AC8: Tokens include storage key and expiration, signed with app secret
- [ ] AC9: Download endpoint validates token and serves file with correct headers
- [ ] AC10: Expired or invalid tokens are rejected with clear error

### Error Handling
- [ ] AC11: Directory creation failures produce clear StorageError
- [ ] AC12: Disk write failures (permissions, full disk) produce clear StorageError
- [ ] AC13: Missing files on download throw NotFoundError
- [ ] AC14: All errors include context for debugging (path, operation, underlying error)

### Docker Integration
- [ ] AC15: Volume mount configured for file persistence across restarts
- [ ] AC16: Storage directory excluded from Docker image build
- [ ] AC17: Setup documented in README for self-hosted deployments

## Constraints

- Performance: File operations should add minimal overhead (<5% of I/O time)
- Atomicity: Use temp file + rename pattern to prevent partial writes
- Security: Token validation must reject tampered or expired tokens
- Compatibility: Must work on Linux, macOS, and Windows (Docker)
- Path safety: Storage keys must not allow directory traversal attacks

## Workflow

**Category:** `development` (standard)

**Rationale:** Backend service implementation requiring TDD approach. Follows the same pattern as E05-T003a (S3 backend).

**Phases:**
1. `/analyze` - Research Node.js fs patterns and JWT signing approaches
2. Human approval of approach
3. `/review-plan` - Architect validates approach
4. `/write-tests` - TDD red phase (unit tests with temp directories)
5. `/implement` - Write code to pass tests
6. `/review-code` - Fresh-eyes code review
7. `/qa` - Validation and manual Docker testing
8. `/update-docs` - Update KB storage documentation
9. PR creation

## Out of Scope

- Image processing (thumbnails, resizing)
- File streaming for very large files (>100MB)
- Compression/decompression
- Filesystem quota management (relies on OS)
- Network file systems (NFS, SMB)
- File versioning
- Checksum verification

## Context

- Implements IStorageBackend interface from E05-T002a
- Uses configuration from E05-T002b (LOCAL_STORAGE_PATH, SESSION_SECRET)
- Follow patterns established in E05-T003a (S3 backend) for consistency
- JWT library already available in the project (used by auth package)
- Docker volume patterns established in E05-T003b (MinIO setup)

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-18 | REPLANNED | pm | Removed implementation code, added missing sections, reduced AC from 30 to 17 |
| 2026-01-13 | DRAFT | pm | Task created for Epic E05 |
