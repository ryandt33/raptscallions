---
id: "E05-T006"
title: "File upload API routes"
status: "todo"
priority: "critical"
labels: [backend, api, multipart]
assignee: ""
workflow_state: "DRAFT"
epic: "E05"
depends_on: ["E05-T005"]
blocks: ["E05-T008"]
breakpoint: false
assigned_agent: ""
created_at: "2026-01-13T00:00:00Z"
updated_at: "2026-01-15T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E05-T006: File upload API routes

## Description

Implement multipart file upload route using @fastify/multipart with file size middleware, quota validation, and proper error responses following REST conventions.

## Why This Matters

This is the primary user-facing endpoint for uploading files. It must handle multipart form data correctly, enforce limits before consuming the upload, and provide clear error messages for validation failures.

## Acceptance Criteria

### Multipart Plugin Setup
- [ ] AC1: Register @fastify/multipart plugin in apps/api
- [ ] AC2: Configure file size limit from storageConfig.DEFAULT_MAX_FILE_SIZE_BYTES
- [ ] AC3: Configure max files per request: 1 (single file uploads only)
- [ ] AC4: Configure allowed MIME types via plugin options

### POST /files Route
- [ ] AC5: POST /files accepts multipart/form-data
- [ ] AC6: Authentication required (app.authenticate preHandler)
- [ ] AC7: Request fields: file (binary), groupId (optional), purpose (optional)
- [ ] AC8: Validates request body with Zod schema
- [ ] AC9: Calls fileService.uploadFile() with user from request.user
- [ ] AC10: Returns 201 Created with file metadata (id, name, size, mimeType, purpose, createdAt)
- [ ] AC11: Returns 400 Bad Request if no file provided
- [ ] AC12: Returns 413 Payload Too Large if file exceeds size limit
- [ ] AC13: Returns 422 Unprocessable Entity if quota exceeded
- [ ] AC14: Returns 403 Forbidden if user lacks permission

### Validation Schemas
- [ ] AC15: uploadFileBodySchema validates groupId, purpose
- [ ] AC16: purpose is a free-form string (not enum) for flexibility
- [ ] AC17: All fields optional except file itself

### Error Handling
- [ ] AC18: QuotaExceededError → 422 with quota details in response
- [ ] AC19: ValidationError → 400 with error details
- [ ] AC20: ForbiddenError → 403 with permission message
- [ ] AC21: StorageError → 500 with generic error message (no internal details)

### Integration Tests
- [ ] AC22: Test successful file upload returns 201 with metadata
- [ ] AC23: Test upload without authentication returns 401
- [ ] AC24: Test upload exceeding file size limit returns 413
- [ ] AC25: Test upload exceeding quota returns 422 with quota info
- [ ] AC26: Test upload with invalid MIME type returns 400
- [ ] AC27: Test upload without file returns 400
- [ ] AC28: Test upload to group without permission returns 403

## Constraints

- Use `purpose` field instead of `entityType`/`entityId` (no E03 dependencies)
- Follow existing Fastify route patterns from E02
- Stream file data to avoid buffering large files in memory

## Out of Scope

- File download routes (E05-T007)
- Limit management routes (E05-T007)
- Entity associations like avatars (deferred to post-E03)
- Batch/bulk uploads
- Progress tracking for large uploads
- Resumable uploads

## Context

The upload route receives multipart form data, validates the file against user limits, uploads to the configured storage backend, creates a database record, and updates the user's quota - all in a transaction. If any step fails, the entire operation is rolled back.

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-13 | DRAFT | pm | Task created as E05-T007 |
| 2026-01-15 | DRAFT | pm | Renumbered to E05-T006; changed entityType/entityId to purpose |
