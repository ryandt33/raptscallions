---
id: "E05-T007"
title: "File download and management API routes"
status: "todo"
priority: "high"
labels: [backend, api, admin]
assignee: ""
workflow_state: "DRAFT"
epic: "E05"
depends_on: ["E05-T005"]
blocks: []
breakpoint: false
assigned_agent: ""
created_at: "2026-01-13T00:00:00Z"
updated_at: "2026-01-15T00:00:00Z"
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E05-T007: File download and management API routes

## Description

Implement file download, deletion, listing, quota query routes, and admin routes for managing user-specific limit overrides and group role-based limits.

## Why This Matters

Users need to retrieve their uploaded files, view their quota usage, and delete files they no longer need. Admins need to manage storage limits for users and groups. These routes complete the file management API.

## Acceptance Criteria

### User-Facing File Routes
- [ ] AC1: GET /files/:id returns file metadata + signed download URL
- [ ] AC2: DELETE /files/:id soft deletes file (owner or admin)
- [ ] AC3: GET /files lists user's files with pagination (cursor-based)
- [ ] AC4: GET /files supports filters: purpose, groupId, status
- [ ] AC5: GET /users/me/quota returns storage usage, limit, and source
- [ ] AC6: GET /users/me/limits returns effective limits with source
- [ ] AC7: All routes require authentication (app.authenticate)
- [ ] AC8: CASL permissions enforced on all operations

### Admin Limit Management Routes
- [ ] AC9: PATCH /admin/users/:userId/limits sets user-specific overrides
- [ ] AC10: DELETE /admin/users/:userId/limits clears user overrides
- [ ] AC11: GET /admin/users/:userId/limits returns user's effective limits + override details
- [ ] AC12: PATCH /admin/groups/:groupId/limits sets role-based limits
- [ ] AC13: Admin routes require system_admin role (app.requireRole preHandler)
- [ ] AC14: Request body validation with Zod schemas

### Response Formats
- [ ] AC15: GET /files/:id returns: { data: { ...file, signedUrl, expiresAt } }
- [ ] AC16: GET /files returns: { data: [...files], meta: { nextCursor, hasMore } }
- [ ] AC17: GET /users/me/quota returns: { data: { usedBytes, quotaBytes, remainingBytes, source } }
- [ ] AC18: 404 if file not found or soft deleted
- [ ] AC19: 403 if user lacks permission

### Testing
- [ ] AC20: Tests verify file download with signed URL
- [ ] AC21: Tests verify file deletion updates quota
- [ ] AC22: Tests verify pagination works correctly
- [ ] AC23: Tests verify filters (purpose, groupId)
- [ ] AC24: Tests verify admin can set user overrides
- [ ] AC25: Tests verify non-admin cannot set overrides
- [ ] AC26: Tests verify limit source is correctly returned

## Constraints

- Use `purpose` filter instead of `entityType`/`entityId` (no E03 dependencies)
- Follow existing Fastify route patterns from E02
- Signed URLs should expire in 15 minutes (configurable)

## Out of Scope

- Entity associations like avatars (deferred to post-E03)
- Bulk limit updates
- Limit history/audit log viewing
- File preview/thumbnail generation
- Batch file operations

## Context

File download returns a signed URL that allows direct access to the storage backend, avoiding the need to proxy file data through the API server. This is more efficient for large files and reduces server load.

The admin limit routes allow system administrators to override the default limits for specific users or configure role-based limits for groups. This enables flexible quota management for different tiers of users.

## History

| Date | State | Agent | Notes |
| ---- | ----- | ----- | ----- |
| 2026-01-13 | DRAFT | pm | Task created as E05-T008 |
| 2026-01-15 | DRAFT | pm | Renumbered to E05-T007; changed entityType filter to purpose |
