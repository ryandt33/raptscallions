---
id: E02-T009
title: Encapsulate session cookie creation in auth package
status: todo
priority: low
labels:
  - backend
  - auth
  - refactoring
  - technical-debt
assignee: ""
workflow_state: DRAFT
epic: E02
depends_on:
  - E02-T003
  - E02-T004
blocks: []
breakpoint: false
assigned_agent: ""
created_at: 2026-01-15T00:00:00Z
updated_at: 2026-01-15T00:00:00Z
started_at: ""
completed_at: ""
spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E02-T009: Encapsulate session cookie creation in auth package

## Description

Move session cookie creation logic from API route handlers into the `@raptscallions/auth` package to improve encapsulation. Route handlers should not directly import or use the `lucia` instance - they should receive ready-to-use cookie parameters from the auth layer.

## Why This Matters

Reduces coupling between the API layer and Lucia implementation details. If Lucia is replaced or its cookie API changes in the future, the impact is isolated to the auth package rather than requiring changes across all route handlers. This addresses an architectural concern identified in the January 2026 codebase audit.

## Acceptance Criteria

- [ ] AC1: API route handlers do not directly import the `lucia` instance
- [ ] AC2: SessionService or AuthService provides `createSessionCookie(sessionId)` method
- [ ] AC3: Login, register, and logout routes receive cookie params from auth service
- [ ] AC4: Cookie attributes (httpOnly, secure, sameSite, path, domain) remain unchanged
- [ ] AC5: All existing auth flows continue to work without behavioral changes
- [ ] AC6: OAuth routes also use the encapsulated cookie creation method
- [ ] AC7: Unit tests verify cookie creation is properly delegated
- [ ] AC8: Integration tests confirm auth flows still work correctly

## Constraints

- Must maintain existing cookie security attributes
- Must not break existing session validation
- Must not change public API surface of auth routes
- Should not require database schema changes
- Performance must remain equivalent (no additional queries)

## Out of Scope

- Changing session storage mechanism
- Adding new cookie features or security improvements
- Modifying OAuth state cookie handling (separate concern)
- Changing session expiration logic
- Refactoring other Lucia-related code

## Context

See audit recommendation in `docs/audit/1_15_2026.md` section 4.1 "Encapsulation Leak in Auth Routes". This addresses the architectural concern where route handlers directly interact with the `lucia` instance for cookie generation.

**Current Implementation (coupling):**
```typescript
// apps/api/src/routes/auth.routes.ts
import { lucia } from "@raptscallions/auth";

const sessionCookie = lucia.createSessionCookie(sessionId);
reply.setCookie(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);
```

**Desired Implementation (encapsulated):**
```typescript
// apps/api/src/routes/auth.routes.ts
import { authService } from "../services/auth.service.js";

const sessionCookie = authService.createSessionCookie(sessionId);
reply.setCookie(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);
```

**Files Likely Affected:**

- `apps/api/src/routes/auth.routes.ts` - Remove lucia import, use service method
- `apps/api/src/routes/oauth.routes.ts` - Remove lucia import, use service method
- `apps/api/src/services/auth.service.ts` - Add createSessionCookie method
- `packages/auth/src/session.service.ts` - Add cookie creation method (alternative)
- `packages/auth/src/index.ts` - Export new cookie helper if needed

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2026-01-15 | DRAFT | pm    | Task created |
