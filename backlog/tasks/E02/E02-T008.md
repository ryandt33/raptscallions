---
id: "E02-T008"
title: "Auth integration tests"
status: "todo"
priority: "high"
labels:
  - backend
  - auth
  - testing
assignee: ""

workflow_state: "DRAFT"
epic: "E02"
depends_on: ["E02-T006"]
blocks: []
breakpoint: false
assigned_agent: ""

created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
started_at: ""
completed_at: ""

spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E02-T008: Auth integration tests

## Description

Write comprehensive integration tests for the authentication system covering registration, login, logout, session management, OAuth flows, and permission checking across all guard combinations.

## Acceptance Criteria

- [ ] AC1: Test suite for registration flow (success, duplicate email, validation)
- [ ] AC2: Test suite for login flow (success, wrong password, nonexistent user)
- [ ] AC3: Test suite for logout (session invalidation, cookie clearing)
- [ ] AC4: Test suite for session management (creation, validation, expiration)
- [ ] AC5: Test suite for OAuth flows (Google and Microsoft callbacks)
- [ ] AC6: Test suite for permission checks (all four roles, group scoping)
- [ ] AC7: Test suite for authentication guards (requireAuth, requireRole, requireGroupMembership)
- [ ] AC8: Tests use real database (test container) and Redis
- [ ] AC9: Tests clean up after themselves (delete test users, sessions)
- [ ] AC10: All tests pass with 80%+ coverage of auth code

## Technical Notes

Use Testcontainers for PostgreSQL and Redis:
```typescript
import { GenericContainer } from 'testcontainers';

let postgres: StartedTestContainer;
let redis: StartedTestContainer;

beforeAll(async () => {
  postgres = await new GenericContainer('postgres:16')
    .withEnvironment({ POSTGRES_PASSWORD: 'test' })
    .withExposedPorts(5432)
    .start();

  redis = await new GenericContainer('redis:7')
    .withExposedPorts(6379)
    .start();

  // Initialize DB with migrations
  // ...
}, 60000);

afterAll(async () => {
  await postgres.stop();
  await redis.stop();
});
```

Test helpers for creating users and sessions:
```typescript
async function createTestUser(overrides = {}) {
  const [user] = await db.insert(users).values({
    email: 'test@example.com',
    name: 'Test User',
    passwordHash: await hash('password123'),
    status: 'active',
    ...overrides,
  }).returning();

  return user;
}

async function createTestSession(userId: string) {
  const session = await lucia.createSession(userId, {});
  return session;
}

async function createTestGroupMember(userId: string, groupId: string, role: MemberRole) {
  const [member] = await db.insert(groupMembers).values({
    userId,
    groupId,
    role,
  }).returning();

  return member;
}
```

Example integration tests:
```typescript
describe('POST /auth/register', () => {
  it('should create user and session on successful registration', async () => {
    // Arrange
    const payload = {
      email: 'newuser@example.com',
      name: 'New User',
      password: 'securepassword123',
    };

    // Act
    const response = await app.inject({
      method: 'POST',
      url: '/auth/register',
      payload,
    });

    // Assert
    expect(response.statusCode).toBe(201);
    expect(response.json()).toMatchObject({
      user: {
        email: payload.email,
        name: payload.name,
      },
    });
    expect(response.cookies).toHaveProperty('auth_session');

    // Verify user in database
    const user = await db.query.users.findFirst({
      where: eq(users.email, payload.email),
    });
    expect(user).toBeDefined();
    expect(user.passwordHash).toBeDefined();
  });

  it('should return 409 for duplicate email', async () => {
    // Arrange
    await createTestUser({ email: 'existing@example.com' });

    // Act
    const response = await app.inject({
      method: 'POST',
      url: '/auth/register',
      payload: {
        email: 'existing@example.com',
        name: 'Duplicate',
        password: 'password123',
      },
    });

    // Assert
    expect(response.statusCode).toBe(409);
    expect(response.json()).toMatchObject({
      code: 'CONFLICT',
    });
  });
});

describe('Permission checks', () => {
  it('should allow group_admin to manage group', async () => {
    // Arrange
    const user = await createTestUser();
    const group = await createTestGroup();
    await createTestGroupMember(user.id, group.id, 'group_admin');
    const session = await createTestSession(user.id);

    // Act
    const response = await app.inject({
      method: 'PATCH',
      url: `/groups/${group.id}`,
      cookies: { auth_session: session.id },
      payload: { name: 'Updated Name' },
    });

    // Assert
    expect(response.statusCode).toBe(200);
  });

  it('should deny teacher from managing group', async () => {
    // Arrange
    const user = await createTestUser();
    const group = await createTestGroup();
    await createTestGroupMember(user.id, group.id, 'teacher');
    const session = await createTestSession(user.id);

    // Act
    const response = await app.inject({
      method: 'PATCH',
      url: `/groups/${group.id}`,
      cookies: { auth_session: session.id },
      payload: { name: 'Updated Name' },
    });

    // Assert
    expect(response.statusCode).toBe(403);
  });
});
```

Coverage requirements:
- Registration: 100% (critical path)
- Login: 100% (critical path)
- Session management: 100% (critical path)
- OAuth: 80% (external dependency mocking acceptable)
- Permissions: 100% (security-critical)
- Guards: 100% (security-critical)

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2026-01-12 | DRAFT | pm    | Task created |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
