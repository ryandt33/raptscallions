---
id: "E02-T006"
title: "Authentication guards and decorators"
status: "todo"
priority: "high"
labels:
  - backend
  - auth
assignee: ""

workflow_state: "DRAFT"
epic: "E02"
depends_on: ["E02-T003", "E02-T005"]
blocks: ["E02-T008"]
breakpoint: false
assigned_agent: ""

created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
started_at: ""
completed_at: ""

spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E02-T006: Authentication guards and decorators

## Description

Create reusable authentication guards and Fastify decorators for common auth patterns: requireAuth (must be logged in), requireRole (must have specific role), and requireGroupMembership (must belong to group).

## Acceptance Criteria

- [ ] AC1: requireAuth preHandler blocks unauthenticated requests with 401
- [ ] AC2: requireRole guard accepts role parameter and blocks non-matching users
- [ ] AC3: requireGroupMembership guard validates user is member of specified group
- [ ] AC4: Guards short-circuit and return error before route handler executes
- [ ] AC5: Fastify decorator adds `requireAuth` to app instance
- [ ] AC6: Fastify decorator adds `requireRole` to app instance
- [ ] AC7: Fastify decorator adds `requireGroupMembership` to app instance
- [ ] AC8: Error messages include helpful context (which permission failed)
- [ ] AC9: Guards compose correctly (can use multiple in preHandler array)
- [ ] AC10: Tests verify all guards with various user states

## Technical Notes

RequireAuth guard:
```typescript
export async function requireAuth(
  request: FastifyRequest,
  reply: FastifyReply
): Promise<void> {
  if (!request.user || !request.session) {
    throw new UnauthorizedError('Authentication required');
  }
}
```

RequireRole guard factory:
```typescript
export function requireRole(...roles: MemberRole[]) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new UnauthorizedError('Authentication required');
    }

    // Fetch user's roles
    const memberships = await db.query.groupMembers.findMany({
      where: eq(groupMembers.userId, request.user.id),
    });

    const userRoles = memberships.map(m => m.role);
    const hasRole = roles.some(role => userRoles.includes(role));

    if (!hasRole) {
      throw new ForbiddenError(
        `This action requires one of the following roles: ${roles.join(', ')}`
      );
    }
  };
}
```

RequireGroupMembership guard:
```typescript
export function requireGroupMembership(groupId: string) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new UnauthorizedError('Authentication required');
    }

    const membership = await db.query.groupMembers.findFirst({
      where: and(
        eq(groupMembers.userId, request.user.id),
        eq(groupMembers.groupId, groupId)
      ),
    });

    if (!membership) {
      throw new ForbiddenError('You are not a member of this group');
    }

    // Optionally attach membership to request for downstream use
    request.groupMembership = membership;
  };
}
```

Fastify plugin to register guards:
```typescript
import fp from 'fastify-plugin';

export default fp(async (app) => {
  app.decorate('requireAuth', requireAuth);
  app.decorate('requireRole', requireRole);
  app.decorate('requireGroupMembership', requireGroupMembership);
});

declare module 'fastify' {
  interface FastifyInstance {
    requireAuth: typeof requireAuth;
    requireRole: typeof requireRole;
    requireGroupMembership: typeof requireGroupMembership;
  }
}
```

Usage in routes:
```typescript
// Simple auth check
app.get('/me', {
  preHandler: [app.requireAuth],
}, async (request, reply) => {
  return { user: request.user };
});

// Role check
app.post('/admin/users', {
  preHandler: [app.requireAuth, app.requireRole('system_admin', 'group_admin')],
}, async (request, reply) => {
  // Only system_admin or group_admin can create users
});

// Group membership check (dynamic group from params)
app.get('/groups/:id/members', {
  preHandler: [app.requireAuth],
}, async (request, reply) => {
  await app.requireGroupMembership(request.params.id)(request, reply);
  // User is a member of this group
});
```

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2026-01-12 | DRAFT | pm    | Task created |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
