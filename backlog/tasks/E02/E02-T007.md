---
id: "E02-T007"
title: "Rate limiting middleware"
status: "todo"
priority: "medium"
labels:
  - backend
  - infrastructure
  - security
assignee: ""

workflow_state: "DRAFT"
epic: "E02"
depends_on: ["E02-T001"]
blocks: []
breakpoint: false
assigned_agent: ""

created_at: "2026-01-12T00:00:00Z"
updated_at: "2026-01-12T00:00:00Z"
started_at: ""
completed_at: ""

spec_file: ""
test_files: []
code_files: []
pr_url: ""
---

# E02-T007: Rate limiting middleware

## Description

Implement rate limiting middleware using Redis to prevent abuse of auth endpoints and API routes. Use @fastify/rate-limit with different limits for auth routes vs general API.

## Acceptance Criteria

- [ ] AC1: @fastify/rate-limit plugin installed and configured
- [ ] AC2: Redis used as storage backend for rate limit counters
- [ ] AC3: Auth routes limited to 5 requests per minute per IP
- [ ] AC4: General API routes limited to 100 requests per minute per user
- [ ] AC5: Rate limit exceeded returns 429 with Retry-After header
- [ ] AC6: Anonymous users rate limited by IP address
- [ ] AC7: Authenticated users rate limited by user ID
- [ ] AC8: Rate limit counters reset after time window expires
- [ ] AC9: Tests verify rate limits are enforced correctly
- [ ] AC10: Different rate limits can be applied to specific routes

## Technical Notes

Install rate limit plugin:
```bash
pnpm add @fastify/rate-limit ioredis
```

Configure rate limiting:
```typescript
import rateLimit from '@fastify/rate-limit';
import Redis from 'ioredis';

const redis = new Redis(env.REDIS_URL);

// Global rate limit (general API)
await app.register(rateLimit, {
  max: 100,
  timeWindow: '1 minute',
  redis,
  keyGenerator: (request) => {
    // Use user ID if authenticated, otherwise IP
    return request.user?.id || request.ip;
  },
});

// Stricter limit for auth routes
app.register(async (authRoutes) => {
  await authRoutes.register(rateLimit, {
    max: 5,
    timeWindow: '1 minute',
    redis,
    keyGenerator: (request) => request.ip,
  });

  authRoutes.post('/auth/login', loginHandler);
  authRoutes.post('/auth/register', registerHandler);
});
```

Custom rate limit for specific routes:
```typescript
app.post('/expensive-operation', {
  config: {
    rateLimit: {
      max: 10,
      timeWindow: '1 hour',
    },
  },
}, async (request, reply) => {
  // ...
});
```

Error response on rate limit:
```json
{
  "error": "Too many requests",
  "code": "RATE_LIMIT_EXCEEDED",
  "details": {
    "limit": 5,
    "remaining": 0,
    "resetAt": "2026-01-12T12:34:56Z"
  }
}
```

Headers on rate-limited responses:
```
HTTP/1.1 429 Too Many Requests
X-RateLimit-Limit: 5
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1705065296
Retry-After: 42
```

Testing rate limits:
```typescript
it('should rate limit auth login attempts', async () => {
  const requests = Array(6).fill(null).map(() =>
    app.inject({
      method: 'POST',
      url: '/auth/login',
      payload: { email: 'test@example.com', password: 'wrong' },
    })
  );

  const responses = await Promise.all(requests);

  // First 5 should succeed (401 for wrong password)
  responses.slice(0, 5).forEach(r => {
    expect(r.statusCode).toBe(401);
  });

  // 6th should be rate limited
  expect(responses[5].statusCode).toBe(429);
  expect(responses[5].headers['retry-after']).toBeDefined();
});
```

## History

| Date       | State | Agent | Notes        |
| ---------- | ----- | ----- | ------------ |
| 2026-01-12 | DRAFT | pm    | Task created |

## Reviews

### Plan Review

- **Reviewer:** architect
- **Date:**
- **Verdict:**
- **Notes:**

### Code Review

- **Reviewer:** reviewer
- **Date:**
- **Verdict:**
- **Notes:**

### QA Review

- **Reviewer:** qa
- **Date:**
- **Verdict:**
- **Notes:**
