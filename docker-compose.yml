services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: raptscallions-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: raptscallions
      POSTGRES_PASSWORD: raptscallions
      POSTGRES_DB: raptscallions
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U raptscallions -d raptscallions"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Redis Cache & Queue
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: raptscallions-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # ==========================================================================
  # Database Migrations (runs once then exits)
  # ==========================================================================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    container_name: raptscallions-migrate
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://raptscallions:raptscallions@postgres:5432/raptscallions
    working_dir: /app/packages/db
    command: ["pnpm", "exec", "drizzle-kit", "push", "--force"]
    restart: "no"

  # ==========================================================================
  # API Server
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: raptscallions-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      HOST: 0.0.0.0
      DATABASE_URL: postgresql://raptscallions:raptscallions@postgres:5432/raptscallions
      REDIS_URL: redis://redis:6379
      SESSION_SECRET: ${SESSION_SECRET:-development-secret-change-in-production-32chars}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      # OAuth (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      OAUTH_REDIRECT_BASE: ${OAUTH_REDIRECT_BASE:-http://localhost:3000}
      # AI (optional)
      AI_GATEWAY_URL: ${AI_GATEWAY_URL:-https://openrouter.ai/api/v1}
      AI_API_KEY: ${AI_API_KEY:-}
      AI_DEFAULT_MODEL: ${AI_DEFAULT_MODEL:-anthropic/claude-sonnet-4-20250514}
      # Telemetry (optional)
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
