services:
  # ==========================================================================
  # PostgreSQL Database
  # ==========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: raptscallions-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: raptscallions
      POSTGRES_PASSWORD: raptscallions
      POSTGRES_DB: raptscallions
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U raptscallions -d raptscallions"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Redis Cache & Queue
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: raptscallions-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # ==========================================================================
  # MinIO Object Storage (S3-compatible)
  # ==========================================================================
  minio:
    image: minio/minio:latest
    container_name: raptscallions-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # MinIO Bucket Initialization (runs once then exits)
  # ==========================================================================
  minio-init:
    image: minio/mc:latest
    container_name: raptscallions-minio-init
    depends_on:
      minio:
        condition: service_healthy
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
      MINIO_BUCKET: ${MINIO_BUCKET:-raptscallions-files}
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb --ignore-existing myminio/$${MINIO_BUCKET};
      echo 'Bucket $${MINIO_BUCKET} ready';
      "
    restart: "no"

  # ==========================================================================
  # Database Migrations (runs once then exits)
  # ==========================================================================
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    container_name: raptscallions-migrate
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://raptscallions:raptscallions@postgres:5432/raptscallions
      NODE_ENV: development
    working_dir: /app/packages/db
    # Use migrate instead of push for production-like workflow
    # Direct pnpm command - exits cleanly on success/failure without healthcheck
    command: ["pnpm", "db:migrate"]
    restart: "no"

  # ==========================================================================
  # API Server
  # ==========================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: raptscallions-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
      minio:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 3000
      HOST: 0.0.0.0
      DATABASE_URL: postgresql://raptscallions:raptscallions@postgres:5432/raptscallions
      REDIS_URL: redis://redis:6379
      SESSION_SECRET: ${SESSION_SECRET:-development-secret-change-in-production-32chars}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      # OAuth (optional)
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      MICROSOFT_CLIENT_ID: ${MICROSOFT_CLIENT_ID:-}
      MICROSOFT_CLIENT_SECRET: ${MICROSOFT_CLIENT_SECRET:-}
      OAUTH_REDIRECT_BASE: ${OAUTH_REDIRECT_BASE:-http://localhost:3000}
      # AI (optional)
      AI_GATEWAY_URL: ${AI_GATEWAY_URL:-https://openrouter.ai/api/v1}
      AI_API_KEY: ${AI_API_KEY:-}
      AI_DEFAULT_MODEL: ${AI_DEFAULT_MODEL:-anthropic/claude-sonnet-4-20250514}
      # Storage (MinIO)
      STORAGE_BACKEND: ${STORAGE_BACKEND:-s3}
      STORAGE_S3_ENDPOINT: http://minio:9000
      STORAGE_S3_REGION: ${STORAGE_S3_REGION:-us-east-1}
      STORAGE_S3_BUCKET: ${MINIO_BUCKET:-raptscallions-files}
      STORAGE_S3_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      STORAGE_S3_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin}
      STORAGE_S3_FORCE_PATH_STYLE: "true"
      # Telemetry (optional)
      OTEL_ENABLED: ${OTEL_ENABLED:-false}
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-}
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  minio_data:
    driver: local
