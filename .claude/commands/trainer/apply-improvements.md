---
description: Apply approved improvements to agent definition files (requires user confirmation)
allowed-tools:
  - Read
  - Write
  - Edit
---

# /apply-improvements - Implement Agent Improvements

Apply approved improvements to agent definition files. This command implements changes from improvement plans generated by `/refine-agent` or `/postmortem`. **Always requires explicit user confirmation** before modifying any files.

## Usage

```bash
/apply-improvements <plan-path> [--items 1,3,5]
```

### Arguments

- **`plan-path`** (required) - Path to the improvement plan file
- **`--items <numbers>`** (optional) - Comma-separated list of improvement numbers to apply (e.g., `1,3,5`)

### Examples

```bash
# Apply all improvements from a plan (will prompt for confirmation)
/apply-improvements backlog/docs/training/qa-improvements-20260115.md

# Apply only specific improvements (items 1, 2, and 5)
/apply-improvements backlog/docs/training/qa-improvements-20260115.md --items 1,2,5

# Apply improvements from a post-mortem report
/apply-improvements backlog/docs/training/developer-postmortem-20260115.md
```

## What This Command Does

1. Reads the improvement plan from the specified path
2. Parses the plan to extract improvements
3. Shows a summary of all improvements
4. Prompts for which improvements to apply (if `--items` not provided)
5. **For each approved improvement:**
   - Shows before/after diff
   - **Asks for explicit confirmation**: "Apply this change? [yes/no]"
   - If yes, applies the change using the Edit tool
6. Creates a changelog documenting all changes
7. Shows summary and suggests next steps

## When to Use `/apply-improvements`

âœ… **Use `/apply-improvements` when:**
- You have a completed improvement plan from `/refine-agent`
- You have a post-mortem with proposed fixes from `/postmortem`
- You've reviewed the proposed changes and want to implement them
- You want to apply improvements incrementally (using `--items`)

âŒ **Don't use `/apply-improvements` for:**
- Creating improvement plans (use `/refine-agent` instead)
- Analyzing agent outputs (use `/audit` or `/postmortem` instead)
- Making ad-hoc changes (edit `.claude/agents/{agent-type}.md` directly)

## Process

Load the trainer agent: @trainer

The trainer agent will:

1. **Parse arguments** to extract plan-path and optional items list
2. **Validate inputs:**
   - Check that plan-path exists
   - Verify it's a valid improvement plan or post-mortem
   - If --items provided, validate format (comma-separated numbers)
3. **Read the improvement plan** using the Read tool
4. **Parse improvements:**
   - Extract each numbered improvement
   - Find "Current" and "Proposed" sections
   - Identify which agent definition file to modify
5. **Determine which items to apply:**
   - If `--items` provided: Apply only those items
   - Otherwise: Show summary and ask user
6. **For each approved improvement:**
   - Extract the agent type (e.g., "qa", "reviewer")
   - Read current agent definition (`.claude/agents/{agent-type}.md`)
   - Locate the section to modify
   - **Show before/after diff**
   - **Ask for confirmation:** "Apply this change to `.claude/agents/{agent-type}.md`? [yes/no]"
   - If yes: Use Edit tool to apply the change
   - If no: Skip this improvement
7. **Create changelog** at `backlog/docs/training/{agent-type}-changelog-{timestamp}.md`
8. **Show summary:**
   - Number of changes applied
   - Path to changelog
   - Suggested next steps (test agent, monitor outputs)

## Safety Features

ğŸ”’ **This command implements strict safety measures:**

- âš ï¸ **ALWAYS shows diff before applying** - You see exactly what will change
- âš ï¸ **ALWAYS requires explicit confirmation** - Each change needs a "yes"
- âš ï¸ **NEVER auto-applies without approval** - No silent modifications
- âš ï¸ **Creates changelog for rollback** - Can undo if needed
- âš ï¸ **Applies changes incrementally** - One at a time, not in batch

## Output Format (Changelog)

After applying changes, a changelog is created:

```markdown
# {Agent Type} Agent Changelog

**Date:** {timestamp}
**Source Plan:** {plan path}
**Changes Applied:** {count}

## Changes

### 1. {Change title}
**Section:** {agent file section modified}
**Rationale:** {why this change was made}

**Before:**
```
{old content}
```

**After:**
```
{new content}
```

### 2. [...]

## Expected Impact
{summary of expected improvements}

## Next Steps
1. Test agent on sample inputs to verify improvements
2. Monitor future agent outputs for quality changes
3. Consider running `/audit` on next few outputs to validate effectiveness
```

## Example Workflow

### Step 1: Read Improvement Plan
```bash
/apply-improvements backlog/docs/training/qa-improvements-20260115.md
```

### Step 2: Review Summary
```
Improvement Plan: QA Agent Improvements (2026-01-15)

Found 5 improvements:
  1. Add edge case testing checklist (High priority)
  2. Make security checklist mandatory (High priority)
  3. Enforce standard report template (Medium priority)
  4. Add performance testing guidance (Low priority)
  5. Update examples with recent patterns (Low priority)

Apply all improvements? [yes/no/select]
> select

Which items? (comma-separated, e.g., 1,2,5)
> 1,2
```

### Step 3: Review & Confirm Each Change
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Improvement 1/2: Add edge case testing checklist
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Section: ## Your Process (Step 3)

BEFORE:
---
3. Test all acceptance criteria and document results
---

AFTER:
---
3. Test all acceptance criteria in three phases:
   - Happy path (expected inputs, expected results)
   - Edge cases (null, empty, boundary values, invalid inputs)
   - Security (auth, authz, input validation)
---

Apply this change to .claude/agents/qa.md? [yes/no]
> yes

âœ“ Applied successfully!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Improvement 2/2: Make security checklist mandatory
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[... shows diff ...]

Apply this change to .claude/agents/qa.md? [yes/no]
> yes

âœ“ Applied successfully!
```

### Step 4: Review Summary
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Summary
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Changes applied: 2/2
Changelog created: backlog/docs/training/qa-changelog-20260115-151045.md

Next steps:
1. Test QA agent on sample tasks (e.g., /qa E01-T009)
2. Monitor next 3-5 QA reports for improvement
3. Run /audit on future QA reports to validate effectiveness

Would you like to view the changelog? [yes/no]
```

## Error Handling

### Missing Required Argument
```
Error: Missing required argument.

Usage: /apply-improvements <plan-path> [--items 1,3,5]

Example: /apply-improvements backlog/docs/training/qa-improvements-20260115.md
```

### Plan File Not Found
```
Error: Improvement plan not found: backlog/docs/training/qa-improvements-20260115.md

Verify:
- Path is correct
- File exists in repository
- You have read permissions
```

### Invalid Plan Format
```
Error: Cannot parse improvement plan.

The improvement plan must include:
- "## Proposed Improvements" section
- Numbered improvements (1., 2., 3., ...)
- "Current" and "Proposed" subsections for each improvement

This doesn't look like a valid improvement plan from /refine-agent or /postmortem.
```

### Invalid Items Format
```
Error: Invalid --items format: "1-3"

Expected: Comma-separated numbers
Example: --items 1,2,5
```

### Items Out of Range
```
Error: Invalid item numbers: 6,7

This improvement plan has 5 improvements (items 1-5).
You requested items: 6,7
```

### Agent Definition Not Found
```
Error: Agent definition not found: .claude/agents/qaa.md

This improvement plan references agent type "qaa", but no definition file exists.

Valid agent types:
- qa
- reviewer
- analyst
- developer
- designer
```

## Incremental Application Tips

You can apply improvements incrementally using the `--items` flag:

### Example: Apply High-Priority Items First
```bash
# Apply only high-priority improvements (items 1 and 2)
/apply-improvements backlog/docs/training/qa-improvements-20260115.md --items 1,2

# Test the agent
/qa E01-T010

# If it works well, apply medium-priority improvements (item 3)
/apply-improvements backlog/docs/training/qa-improvements-20260115.md --items 3
```

### Example: Test Each Change Individually
```bash
# Apply first improvement
/apply-improvements backlog/docs/training/qa-improvements-20260115.md --items 1

# Test it
/qa E01-T010

# Apply second improvement
/apply-improvements backlog/docs/training/qa-improvements-20260115.md --items 2

# Test again
/qa E01-T011
```

## Rolling Back Changes

If an improvement causes issues, you can roll back:

1. **Read the changelog** to see what was changed
2. **Manually revert** using the Edit tool (copy "Before" content from changelog)
3. **Or use git** to revert the commit if the change was committed

Example rollback:
```bash
# View the changelog to see what changed
cat backlog/docs/training/qa-changelog-20260115-151045.md

# Use git to revert if changes were committed
git diff .claude/agents/qa.md
git checkout HEAD -- .claude/agents/qa.md
```

## Next Steps After Applying Improvements

1. **Test the agent** - Run it on sample tasks to verify improvements work
2. **Monitor outputs** - Watch the next 3-5 agent outputs for quality changes
3. **Validate effectiveness:**
   - Run `/audit` on future outputs to check for improvement
   - Compare against the "Expected Impact" in the improvement plan
4. **Iterate if needed:**
   - If issues persist, run `/postmortem` to investigate further
   - If new patterns emerge, run `/refine-agent` again

## Notes

- Changelogs are stored in `backlog/docs/training/` directory
- Each changelog is timestamped for version tracking
- Changelogs include full before/after diffs for rollback capability
- The trainer agent shows one diff at a time (not overwhelming)
- Each change requires explicit "yes" confirmation (no batch approval)
- Changes are applied atomically (one at a time)
- If a change fails, subsequent changes are skipped

---

**Related Commands:**
- `/audit` - Review a single agent output for quality
- `/postmortem` - Deep failure analysis (generates improvement proposals)
- `/refine-agent` - Pattern analysis (generates improvement plans)
